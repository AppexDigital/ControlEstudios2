<!DOCTYPE html>
<html lang="es">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramineta de Comisiones y Envíos</title>
    <link id="favicon" rel="icon" type="image/png" href="imagenes/Icono1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts for Editor -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">


    <style>
        :root {
            --bg-main: #f8f9fa; --bg-sidebar: #194846; --bg-content: #ffffff;
            --text-on-dark: #ede1cf; --text-dark: #212529; --text-light: #6c757d;
            --primary-color: #4b6c63; --primary-hover: #3a564e; --accent-color: #e9ecef;
            --border-color: #dee2e6; --danger-color: #dc3545; --danger-hover: #c82333;
            --success-color: #28a745; --info-color: #17a2b8; --teal-color: #194846;
            --font-sans: 'Inter', sans-serif; --font-mono: 'Roboto Mono', monospace;
        }
        body { font-family: var(--font-sans); background-color: var(--bg-main); color: var(--text-dark); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .font-mono { font-family: var(--font-mono); }
        .material-icons-outlined { font-size: 1.25rem; vertical-align: middle; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.25s ease-in-out; border: 1px solid transparent; cursor: pointer; user-select: none; }
        .btn:focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .btn-primary:disabled { background-color: #adb5bd; color: #f8f9fa; cursor: not-allowed; transform: none; box-shadow: none; border-color: #adb5bd; }
        .btn-secondary { background-color: #ffffff; color: var(--primary-color); border-color: var(--border-color); }
        .btn-secondary:hover { border-color: var(--primary-color); color: var(--primary-hover); background-color: #f8f9fa; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        
        .sidebar { background-color: var(--bg-sidebar); color: var(--text-on-dark); }
        .sidebar-link { display: flex; align-items: center; color: #b0c4bf; transition: all 0.2s ease-in-out; border-left: 4px solid transparent; padding: 0.85rem 1.5rem; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(237, 225, 207, 0.07); color: #ffffff; font-weight: 600; border-left-color: var(--text-on-dark); }
        
        .content-panel { background-color: var(--bg-content); border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.04); border-radius: 0.75rem; }
        .view-container { display: none; }
        .view-container.active { display: flex; flex-direction: column; }

        #login-screen { background-image: url('https://images.unsplash.com/photo-1517493498748-7e33a1e46e8c?q=80&w=2574&auto=format&fit=crop'); }
        
        .api-table thead th { position: sticky; top: 0; }
        
        .modal-container {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 50;
            display: flex; align-items: center; justify-content: center; padding: 1rem;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-container.visible { opacity: 1; pointer-events: auto; }
        
        .notification { transform: translateX(110%); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.show { transform: translateX(0); }
        
        .api-table th { background-color: #eef2ff; color: #312e81; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .api-table td { font-size: 0.8rem; padding: 0.5rem 0.75rem; vertical-align: top; white-space: nowrap; }
        .api-table tr:not(.combo-row):not(.special-row):not(.deposito-row):not(.resfee-row):not(.fonafifo-row):nth-child(even) { background-color: #f8f9fa; }
        .api-table .combo-row { background-color: #d1fae5; font-weight: bold; }
        .api-table .special-row { background-color: #e0f2fe; }
        .api-table .deposito-row { background-color: #feefc7; } /* Naranja claro */
        .api-table .resfee-row { background-color: #cffafe; } /* Celeste claro */
        .api-table .fonafifo-row { background-color: #fce7f3; } /* Rosado claro */
        .editable-cell input {
            width: 100%;
            text-align: right;
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 4px;
            padding: 2px 4px;
            font-family: var(--font-mono);
        }
         .readonly-cell {
            background-color: #f3f4f6;
            color: #6b7280;
        }


        .icon-btn { 
            background-color: transparent; border: none; padding: 0.4rem; border-radius: 9999px; 
            transition: background-color 0.2s, transform 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background-color: #e9ecef; transform: scale(1.1); }
        
        .detail-card { background-color: #f8f9fa; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); }
        .detail-card-title { font-size: 0.7rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; }
        .detail-card-value { font-size: 0.9rem; font-weight: 500; color: var(--text-dark); font-family: var(--font-mono); }
        
        .summary-card { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; text-align: center; }
        .summary-title { font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem; }
        .summary-value { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; line-height: 1; }
        .summary-sub { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-light); margin-top: 0.25rem; }

        .param-toggle-btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #4a5568;
            background-color: #2d3748; color: #cbd5e1; transition: all 0.2s;
            font-size: 0.875rem; 
        }
        .param-toggle-btn.active {
            background-color: var(--teal-color); color: white; border-color: var(--teal-color);
            box-shadow: 0 0 10px rgba(25, 72, 70, 0.5);
        }
        .param-input {
             background-color: #2d3748; border: 1px solid #4a5568; color: white;
             border-radius: 0.375rem; padding: 0.5rem 0.75rem;
             width: 100%; text-align: right; font-family: var(--font-mono);
             font-size: 0.875rem; 
        }
        .param-input:disabled {
            background-color: #1a202c;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .param-output {
            background-color: #1a202c; border: 1px solid #4a5568; color: white;
            border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            width: 100%; text-align: right; font-family: var(--font-mono); font-weight: bold;
            font-size: 0.875rem; 
        }
        
        .lang-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-on-dark);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .lang-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        #envios-params-panel {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            will-change: transform, width;
        }
        #envios-params-panel.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #shipment-preview-container {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
            transition: all 0.3s ease-in-out;
        }
        
        [contenteditable="true"]:focus {
            outline: 2px solid var(--primary-color);
            box-shadow: 0 0 8px rgba(75, 108, 99, 0.5);
        }

        /* --- Estilos para Redimensionamiento de Tablas --- */
        .resizable-th, .resizable-tr {
            position: relative;
        }
        .resize-handle-col, .resize-handle-row {
            position: absolute;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }
        .resize-handle-col {
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
        }
        .resize-handle-row {
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 6px;
            cursor: row-resize;
        }
        th:hover > .resize-handle-col,
        tr:hover > .resize-handle-row {
            opacity: 1;
        }
        .resizing-col, .resizing-row {
            background-color: rgba(75, 108, 99, 0.3);
        }
        /* --- Fin de Estilos para Redimensionamiento --- */

        #editor-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.25rem;
        }
        .toolbar-btn {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .toolbar-btn:hover, .toolbar-select:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .toolbar-select {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.4rem;
            color: var(--text-dark);
            font-size: 0.8rem;
            height: 36px;
        }
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 0.5rem;
        }

        @media (max-width: 1024px) {
            #params-modal-content {
                transform: scale(0.95);
                transform-origin: top;
            }
        }
        @media (max-width: 768px) {
            #params-modal-content {
                transform: scale(0.9);
            }
        }
        @media (max-width: 640px) {
            #params-modal-content {
                transform: scale(0.8);
            }
            #params-form {
                font-size: 12px;
            }
             .param-toggle-btn, .param-input, .param-output {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }
        }

    </style>
</head>
<body class="antialiased">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-cover bg-center">
         <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="relative z-10 w-full max-w-md p-8 space-y-8 bg-black bg-opacity-40 backdrop-blur-sm rounded-xl shadow-2xl border border-white/20">
            <div class="text-center text-white">
                <img src="imagenes/Icono.png" alt="Icono Terranova" class="mx-auto h-20 mb-4 invert brightness-0">
                <h1 class="text-4xl font-bold" data-lang-key="loginTitle">Herramienta de Comisiones y Envíos</h1>
                <p class="text-gray-300" data-lang-key="loginSubtitle">Seleccione su usuario para ingresar</p>
            </div>
            <form id="login-form">
                <select id="login-user-select" class="block w-full pl-3 pr-10 py-3 text-base bg-white/10 text-white border-white/30 focus:outline-none focus:ring-primary-color focus:border-primary-color sm:text-sm rounded-md">
                    <option style="color: black;" data-lang-key="loginLoading">Cargando...</option>
                </select>
                <button type="submit" class="w-full btn btn-primary mt-6" data-lang-key="loginButton">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- MAIN APPLICATION WRAPPER -->
    <div id="app-wrapper" class="hidden h-screen w-full">
        <div class="flex h-full">
            <!-- SIDEBAR -->
            <aside class="w-64 sidebar shadow-lg flex-shrink-0 flex flex-col z-20">
                 <div class="p-4 text-center border-b border-gray-700">
                    <h2 class="text-xl font-bold text-white" data-lang-key="sidebarTitle">Comisiones y Envíos</h2>
                    <div class="flex items-center justify-center mt-2 gap-2">
                        <span id="current-user-display" class="text-sm font-semibold text-gray-300"></span>
                        <button id="logout-btn" title="Cerrar Sesión" class="text-slate-400 hover:text-white" data-lang-key-title="sidebarLogout"><span class="material-icons-outlined text-base">logout</span></button>
                    </div>
                </div>
                <nav class="flex-grow flex flex-col">
                    <a href="#" class="sidebar-link active" data-view="main-view"><span class="material-icons-outlined mr-3">calculate</span><span data-lang-key="sidebarLinkCommissions">Comisiones</span></a>
                    <a href="#" class="sidebar-link" data-view="envios-view"><span class="material-icons-outlined mr-3">email</span><span data-lang-key="sidebarLinkShipments">Envíos</span></a>
                    <a href="#" class="sidebar-link" data-view="saved-quotes-view"><span class="material-icons-outlined mr-3">inventory_2</span><span data-lang-key="sidebarLinkSaved">Guardadas</span></a>
                </nav>

                <div class="p-4 space-y-4 border-t border-gray-700">
                    <div id="ui-lang-switcher" class="flex justify-center gap-2">
                        <button class="lang-btn active" data-lang="es">ES</button>
                        <button class="lang-btn" data-lang="en">EN</button>
                    </div>
                    <p class="text-center text-xs text-gray-500">© TerranovaOrigen 2025</p>
                </div>
            </aside>

            <!-- VIEWPORT -->
            <main class="flex-1 relative overflow-y-auto">
                <!-- VISTA: COMISIONES -->
                <div id="main-view" class="view-container active p-4 md:p-6 lg:p-8">
                    <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h1 class="text-3xl font-bold text-text-dark" data-lang-key="mainTitle">Cálculo de Comisiones</h1>
                        <div class="flex items-center gap-4">
                            <button id="save-quote-btn" class="btn btn-primary" disabled><span class="material-icons-outlined">save</span><span data-lang-key="buttonSave">Guardar</span></button>
                            <button id="open-params-modal" class="btn btn-secondary"><span class="material-icons-outlined">tune</span><span data-lang-key="buttonParameters">Parámetros</span></button>
                        </div>
                    </header>
                    
                    <div class="content-panel p-4 flex items-center gap-4 mb-4">
                        <label for="quote-id-input" class="font-semibold text-text-light" data-lang-key="labelQuoteId">ID Cotización Toursys:</label>
                        <input type="text" id="quote-id-input" class="block w-48 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-color focus:border-primary-color sm:text-sm rounded-md" placeholder="Ej: 24500" data-lang-key-placeholder="placeholderQuoteId">
                        <button id="fetch-quote-btn" class="btn btn-primary"><span class="material-icons-outlined">search</span><span data-lang-key="buttonSearch">Buscar</span></button>
                        <button id="view-json-btn" class="btn btn-secondary" disabled><span class="material-icons-outlined">code</span><span data-lang-key="buttonViewJson">Ver JSON</span></button>
                    </div>
                    
                    <div id="quote-details-wrapper" class="hidden my-4 space-y-4">
                        <div class="flex items-center gap-4">
                            <div id="quote-financial-summary" class="grid grid-cols-1 md:grid-cols-3 gap-3 flex-grow"></div>
                             <button id="toggle-adjustments-btn" title="Ver Desglose de Ajustes" class="icon-btn text-gray-500 ml-2 self-start mt-2" data-lang-key-title="adjustmentsTooltip">
                                <span class="material-icons-outlined">info_outline</span>
                            </button>
                        </div>
                        <div id="quote-header-main" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                        <div id="quote-header-comments" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    </div>

                    <div id="api-table-wrapper" class="mt-4 content-panel overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-color text-xs api-table" id="api-quote-table">
                            <thead></thead>
                            <tbody>
                                <tr><td colspan="55" class="text-center p-16 text-text-light" data-lang-key="tablePlaceholder">Ingrese un ID de cotización para buscar en Toursys.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA: ENVIOS (RECONSTRUIDA) -->
                <div id="envios-view" class="view-container p-0 h-full overflow-hidden">
                     <div class="relative h-full flex flex-col">
                        <div id="envios-content-wrapper" class="h-full flex flex-col">
                            <p class="text-center text-text-light content-panel p-6 m-8" data-lang-key="shipmentsPlaceholder">Seleccione una cotización desde la pestaña "Guardadas" para preparar un envío.</p>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: GUARDADAS -->
                <div id="saved-quotes-view" class="view-container p-4 md:p-6 lg:p-8 h-full">
                    <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h1 class="text-3xl font-bold text-text-dark" data-lang-key="savedTitle">Cotizaciones Guardadas</h1>
                         <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label for="user-filter-select" class="text-sm font-medium" data-lang-key="savedFilterByUser">Filtrar por Usuario:</label>
                                <select id="user-filter-select" class="block w-48 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-color focus:border-primary-color sm:text-sm rounded-md"></select>
                            </div>
                            <input type="text" id="search-saved-quotes" class="block w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-color focus:border-primary-color sm:text-sm rounded-md" placeholder="Buscar por ID o nombre..." data-lang-key-placeholder="savedSearchPlaceholder">
                        </div>
                    </header>
                    <div class="flex-1 overflow-auto content-panel">
                        <table class="min-w-full divide-y divide-border-color">
                            <thead>
                                <tr>
                                    <th class="text-left p-3" data-lang-key="savedHeaderId">ID</th>
                                    <th class="text-left p-3" data-lang-key="savedHeaderFilename">Nombre Archivo</th>
                                    <th class="text-left p-3" data-lang-key="savedHeaderClient">Cliente</th>
                                    <th class="text-left p-3" data-lang-key="savedHeaderCreator">Usuario Creador</th>
                                    <th class="text-left p-3" data-lang-key="savedHeaderDate">Fecha Guardado</th>
                                    <th class="text-right p-3" data-lang-key="savedHeaderTotal">Total Venta</th>
                                    <th class="text-center p-3" data-lang-key="savedHeaderActions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="saved-quotes-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- MODALS & OVERLAYS -->
    <div id="json-view-modal" class="modal-container">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl transform transition-all flex flex-col h-[90vh] max-h-[900px]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0" style="background-color: var(--bg-sidebar);">
                <h3 class="text-lg font-bold" style="color: var(--text-on-dark);" data-lang-key="modalJsonTitle">Respuesta JSON de la API</h3>
                <div class="flex items-center gap-2">
                    <button id="copy-json-btn" class="btn btn-secondary text-xs py-1 px-3"><span class="material-icons-outlined text-sm">content_copy</span><span data-lang-key="buttonCopyCode">Copiar Código</span></button>
                    <button id="close-json-modal" class="icon-btn" style="color: var(--text-on-dark);"><span class="material-icons-outlined">close</span></button>
                </div>
            </div>
            <div class="overflow-hidden flex-grow">
                <pre class="h-full w-full overflow-auto bg-gray-900 text-gray-300 text-xs p-4 rounded-b-md"><code id="json-code-content"></code></pre>
            </div>
        </div>
    </div>
    <div id="params-modal" class="modal-container">
       <div id="params-modal-content" class="w-full max-w-4xl bg-gray-800 text-white rounded-lg shadow-xl flex flex-col">
            <div class="p-4 flex justify-between items-center" style="background-color: var(--bg-sidebar);">
                <h2 class="text-xl font-bold" style="color: var(--text-on-dark);" data-lang-key="modalParamsTitle">Parámetros de Cálculo</h2>
                <button id="cancel-params-btn" class="text-white hover:bg-white/20 rounded-full p-2"><span class="material-icons-outlined">close</span></button>
            </div>
            <form id="params-form" class="p-4 md:p-6 space-y-6" style="background-color: #0d1117;">
                <div class="grid grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Columna Izquierda: Controles -->
                    <div class="space-y-6">
                        <div>
                            <label for="param-escenario" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="paramScenario">Escenarios de Cálculo</label>
                            <select id="param-escenario" class="block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2">
                                <option data-lang-key="paramScenarioAll">Sobre el todo</option>
                                <option data-lang-key="paramScenarioLine">Linea por Linea</option>
                            </select>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                            <label class="block text-sm font-medium text-gray-400 text-center" data-lang-key="paramAgentProfit">Utilidad del Agente</label>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <input type="number" id="param-utilidad-agente-porc" class="param-input" placeholder="%" step="0.1">
                                <input type="number" id="param-utilidad-agente-monto" class="param-input" placeholder="$" step="0.01">
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <div class="text-center">
                                    <p class="text-xs text-gray-500" data-lang-key="paramNoTax">Sin IVA</p>
                                    <div class="param-output" id="output-utilidad-agente-sin-iva">$0.00</div>
                                </div>
                                 <div class="text-center">
                                    <p class="text-xs text-gray-500" data-lang-key="paramWithTax">Con IVA</p>
                                    <div class="param-output" id="output-utilidad-agente-con-iva">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                            <label class="block text-sm font-medium text-gray-400 text-center" data-lang-key="paramTerranovaProfit">Utilidad TerranovaOrigen</label>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="text-center">
                                    <p class="text-xs text-gray-500" data-lang-key="paramNoTax">Sin IVA</p>
                                    <div class="param-output" id="output-utilidad-terranova-sin-iva">$0.00</div>
                                </div>
                                 <div class="text-center">
                                    <p class="text-xs text-gray-500" data-lang-key="paramWithTax">Con IVA</p>
                                    <div class="param-output" id="output-utilidad-terranova-con-iva">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha: Comisiones y Totales -->
                    <div class="space-y-2">
                        <div class="grid grid-cols-12 gap-x-2 items-center mb-2 pb-2 border-b border-gray-700">
                            <span class="font-semibold text-sm col-span-6 text-gray-400" data-lang-key="paramCommission">Comisión</span>
                            <span class="font-semibold text-sm text-right text-gray-400 col-span-3" data-lang-key="paramNoTaxShort">Sin IVA ($)</span>
                            <span class="font-semibold text-sm text-right text-gray-400 col-span-3" data-lang-key="paramWithTaxShort">Con IVA ($)</span>
                        </div>
                        
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="nuba" data-value="3">NUBA (3%)</button>
                            <div class="col-span-3 param-output" id="output-nuba-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-nuba-con-iva">$0.00</div>
                        </div>
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="virtuoso" data-value="2">Virtuoso (2%)</button>
                            <div class="col-span-3 param-output" id="output-virtuoso-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-virtuoso-con-iva">$0.00</div>
                        </div>
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="smartflyer" data-value="2">SmartFlyer (2%)</button>
                            <div class="col-span-3 param-output" id="output-smartflyer-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-smartflyer-con-iva">$0.00</div>
                        </div>
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="fora" data-value="1">Fora Travel (1%)</button>
                            <div class="col-span-3 param-output" id="output-fora-travel-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-fora-travel-con-iva">$0.00</div>
                        </div>
                         <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="tarjeta" data-value="2.5">Tarjeta (2.5%)</button>
                            <div class="col-span-3 param-output" id="output-tarjeta-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-tarjeta-con-iva">$0.00</div>
                        </div>
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="transferencia">Transferencia</button>
                            <input type="number" id="param-transferencia-monto" class="col-span-3 param-input" placeholder="$" step="0.01" value="60">
                            <div class="col-span-3 param-output" id="output-transferencia-con-iva">$0.00</div>
                        </div>
                        <div class="grid grid-cols-12 gap-x-2 items-center">
                            <button type="button" class="col-span-6 param-toggle-btn justify-start" data-param="fundacion" data-value="1">Fundación (1%)</button>
                            <div class="col-span-3 param-output" id="output-fundacion-sin-iva">$0.00</div>
                            <div class="col-span-3 param-output" id="output-fundacion-con-iva">$0.00</div>
                        </div>
                    </div>
                </div>
            </form>
       </div>
    </div>
    <div id="adjustments-modal" class="modal-container">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-2xl transform transition-all flex flex-col max-h-[90vh]">
            <div class="p-4 flex justify-between items-center flex-shrink-0" style="background-color: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 class="text-lg font-bold" style="color: #ede1cf;" data-lang-key="adjustmentsTitle">Desglose de Ajustes de Totales</h3>
                <button id="close-adjustments-modal" class="icon-btn" style="color: #ede1cf;"><span class="material-icons-outlined">close</span></button>
            </div>
            <div id="adjustments-modal-body" class="p-6 overflow-y-auto">
                <!-- El contenido se inyectará aquí -->
            </div>
        </div>
    </div>
    
    <!-- INICIO: Nuevo Modal para Detalles de Línea -->
    <div id="line-details-modal" class="modal-container">
        <div class="bg-gray-800 text-white rounded-lg shadow-xl w-full max-w-4xl transform transition-all flex flex-col h-[90vh] max-h-[900px]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0" style="background-color: var(--bg-sidebar);">
                <h3 id="line-details-modal-title" class="text-lg font-bold" style="color: var(--text-on-dark);">Detalles del Servicio</h3>
                <button id="close-line-details-modal" class="icon-btn" style="color: var(--text-on-dark);"><span class="material-icons-outlined">close</span></button>
            </div>
            <div id="line-details-modal-content" class="overflow-auto bg-gray-900 text-gray-300 text-xs p-4 rounded-b-md flex-grow">
                <!-- El contenido (JSON o tabla) se inyectará aquí -->
            </div>
        </div>
    </div>
    <!-- FIN: Nuevo Modal para Detalles de Línea -->

    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[200]"></div>
    <div id="notification-container" class="fixed bottom-5 right-5 z-[100] w-full max-w-sm space-y-3"></div>
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 p-4 modal-backdrop flex items-center justify-center"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- I. ESTADO Y CONFIGURACIÓN ---
        
        const ecosystems = {
            "Ocean Playground": {
                es: "En la costa norte del Pacífico, donde el bosque seco tropical se encuentra con el mar, el Ocean Playground está a solo una hora del aeropuerto de Guanacaste. Este es uno de los destinos oceánicos más accesibles de Costa Rica, donde las aguas iridiscentes ofrecen todo tipo de aventuras sobre y bajo las olas.",
                en: "The north Pacific coast, where tropical dry forest meets the sea, the Ocean Playground is just an hour from Guanacaste airport. This is one of Costa Rica's most accessible ocean destinations, where iridescent waters offer all manner of adventures above and below the waves."
            },
            "Land of Fire": {
                es: "Escondida entre la cordillera volcánica de Guanacaste, la Tierra de Fuego está llena de ecosistemas únicos y vida rural. Ven aquí a explorar bosques vírgenes, caminar por cascadas y ríos caudalosos, y relajarte en aguas termales burbujeantes después de las aventuras.",
                en: "Hidden among the volcanic mountain range of Guanacaste, the Land of Fire is full of unique ecosystems and rural life. Come here to explore pristine forest, to hike tumbling waterfalls and along rushing rivers, and to relax in bubbling hot springs when the adventures are done."
            },
            "Green Haven": {
                es: "Al pie del Volcán Arenal, la aventura espera entre los bosques llenos de vida del norte de Costa Rica. Siempre popular, y con razón, aquí hay caminatas, canopy, rafting, tirolesa y mucho más; observar la fauna y experimentar la naturaleza viene acompañado de emoción.",
                en: "At the foot of the Volcan Arenal, adventure awaits among the life-filled forests of Costa Rica's north. Ever popular, and for good reason, here there is hiking, ziplining, canopy tours, rafting and so much more; spotting wildlife and experiencing nature here comes with a side of thrills!"
            },
            "Mystic Mountains": {
                es: "Un espeso manto verde cubre la Cordillera de Tilarán: los bosques nubosos de Monteverde ofrecen una naturaleza abundante y biodiversa. Ven aquí a explorar el bosque y a buscar algunas de las criaturas más esquivas de Costa Rica: perezosos y quetzales, por nombrar algunas.",
                en: "A thick, green blanket over the Cordillera de Tilaran, the cloud forests of Monteverde offers abundant and biodiverse nature. Come here to explore and encounter the forest and search for some of Costa Rica's most elusive creatures - sloths and quetzals, to name just a few."
            },
            "Enchanting Coast": {
                es: "Playas doradas, naturaleza idílica, arrecifes de coral y olas para surfear: el encantador Parque Nacional Manuel Antonio lo tiene todo. En el norte de la costa del Pacífico central, aquí puedes explorar la abundante naturaleza, relajarte en playas de arena cálida y disfrutar de mares llenos de vida, ya sea con calma o en busca de aventura.",
                en: "Golden beaches, blissful nature, coral reefs and surfable swell, the enchanting Manuel Antonio National Park has it all. In the north of the central Pacific coast, here you can explore abundant wilderness, warm sand beach and life-filled waters at a relaxed pace or with adventure in mind."
            },
            "Surf Vibes": {
                es: "Relajado, chic y tranquilo, en la espectacular Península de Nicoya, Santa Teresa es la combinación perfecta de olas, sol y pura vida. Ya sea que quieras surfear, practicar yoga, sentarte en la arena tibia o disfrutar del ambiente frente al mar, este es el lugar para hacerlo con estilo.",
                en: "Relaxed, chic, mellow and sat on the spectacular Nicoya Peninsula, Santa Teresa is the perfect combination of waves, sunshine and pura vida. Whether you want to surf, practice yoga, sit on the sun-warmed sand or enjoy the beachfront social scene, this is the place to do it in style."
            },
            "Barefoot Tranquillity": {
                es: "Un destino de sol y surf en un tramo de costa virgen de la Península de Nicoya, Nosara es un faro para yoguis, familias, surfistas y amantes de la naturaleza. Una de las cinco 'Zonas Azules' del mundo, donde los locales viven vidas excepcionalmente largas, este es el lugar para absorber la pura vida costarricense.",
                en: "A sun and surf destination on a stretch of unspoiled coastline on the Nicoya Peninsula, Nosara is a beacon for yogis, families, surfers and nature lovers. One of the world's five 'Blue Zones', where locals live exceptionally long lives, this is the place to soak up Costa Rica's renowned pura vida."
            },
            "Natures Coast": {
                es: "En la costa norte del Caribe costarricense, la naturaleza reina y la aventura se esconde entre los árboles. En Tortuguero, explora bosques tropicales en busca de perezosos y cocodrilos, descubre la cultura afrocaribeña y presencia tortugas desovando en playas tranquilas.",
                en: "On Costa Rica's northern Caribbean coast, nature reigns supreme and adventure hides among the trees. In Tortuguero, explore tropical forest in search of sloths and crocodiles, discover Afro-Caribbean culture and witness turtles laying their eggs on peaceful beaches."
            },
            "Mellow Coast": {
                es: "Alrededor de Puerto Viejo, en la costa sur del Caribe, encontrarás cultura alternativa, naturaleza remota y deliciosa cocina criolla. Ya sea relajándote en arenas doradas, explorando selva y manglares, o disfrutando del mejor surf de la costa este, este es un lado diferente de Costa Rica.",
                en: "Around Puerto Viejo, on the southern Caribbean coast, you'll find under-the-radar culture, remote nature and delicious Creole cooking. Whether relaxing on golden sands, exploring jungle and mangroves, or enjoying the east coast's best surfing, this is a different side to Costa Rica."
            },
            "Wildlife Hotspot": {
                es: "La Península de Osa, en la costa sur del Pacífico de Costa Rica, es uno de los lugares más biodiversos del planeta. Donde el bosque y el océano se encuentran, explora la selva tropical y las aguas tranquilas del Golfo Dulce para descubrir una asombrosa variedad de vida silvestre y naturaleza en su máxima expresión.",
                en: "The Osa Peninsula, on Costa Rica's southern Pacific coast, is one of the most biodiverse places on the planet. Where the forest and ocean collide, explore wild rainforest and the calm waters of the Golfo Dulce to discover an astounding array of wildlife and nature at its most awe-inspiring."
            },
            "The Countryside": {
                es: "En el exuberante Valle Central, bajo la mirada del volcán Turrialba, se encuentra un pintoresco mosaico de plantaciones, campos y granjas. Ven aquí a probar un café exquisito, tener encuentros culturales con comunidades indígenas y vivir aventuras en ríos de aguas bravas y bosques profundos.",
                en: "In the lush Central Valley, watched over by Turrialba Volcano, is a picturesque patchwork of plantations, fields and farmland. Come here to taste exquisite coffee, for cultural encounters with indigenous communities and for all out adventure on white water rivers and in deep forests."
            },
            "The Capital": {
                es: "La capital de Costa Rica, en el corazón de la nación, San José y sus alrededores están llenos de maravillas. Desde bulevares arbolados y deliciosa gastronomía, hasta volcanes activos y cascadas imponentes, ya sea que quieras una experiencia urbana o rural, aquí hay algo para todos.",
                en: "Costa Rica's capital, sat at the heart of the nation, San Jose and its surroundings are full of wonders. From leafy boulevards and delicious eats, to active volcanoes and towering waterfalls, whether you want your experience to be urban or rural, there is something for everyone."
            }
        };

        function getDefaultParameters() {
            return {
                comisionAgente: { tipo: "Sobre el todo", porcentaje: 0, montoAbsoluto: 0 },
                nuba: { activado: false, porcentaje: 0.03 },
                virtuoso: { activado: false, porcentaje: 0.02 }, // AJUSTE: Cambiado de 0.03 a 0.02
                smartflyer: { activado: false, porcentaje: 0.02 },
                fora: { activado: false, porcentaje: 0.01 },
                fundacion: { activado: false, porcentaje: 0.01 },
                tarjeta: { activado: false, porcentaje: 0.025 },
                transferencia: { activado: false, montoFijo: 60 },
                impuestoGeneralIVA: 0.13
            };
        }

        const appState = {
            currentUser: null, users: [], savedQuotes: [], services: [],
            currentQuote: { 
                id: null, fileName: '', details: {}, 
                rawData: null, // Para la data original de la API
                apiData: null, // Para la data procesada/filtrada para la UI
                processedData: [], 
                adjustmentDetails: null, finalCalculatedTotal: 0
            },
            quoteForShipment: null,
            parameters: getDefaultParameters(),
            isDirty: false, isOffline: false,
            uiLanguage: 'es',
        };
        
        // --- II. REFERENCIAS AL DOM ---
        const DOM = {
            loginScreen: document.getElementById('login-screen'), loginForm: document.getElementById('login-form'),
            loginUserSelect: document.getElementById('login-user-select'), appWrapper: document.getElementById('app-wrapper'),
            currentUserDisplay: document.getElementById('current-user-display'), logoutBtn: document.getElementById('logout-btn'),
            sidebarLinks: document.querySelectorAll('.sidebar-link'), viewContainers: document.querySelectorAll('.view-container'),
            fetchQuoteBtn: document.getElementById('fetch-quote-btn'), quoteIdInput: document.getElementById('quote-id-input'),
            apiQuoteTableHead: document.querySelector('#api-quote-table thead'),
            apiQuoteTableBody: document.querySelector('#api-quote-table tbody'),
            quoteDetailsWrapper: document.getElementById('quote-details-wrapper'),
            saveQuoteBtn: document.getElementById('save-quote-btn'), viewJsonBtn: document.getElementById('view-json-btn'),
            openParamsModalBtn: document.getElementById('open-params-modal'),
            paramsModal: document.getElementById('params-modal'),
            paramsForm: document.getElementById('params-form'),
            cancelParamsBtn: document.getElementById('cancel-params-btn'),
            savedQuotesView: document.getElementById('saved-quotes-view'),
            loaderOverlay: document.getElementById('loader-overlay'), notificationContainer: document.getElementById('notification-container'),
            enviosView: document.getElementById('envios-view'),
            enviosContentWrapper: document.getElementById('envios-content-wrapper'),
            toggleAdjustmentsBtn: document.getElementById('toggle-adjustments-btn'),
            uiLangSwitcher: document.getElementById('ui-lang-switcher'),
        };

        // --- III. FUNCIONES DE UTILIDAD Y UI ---
        const parseCurrency = (str) => parseFloat(String(str || '0').replace(/[^0-9.-]+/g,""));
        const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        const toTitleCase = (str) => str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());

        function showLoader(show) { DOM.loaderOverlay.classList.toggle('hidden', !show); }
        function showNotification(message, type = 'info') {
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            const icon = { info: 'info', success: 'check_circle', error: 'error' };
            const notification = document.createElement('div');
            notification.className = `notification flex items-center gap-4 p-4 rounded-lg shadow-lg text-white ${colors[type]}`;
            notification.innerHTML = `<span class="material-icons-outlined">${icon[type]}</span><p class="flex-1">${message}</p><button class="text-white">&times;</button>`;
            DOM.notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            const close = () => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            };
            notification.querySelector('button').addEventListener('click', close);
            setTimeout(close, 5000);
        }
        function switchView(viewId) {
            DOM.sidebarLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            DOM.viewContainers.forEach(container => container.classList.toggle('active', container.id === viewId));
            if(viewId === 'saved-quotes-view') setupSavedQuotesView();
            if(viewId === 'envios-view') renderEnviosView();
        }

        // --- IV. API & DATA HANDLING ---
        async function apiCall(endpoint, options = {}) {
            showLoader(true);
            try {
                const response = await fetch(`/.netlify/functions/${endpoint}`, { headers: { 'Content-Type': 'application/json' }, ...options });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(errorData.error);
                }
                const text = await response.text();
                return text ? JSON.parse(text) : {};
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                throw error;
            } finally {
                showLoader(false);
            }
        }

        async function refreshAllData() {
            try {
                const data = await apiCall('get-data');
                appState.users = data.users || [];
                appState.services = data.services || [];
                appState.savedQuotes = data.savedQuotes || [];
                appState.isOffline = false;
                return true;
            } catch (error) {
                showNotification(`Fallo de conexión. Modo Offline activado.`, 'error');
                appState.isOffline = true;
                return false;
            }
        }

        function populateUserSelect() {
            DOM.loginUserSelect.innerHTML = `<option style="color: black;" value="" data-lang-key="loginSelectUser">Seleccionar Usuario</option>`;
            const adminUser = { idUsuario: 'Admin', nombreCompleto: 'Admin (Offline)' };
            const adminOption = new Option(adminUser.nombreCompleto, adminUser.idUsuario);
            adminOption.style.color = 'black';
            DOM.loginUserSelect.add(adminOption);
            
            if (!appState.isOffline && appState.users.length > 0) {
                appState.users.forEach(user => {
                    const option = new Option(user.nombreCompleto, user.idUsuario);
                    option.style.color = 'black';
                    DOM.loginUserSelect.add(option);
                });
            }
        }
        
        function getOfflineMockData() {
            return {
                users: [{ idUsuario: 'Admin', nombreCompleto: 'Admin (Offline)' }],
                services: [], savedQuotes: []
            };
        }

        // --- V. LÓGICA DE TOURYS API ---
        async function handleFetchToursysQuote() {
            const quoteId = DOM.quoteIdInput.value.trim();
            if (!quoteId) {
                showNotification("Por favor, ingrese un ID de cotización.", 'error');
                return;
            }
            try {
                const combinedData = await apiCall(`get-toursys-quote?quotationId=${quoteId}`);

                if (!combinedData || !combinedData.mainInfo) {
                    throw new Error("La respuesta de la API no tiene el formato esperado o está vacía.");
                }
                
                // AJUSTE ARQUITECTÓNICO: Se recalculan los totales para ignorar la variación.
                // Esto se convierte en la nueva fuente de verdad para todos los cálculos posteriores.
                combinedData.mainInfo.quotation_net_total = (parseCurrency(combinedData.mainInfo.quotation_net_sub_total) + parseCurrency(combinedData.mainInfo.quotation_net_tax)).toString();
                combinedData.mainInfo.quotation_customer_rack_total = (parseCurrency(combinedData.mainInfo.quotation_customer_rack_sub_total) + parseCurrency(combinedData.mainInfo.quotation_customer_rack_tax)).toString();
                (combinedData.lines || []).forEach(line => {
                    line.quotation_line_net_total = (parseCurrency(line.quotation_line_net_sub_total) + parseCurrency(line.quotation_line_net_tax)).toString();
                    line.quotation_line_rack_total = (parseCurrency(line.quotation_line_rack_sub_total) + parseCurrency(line.quotation_line_rack_tax)).toString();
                });

                resetMainView(true);
                appState.parameters = getDefaultParameters();
                
                // **REFACTORIZACIÓN ARQUITECTÓNICA: PATRÓN NO DESTRUCTIVO**
                // 1. Guardar la data cruda como la fuente de verdad inmutable.
                appState.currentQuote.rawData = combinedData;

                const commissionCodesToIgnore = ['COPOPA', 'COMTBA', 'COMTCR', 'COMTCRTO', 'FOUNDA', 'UTTERA', 'UTTERAO'];
                
                const allLines = combinedData.lines || [];

                // 2. Se mantiene la lógica de filtrado, pero ahora opera sobre una copia y su resultado es para el cálculo, no para sobrescribir.
                // CORRECCIÓN ARQUITECTÓNICA v4.2: Se corrige la comparación estricta de string "False" a una comparación booleana.
                const nonComboComponentLines = allLines.filter(line => line.quotation_line_belongs_to_combo == false);
                const commissionLines = nonComboComponentLines.filter(line => commissionCodesToIgnore.includes(line.quotation_line_service_code));
                const mainServiceLines = nonComboComponentLines.filter(line => !commissionCodesToIgnore.includes(line.quotation_line_service_code));

                const commissionTotals = commissionLines.reduce((acc, line) => {
                    acc.rackTotal += parseCurrency(line.quotation_line_rack_total);
                    acc.netTotal += parseCurrency(line.quotation_line_net_total);
                    return acc;
                }, { rackTotal: 0, netTotal: 0 });

                const adjustedMainInfo = { ...combinedData.mainInfo };
                const originalNetTotal = parseCurrency(adjustedMainInfo.quotation_net_total);
                const originalRackTotal = parseCurrency(adjustedMainInfo.quotation_customer_rack_total);

                adjustedMainInfo.quotation_customer_rack_total = (originalRackTotal - commissionTotals.rackTotal).toString();
                adjustedMainInfo.quotation_net_total = (originalNetTotal - commissionTotals.netTotal).toString();
                
                if (originalRackTotal > 0) {
                    adjustedMainInfo.quotation_customer_rack_sub_total = (parseCurrency(adjustedMainInfo.quotation_customer_rack_sub_total) / originalRackTotal * (originalRackTotal - commissionTotals.rackTotal)).toString();
                    adjustedMainInfo.quotation_customer_rack_tax = (parseCurrency(adjustedMainInfo.quotation_customer_rack_tax) / originalRackTotal * (originalRackTotal - commissionTotals.rackTotal)).toString();
                }
                if (originalNetTotal > 0) {
                    adjustedMainInfo.quotation_net_sub_total = (parseCurrency(adjustedMainInfo.quotation_net_sub_total) / originalNetTotal * (originalNetTotal - commissionTotals.netTotal)).toString();
                    adjustedMainInfo.quotation_net_tax = (parseCurrency(adjustedMainInfo.quotation_net_tax) / originalNetTotal * (originalNetTotal - commissionTotals.netTotal)).toString();
                }

                const adjustmentDetails = {
                    initial: { cost: originalNetTotal, price: originalRackTotal },
                    ignoredLines: commissionLines,
                    ignoredTotals: { cost: commissionTotals.netTotal, price: commissionTotals.rackTotal },
                    adjusted: { cost: originalNetTotal - commissionTotals.netTotal, price: originalRackTotal - commissionTotals.rackTotal }
                };
                
                const sortedLines = mainServiceLines.sort((a, b) => {
                    const dayA = parseInt(a.quotation_line_day_number, 10);
                    const dayB = parseInt(b.quotation_line_day_number, 10);
                    if (dayA !== dayB) return dayA - dayB;
                    const seqA = parseInt(a.quotation_line_sequence, 10);
                    const seqB = parseInt(b.quotation_line_sequence, 10);
                    return seqA - seqB;
                });
                
                // 3. `apiData` ahora contiene la versión de *trabajo* para la UI, con totales ajustados y líneas filtradas.
                const workingData = { 
                    mainInfo: adjustedMainInfo, 
                    lines: sortedLines 
                };
                
                appState.currentQuote.id = `COT-API-${quoteId}`;
                appState.currentQuote.fileName = `API Import - ${quoteId}`;
                appState.currentQuote.apiData = workingData; // La data de trabajo
                appState.currentQuote.adjustmentDetails = adjustmentDetails;
                
                renderQuoteHeader(workingData.mainInfo);
                renderFinancialSummary(workingData.mainInfo);
                renderAdjustmentDetails(); 
                DOM.quoteDetailsWrapper.classList.remove('hidden');
                
                runCalculationEngine();
                
                DOM.saveQuoteBtn.disabled = false;
                DOM.viewJsonBtn.disabled = false;
                showNotification("Cotización cargada y procesada con éxito.", 'success');
                translateUI(appState.uiLanguage);
            } catch (error) {
                showNotification(`Error al buscar cotización: ${error.message}`, 'error');
                resetMainView();
            }
        }


        function renderAdjustmentDetails() {
            const modalBody = document.getElementById('adjustments-modal-body');
            const details = appState.currentQuote.adjustmentDetails;
            if (!details) {
                modalBody.innerHTML = '';
                return;
            }

            const tableRows = `
                <tr>
                    <td class="p-2 font-medium text-white" data-lang-key="adjustmentsInitial">Totales Iniciales (API)</td>
                    <td class="p-2 text-right font-mono text-white">${formatCurrency(details.initial.cost)}</td>
                    <td class="p-2 text-right font-mono text-white">${formatCurrency(details.initial.price)}</td>
                </tr>
                ${details.ignoredLines.map(line => `
                    <tr class="text-red-400">
                        <td class="p-2 pl-6 text-sm">(-) ${line.quotation_line_service_name} (${line.quotation_line_service_code})</td>
                        <td class="p-2 text-right font-mono text-sm">${formatCurrency(parseCurrency(line.quotation_line_net_total))}</td>
                        <td class="p-2 text-right font-mono text-sm">${formatCurrency(parseCurrency(line.quotation_line_rack_total))}</td>
                    </tr>
                `).join('')}
                <tr class="border-t-2 border-gray-600">
                    <td class="p-2 font-bold text-white" data-lang-key="adjustmentsAdjusted">Totales Ajustados (Base de Cálculo)</td>
                    <td class="p-2 text-right font-mono font-bold text-white">${formatCurrency(details.adjusted.cost)}</td>
                    <td class="p-2 text-right font-mono font-bold text-white">${formatCurrency(details.adjusted.price)}</td>
                </tr>
            `;

            modalBody.innerHTML = `
                <table class="w-full text-sm">
                    <thead>
                        <tr style="background-color: transparent;">
                            <th class="p-2 text-left border-b border-gray-700 text-gray-400" data-lang-key="adjustmentsDescription">Descripción</th>
                            <th class="p-2 text-right border-b border-gray-700 text-gray-400" data-lang-key="adjustmentsCost">Costo</th>
                            <th class="p-2 text-right border-b border-gray-700 text-gray-400" data-lang-key="adjustmentsPrice">Precio</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
        }
        
        function renderQuoteHeader(mainInfo) {
            const headerMain = document.getElementById('quote-header-main');
            const headerComments = document.getElementById('quote-header-comments');
            const createCard = (titleKey, value) => `<div class="detail-card"><p class="detail-card-title" data-lang-key="${titleKey}"></p><p class="detail-card-value">${value || 'N/A'}</p></div>`;
            const createComment = (titleKey, value) => `<div class="detail-card flex-1 min-h-[80px]"><p class="detail-card-title" data-lang-key="${titleKey}"></p><p class="text-xs mt-1 text-gray-700">${value || '<span data-lang-key=\\"detailNoComments\\">Sin comentarios.</span>'}</p></div>`;
            headerMain.innerHTML = [
                createCard('detailPassenger', mainInfo.quotation_name), createCard('detailClient', mainInfo.quotation_customer_name),
                createCard('detailCreatedBy', mainInfo.quotation_sales_executive_user_name), createCard('detailStartDate', new Date(mainInfo.quotation_start_date).toLocaleDateString('es-CR')),
                createCard('detailEndDate', new Date(mainInfo.quotation_end_date).toLocaleDateString('es-CR')), createCard('detailStatus', mainInfo.quotation_status),
                createCard('detailExported', mainInfo.quotation_was_exported ? 'Sí' : 'No'),
            ].join('');
            headerComments.innerHTML = [
                createComment('detailInternalComments', mainInfo.quotation_internal_comments), createComment('detailObservations', mainInfo.quotation_observations),
                createComment('detailSpecialRemarks', mainInfo.quotation_special_remarks),
            ].join('');
        }

        function renderFinancialSummary(mainInfo) {
            const container = document.getElementById('quote-financial-summary');
            const ventaTotal = parseCurrency(mainInfo.quotation_customer_rack_total);
            const subtotalVenta = parseCurrency(mainInfo.quotation_customer_rack_sub_total);
            const ivaVenta = parseCurrency(mainInfo.quotation_customer_rack_tax);
            const costoTotal = parseCurrency(mainInfo.quotation_net_total);
            const subtotalCosto = parseCurrency(mainInfo.quotation_net_sub_total);
            const ivaCosto = parseCurrency(mainInfo.quotation_net_tax);
            const utilidadBruta = ventaTotal - costoTotal;
            const margen = ventaTotal > 0 ? (utilidadBruta / ventaTotal) * 100 : 0;
            
            container.innerHTML = `
                <div class="summary-card">
                    <p class="summary-title text-green-600" data-lang-key="summaryPrice">Precio (Imp. Inc.)</p>
                    <p class="summary-value text-green-700">${formatCurrency(ventaTotal)}</p>
                    <p class="summary-sub">Sub: ${formatCurrency(subtotalVenta)} + IVA: ${formatCurrency(ivaVenta)}</p>
                </div>
                <div class="summary-card">
                    <p class="summary-title text-red-600" data-lang-key="summaryCost">Costo (Imp. Inc.)</p>
                    <p class="summary-value text-red-700">${formatCurrency(costoTotal)}</p>
                    <p class="summary-sub">Sub: ${formatCurrency(subtotalCosto)} + IVA: ${formatCurrency(ivaCosto)}</p>
                </div>
                <div class="summary-card">
                    <p class="summary-title text-yellow-600" data-lang-key="summaryGrossProfit">Utilidad Bruta</p>
                    <p class="summary-value text-yellow-700">${formatCurrency(utilidadBruta)}</p>
                    <p class="summary-sub"><span data-lang-key="summaryMargin">Margen</span>: ${margen.toFixed(2)}%</p>
                </div>`;
        }
        
        function resetMainView(keepInputs = false) {
             appState.currentQuote = { id: null, fileName: '', details: {}, rawData: null, apiData: null, processedData: [], adjustmentDetails: null, finalCalculatedTotal: 0 };
             if (!keepInputs) { DOM.quoteIdInput.value = ''; }
             DOM.quoteDetailsWrapper.classList.add('hidden');
             document.getElementById('adjustments-modal-body').innerHTML = '';
             DOM.apiQuoteTableBody.innerHTML = `<tr><td colspan="55" class="text-center p-16 text-text-light" data-lang-key="tablePlaceholder">Ingrese un ID de cotización para buscar en Toursys.</td></tr>`;
             DOM.apiQuoteTableHead.innerHTML = '';
             DOM.saveQuoteBtn.disabled = true;
             DOM.viewJsonBtn.disabled = true;
             appState.isDirty = false;
             translateUI(appState.uiLanguage);
        }

        // --- VI. LÓGICA DE CÁLCULO (MOTOR FINANCIERO) ---
        function runCalculationEngine() {
            if (!appState.currentQuote.apiData) {
                updateParamsModalUI(); // Update with zeros if no quote
                return;
            }
            
            appState.isDirty = true;
            const { parameters } = appState;
            const originalLines = appState.currentQuote.apiData.lines;

            const totalBaseProrrateo = originalLines.reduce((sum, line) => {
                const codServ = line.quotation_line_service_code;
                if (["RESFEE", "DEPOSITO", "FONAFIFO"].includes(codServ)) return sum;
                return sum + parseCurrency(line.quotation_line_final_rack_sub_total);
            }, 0);

            appState.currentQuote.processedData = originalLines.map(line => {
                const subtotalCosto = parseCurrency(line.quotation_line_final_net_sub_total);
                const impCostoMonto = parseCurrency(line.quotation_line_final_net_tax);
                const subtotalVenta = parseCurrency(line.quotation_line_final_rack_sub_total);
                const impVentaMonto = parseCurrency(line.quotation_line_final_rack_tax);
                
                const calculated = {};

                // FASE 1
                calculated.impCostoPorcentaje = subtotalCosto > 0 ? impCostoMonto / subtotalCosto : 0;
                calculated.impVentaPorcentaje = subtotalVenta > 0 ? impVentaMonto / subtotalVenta : 0;
                calculated.impServPorcentaje = calculated.impCostoPorcentaje >= 0.23 ? 0.10 : 0;
                calculated.impServMonto = calculated.impServPorcentaje * subtotalCosto;
                const utilidadMonto = subtotalVenta - subtotalCosto;
                calculated.utilidadPorcentaje = subtotalVenta > 0 ? utilidadMonto / subtotalVenta : 0;

                // FASE 2: Gross-Up Engine
                const codServ = line.quotation_line_service_code;
                const esExcepcion = ["RESFEE", "DEPOSITO", "FONAFIFO"].includes(codServ);

                let sumaPorcentajes = calculated.utilidadPorcentaje;
                if (parameters.nuba.activado) sumaPorcentajes += parameters.nuba.porcentaje;
                if (parameters.virtuoso.activado) sumaPorcentajes += parameters.virtuoso.porcentaje;
                if (parameters.smartflyer.activado) sumaPorcentajes += parameters.smartflyer.porcentaje;
                if (parameters.fora.activado) sumaPorcentajes += parameters.fora.porcentaje;
                if (parameters.fundacion.activado) sumaPorcentajes += parameters.fundacion.porcentaje;
                
                const utilidadAgentePorcentaje = line.utilidadAgentePorcentaje || 0;
                if (parameters.comisionAgente.tipo === 'Sobre el todo') {
                    sumaPorcentajes += parameters.comisionAgente.porcentaje;
                } else { // 'Sobre linea'
                    sumaPorcentajes += utilidadAgentePorcentaje;
                }

                const costoBaseAjustado = esExcepcion || (1 - sumaPorcentajes) <= 0 ? subtotalCosto : subtotalCosto / (1 - sumaPorcentajes);
                calculated.baseParaProrrateo = esExcepcion ? 0 : subtotalVenta;

                // FASE 3
                calculated.nuba = esExcepcion ? 0 : costoBaseAjustado * (parameters.nuba.activado ? parameters.nuba.porcentaje : 0);
                calculated.virtuoso = esExcepcion ? 0 : costoBaseAjustado * (parameters.virtuoso.activado ? parameters.virtuoso.porcentaje : 0);
                calculated.smartflyer = esExcepcion ? 0 : costoBaseAjustado * (parameters.smartflyer.activado ? parameters.smartflyer.porcentaje : 0);
                calculated.fora = esExcepcion ? 0 : costoBaseAjustado * (parameters.fora.activado ? parameters.fora.porcentaje : 0);
                calculated.fundacion = esExcepcion ? 0 : costoBaseAjustado * (parameters.fundacion.activado ? parameters.fundacion.porcentaje : 0);
                
                let comisionAgentePorcentualSinIva = 0;
                if (parameters.comisionAgente.tipo === 'Sobre el todo') {
                    comisionAgentePorcentualSinIva = esExcepcion ? 0 : costoBaseAjustado * parameters.comisionAgente.porcentaje;
                } else { // 'Sobre linea'
                    comisionAgentePorcentualSinIva = esExcepcion ? 0 : costoBaseAjustado * utilidadAgentePorcentaje;
                }
                calculated.comisionAgentePorcentualSinIva = comisionAgentePorcentualSinIva;
                
                // FASE 4
                const comisionAbsolutaAgente = esExcepcion || totalBaseProrrateo <= 0 ? 0 : (subtotalVenta / totalBaseProrrateo) * parameters.comisionAgente.montoAbsoluto;
                calculated.comisionAbsolutaAgente = comisionAbsolutaAgente;

                // FASE 5
                calculated.impNuba = calculated.nuba * parameters.impuestoGeneralIVA;
                calculated.impVirtuoso = calculated.virtuoso * parameters.impuestoGeneralIVA;
                calculated.impSmartflyer = calculated.smartflyer * parameters.impuestoGeneralIVA;
                calculated.impFora = calculated.fora * parameters.impuestoGeneralIVA;
                calculated.impFundacion = calculated.fundacion * parameters.impuestoGeneralIVA;
                calculated.impComisionAgentePorcentual = calculated.comisionAgentePorcentualSinIva * parameters.impuestoGeneralIVA;
                calculated.impComisionAbsolutaAgente = calculated.comisionAbsolutaAgente * parameters.impuestoGeneralIVA;

                // FASE 6
                calculated.incrementoUtilidad = esExcepcion ? 0 : (costoBaseAjustado * calculated.utilidadPorcentaje) - utilidadMonto;
                calculated.impIncrementoUtilidad = calculated.incrementoUtilidad * parameters.impuestoGeneralIVA;

                const sumaComisionesSinIva = calculated.nuba + calculated.virtuoso + calculated.smartflyer + calculated.fora + calculated.fundacion + calculated.comisionAgentePorcentualSinIva + calculated.comisionAbsolutaAgente;
                calculated.subtotalVentaFinal = subtotalCosto + utilidadMonto + sumaComisionesSinIva + calculated.incrementoUtilidad;
                
                const sumaImpuestosComisiones = calculated.impNuba + calculated.impVirtuoso + calculated.impSmartflyer + calculated.impFora + calculated.impFundacion + calculated.impComisionAgentePorcentual + calculated.impComisionAbsolutaAgente;
                calculated.impVentaFinal = impVentaMonto + sumaImpuestosComisiones + calculated.impIncrementoUtilidad;
                
                calculated.impuestoServicioTotal = calculated.impServMonto;
                let totalVentaFinal = calculated.subtotalVentaFinal + calculated.impVentaFinal + calculated.impuestoServicioTotal;
                
                calculated.totalVentaFinal = totalVentaFinal;
                
                calculated.tarjeta = parameters.tarjeta.activado ? calculated.totalVentaFinal * parameters.tarjeta.porcentaje : 0;
                calculated.impTarjeta = calculated.tarjeta * parameters.impuestoGeneralIVA;
                calculated.ventaTotalConComisionTarjeta = calculated.totalVentaFinal + calculated.tarjeta + calculated.impTarjeta;

                return { ...line, calculated };
            });
            
            renderProcessedQuoteTable();
            renderProcessedFinancialSummary();
            updateParamsModalUI();
        }


        // --- VII. RENDERIZADO PROCESADO ---
        function renderProcessedQuoteTable() {
            const lines = appState.currentQuote.processedData;
            if (!lines || lines.length === 0) {
                 DOM.apiQuoteTableBody.innerHTML = `<tr><td colspan="55" class="text-center p-16 text-text-light" data-lang-key="tablePlaceholderNoLines">La cotización no tiene líneas de servicio para mostrar después del filtrado.</td></tr>`;
                 translateUI(appState.uiLanguage);
                 return;
            }

            const headers = [ "", "Día", "Secuencia", "Fecha Inicio", "Fecha Fin", "Cod. Prov.", "Proveedor", "Cod. Serv.", "Nombre Serv. Interno", "Nombre Serv. Adicional", "Nombre Ser. Esp.", "Nombre Ser. Eng.", "Tip. Serv.", "Subtotal Costo", "Imp. Costo %", "Imp. Costo $", "Var. Costo", "Total Costo", "Subtotal Venta", "Imp. Venta %", "Imp. Venta $", "Imp. Serv. %", "Imp. Serv. $", "Var. Venta", "Total Venta", "Utilidad %", "Utilidad $", "Utilidad del Agente %", "Nuba", "Imp. Nuba", "Virtuoso", "Imp. Virtuoso", "SmartFlyer", "Imp. SmartFlyer", "Fora", "Imp. Fora", "Fundacion", "Imp. Fundación", "Comisión del Agente", "Imp Comisión del Agente", "Base para el prorrateo", "Comisión absoluta del Agente", "Imp Comisión absoluta del Agente", "Tarjeta", "Imp. Tarjeta", "Incremento de la utilidad", "Imp. Incremento de la utilidad", "Subtotal Venta Final", "Imp. Venta Final", "Impuesto Servicio Total", "Total Venta Final", "Venta Total con comisión de tarjeta", "Observaciones", "Req. Especiales", "Desc. Corta", "Desc. Larga" ];
            DOM.apiQuoteTableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-2 py-3 text-left">${h}</th>`).join('')}</tr>`;
            
            let tableBodyHtml = '';
            lines.forEach(line => {
                const { calculated } = line;
                let rowClass = 'hover:bg-gray-100';
                
                let comboToggleButtonHTML = '<td class="w-10"></td>'; // Celda vacía por defecto
                if (line.quotation_line_is_combo == true) {
                    rowClass = 'combo-row hover:bg-green-200';
                    comboToggleButtonHTML = `
                        <td class="w-10 text-center">
                            <button class="combo-details-btn icon-btn text-green-700" data-line-id="${line.quotation_line_id}" title="Ver componentes del combo">
                                <span class="material-icons-outlined text-base">list_alt</span>
                            </button>
                        </td>
                    `;
                }
                else if (line.quotation_line_service_code === 'DEPOSITO') rowClass = 'deposito-row hover:bg-orange-200';
                else if (line.quotation_line_service_code === 'RESFEE') rowClass = 'resfee-row hover:bg-cyan-200';
                else if (line.quotation_line_service_code === 'FONAFIFO') rowClass = 'fonafifo-row hover:bg-pink-200';
                else if (['CAJCHI', 'COR', 'SAN'].includes(line.quotation_line_service_type)) rowClass = 'special-row hover:bg-sky-100';

                const isEditable = appState.parameters.comisionAgente.tipo === 'Linea por Linea';
                const utilidadAgenteCell = isEditable
                    ? `<td class="editable-cell"><input type="number" data-line-id="${line.quotation_line_id}" value="${(line.utilidadAgentePorcentaje || 0) * 100}" onfocus="this.value=''" class="utilidad-agente-input w-20" step="0.1" /></td>`
                    : `<td class="text-right font-mono readonly-cell">${((appState.parameters.comisionAgente.porcentaje || 0) * 100).toFixed(2)}%</td>`;

                tableBodyHtml += `
                    <tr class="${rowClass}" data-line-id="${line.quotation_line_id}">
                        ${comboToggleButtonHTML}
                        <td>${line.quotation_line_day_number}</td>
                        <td>${line.quotation_line_sequence}</td>
                        <td>${line.quotation_line_start_date}</td>
                        <td>${line.quotation_line_end_date}</td>
                        <td>${line.quotation_line_supplier_code}</td>
                        <td>${line.quotation_line_supplier_commercial_name}</td>
                        <td>${line.quotation_line_service_code}</td>
                        <td>${line.quotation_line_service_name}</td>
                        <td>${line.quotation_line_service_additional_name}</td>
                        <td>${line.quotation_line_service_information_display_name}</td>
                        <td>${line.quotation_line_service_name_english}</td>
                        <td>${line.quotation_line_service_type}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_net_sub_total))}</td>
                        <td class="text-right font-mono">${(calculated.impCostoPorcentaje * 100).toFixed(2)}%</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_net_tax))}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_net_variation))}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_net_total))}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_rack_sub_total))}</td>
                        <td class="text-right font-mono">${(calculated.impVentaPorcentaje * 100).toFixed(2)}%</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_rack_tax))}</td>
                        <td class="text-right font-mono">${(calculated.impServPorcentaje * 100).toFixed(2)}%</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impServMonto)}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_rack_variation))}</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_rack_total))}</td>
                        <td class="text-right font-mono">${(calculated.utilidadPorcentaje * 100).toFixed(2)}%</td>
                        <td class="text-right font-mono">${formatCurrency(parseCurrency(line.quotation_line_final_rack_sub_total) - parseCurrency(line.quotation_line_final_net_sub_total))}</td>
                        ${utilidadAgenteCell}
                        <td class="text-right font-mono">${formatCurrency(calculated.nuba)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impNuba)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.virtuoso)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impVirtuoso)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.smartflyer)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impSmartflyer)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.fora)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impFora)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.fundacion)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impFundacion)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.comisionAgentePorcentualSinIva)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impComisionAgentePorcentual)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.baseParaProrrateo)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.comisionAbsolutaAgente)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impComisionAbsolutaAgente)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.tarjeta)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impTarjeta)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.incrementoUtilidad)}</td>
                        <td class="text-right font-mono">${formatCurrency(calculated.impIncrementoUtilidad)}</td>
                        <td class="text-right font-mono font-bold">${formatCurrency(calculated.subtotalVentaFinal)}</td>
                        <td class="text-right font-mono font-bold">${formatCurrency(calculated.impVentaFinal)}</td>
                        <td class="text-right font-mono font-bold">${formatCurrency(calculated.impuestoServicioTotal)}</td>
                        <td class="text-right font-mono font-extrabold text-blue-800">${formatCurrency(calculated.totalVentaFinal)}</td>
                        <td class="text-right font-mono font-extrabold text-purple-800">${formatCurrency(calculated.ventaTotalConComisionTarjeta)}</td>
                        <td>${line.quotation_line_comments}</td>
                        <td>${line.quotation_line_special_remarks}</td>
                        <td>${line.quotation_line_service_information_short_description}</td>
                        <td>${line.quotation_line_service_information_long_description}</td>
                    </tr>`;
                });
            
            DOM.apiQuoteTableBody.innerHTML = tableBodyHtml;
        }


        function renderProcessedFinancialSummary() {
            if (!appState.currentQuote.processedData || appState.currentQuote.processedData.length === 0) {
                if (appState.currentQuote.apiData && appState.currentQuote.apiData.mainInfo) {
                    renderFinancialSummary(appState.currentQuote.apiData.mainInfo);
                }
                return;
            }

            const totals = appState.currentQuote.processedData.reduce((acc, line) => {
                const { calculated } = line;
                acc.ventaFinal += calculated.ventaTotalConComisionTarjeta;
                acc.subtotalVentaFinal += calculated.subtotalVentaFinal + calculated.tarjeta; // Ajuste aquí
                acc.ivaVentaFinal += calculated.impVentaFinal + calculated.impuestoServicioTotal + calculated.impTarjeta;
                
                acc.costoOriginalSinIVA += parseCurrency(line.quotation_line_net_sub_total);
                acc.ivaCostoOriginal += parseCurrency(line.quotation_line_net_tax);
                
                acc.totalComisionesSinIVA += calculated.nuba + calculated.virtuoso + calculated.smartflyer + calculated.fora + calculated.fundacion + calculated.comisionAgentePorcentualSinIva + calculated.comisionAbsolutaAgente + calculated.tarjeta;
                acc.totalImpuestosComisiones += calculated.impNuba + calculated.impVirtuoso + calculated.impSmartflyer + calculated.impFora + calculated.impFundacion + calculated.impComisionAgentePorcentual + calculated.impComisionAbsolutaAgente + calculated.impTarjeta;

                acc.totalIncrementoUtilidadSinIVA += calculated.incrementoUtilidad;

                return acc;
            }, { 
                ventaFinal: 0, subtotalVentaFinal: 0, ivaVentaFinal: 0,
                costoOriginalSinIVA: 0, ivaCostoOriginal: 0,
                totalComisionesSinIVA: 0, totalImpuestosComisiones: 0,
                totalIncrementoUtilidadSinIVA: 0
            });
            
            let subtotalCostoFinal = totals.costoOriginalSinIVA + totals.totalComisionesSinIVA;
            let ivaCostoFinal = totals.ivaCostoOriginal + totals.totalImpuestosComisiones;
            
            if (appState.parameters.transferencia.activado) {
                const transferenciaConIVA = appState.parameters.transferencia.montoFijo;
                const transferenciaSinIVA = transferenciaConIVA / (1 + appState.parameters.impuestoGeneralIVA);
                const ivaTransferencia = transferenciaConIVA - transferenciaSinIVA;
                
                subtotalCostoFinal += transferenciaSinIVA;
                ivaCostoFinal += ivaTransferencia;
                totals.subtotalVentaFinal += transferenciaSinIVA;
                totals.ivaVentaFinal += ivaTransferencia;
            }

            let costoFinalTotal = subtotalCostoFinal + ivaCostoFinal;
            totals.ventaFinal = totals.subtotalVentaFinal + totals.ivaVentaFinal;

            appState.currentQuote.finalCalculatedTotal = totals.ventaFinal; // GUARDAR EL VALOR FINAL

            const utilidadBrutaFinal = totals.subtotalVentaFinal - subtotalCostoFinal;
            const margenFinal = totals.subtotalVentaFinal > 0 ? (utilidadBrutaFinal / totals.subtotalVentaFinal) * 100 : 0;
            
            const container = document.getElementById('quote-financial-summary');
            container.innerHTML = `
                <div class="summary-card">
                    <p class="summary-title text-green-600" data-lang-key="summaryFinalPrice">PRECIO VENTA FINAL</p>
                    <p class="summary-value text-green-700">${formatCurrency(totals.ventaFinal)}</p>
                    <p class="summary-sub">Sub: ${formatCurrency(totals.subtotalVentaFinal)} + IVA: ${formatCurrency(totals.ivaVentaFinal)}</p>
                </div>
                <div class="summary-card">
                    <p class="summary-title text-red-600" data-lang-key="summaryFinalCost">COSTO FINAL</p>
                    <p class="summary-value text-red-700">${formatCurrency(costoFinalTotal)}</p>
                    <p class="summary-sub">Sub: ${formatCurrency(subtotalCostoFinal)} + IVA: ${formatCurrency(ivaCostoFinal)}</p>
                </div>
                <div class="summary-card">
                    <p class="summary-title text-yellow-600" data-lang-key="summaryFinalGrossProfit">UTILIDAD BRUTA FINAL</p>
                    <p class="summary-value text-yellow-700">${formatCurrency(utilidadBrutaFinal)}</p>
                    <p class="summary-sub"><span data-lang-key="summaryMargin">Margen</span>: ${margenFinal.toFixed(2)}%</p>
                </div>
            `;
            translateUI(appState.uiLanguage);
        }
        
        function updateParamsModalUI() {
            const { parameters, currentQuote } = appState;
            const form = DOM.paramsForm;
            const format = (num) => `$${parseFloat(num || 0).toFixed(2)}`;

            if (!currentQuote.apiData || currentQuote.processedData.length === 0) {
                form.querySelectorAll('.param-output').forEach(el => el.textContent = '$0.00');
                form.elements['param-utilidad-agente-porc'].value = '0';
                form.elements['param-utilidad-agente-monto'].value = '0';
                form.querySelectorAll('.param-toggle-btn').forEach(btn => btn.classList.remove('active'));
                return;
            }

            const processedTotals = currentQuote.processedData.reduce((acc, line) => {
                const { calculated } = line;
                acc.nuba += calculated.nuba;
                acc.virtuoso += calculated.virtuoso;
                acc.smartflyer += calculated.smartflyer;
                acc.fora += calculated.fora;
                acc.fundacion += calculated.fundacion;
                acc.tarjeta += calculated.tarjeta;
                acc.utilidadTerranova += calculated.incrementoUtilidad;
                acc.utilidadAgente += calculated.comisionAgentePorcentualSinIva + calculated.comisionAbsolutaAgente;
                return acc;
            }, { nuba: 0, virtuoso: 0, smartflyer: 0, fora: 0, fundacion: 0, tarjeta: 0, utilidadTerranova: 0, utilidadAgente: 0 });

            form.elements['param-escenario'].value = parameters.comisionAgente.tipo;
            form.querySelectorAll('.param-toggle-btn').forEach(btn => {
                const paramName = btn.dataset.param;
                if(parameters[paramName]) btn.classList.toggle('active', parameters[paramName].activado);
            });
            form.elements['param-utilidad-agente-porc'].value = parameters.comisionAgente.porcentaje * 100;
            form.elements['param-utilidad-agente-monto'].value = parameters.comisionAgente.montoAbsoluto;
            form.elements['param-transferencia-monto'].value = parameters.transferencia.montoFijo;
            
            document.getElementById('output-utilidad-agente-sin-iva').textContent = format(processedTotals.utilidadAgente);
            document.getElementById('output-utilidad-agente-con-iva').textContent = format(processedTotals.utilidadAgente * (1 + parameters.impuestoGeneralIVA));
            
            document.getElementById('output-utilidad-terranova-sin-iva').textContent = format(processedTotals.utilidadTerranova);
            document.getElementById('output-utilidad-terranova-con-iva').textContent = format(processedTotals.utilidadTerranova * (1 + parameters.impuestoGeneralIVA));

            document.getElementById('output-nuba-sin-iva').textContent = format(processedTotals.nuba);
            document.getElementById('output-nuba-con-iva').textContent = format(processedTotals.nuba * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-virtuoso-sin-iva').textContent = format(processedTotals.virtuoso);
            document.getElementById('output-virtuoso-con-iva').textContent = format(processedTotals.virtuoso * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-smartflyer-sin-iva').textContent = format(processedTotals.smartflyer);
            document.getElementById('output-smartflyer-con-iva').textContent = format(processedTotals.smartflyer * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-fora-travel-sin-iva').textContent = format(processedTotals.fora);
            document.getElementById('output-fora-travel-con-iva').textContent = format(processedTotals.fora * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-tarjeta-sin-iva').textContent = format(processedTotals.tarjeta);
            document.getElementById('output-tarjeta-con-iva').textContent = format(processedTotals.tarjeta * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-fundacion-sin-iva').textContent = format(processedTotals.fundacion);
            document.getElementById('output-fundacion-con-iva').textContent = format(processedTotals.fundacion * (1 + parameters.impuestoGeneralIVA));
            document.getElementById('output-transferencia-con-iva').textContent = format(parameters.transferencia.activado ? parameters.transferencia.montoFijo : 0);
        }

        function handleParamsChange() {
            const form = DOM.paramsForm;
            appState.parameters.comisionAgente.tipo = form.elements['param-escenario'].value;
            form.querySelectorAll('.param-toggle-btn').forEach(btn => {
                const paramName = btn.dataset.param;
                if(appState.parameters[paramName]) {
                    appState.parameters[paramName].activado = btn.classList.contains('active');
                }
            });
            
            const isLineaPorLinea = appState.parameters.comisionAgente.tipo === 'Linea por Linea';
            const utilidadPorcInput = form.elements['param-utilidad-agente-porc'];
            const utilidadMontoInput = form.elements['param-utilidad-agente-monto'];

            utilidadPorcInput.disabled = isLineaPorLinea;
            utilidadMontoInput.disabled = isLineaPorLinea;
            if (isLineaPorLinea) {
                utilidadPorcInput.value = '0';
                utilidadMontoInput.value = '0';
            }

            appState.parameters.comisionAgente.porcentaje = parseFloat(utilidadPorcInput.value / 100) || 0;
            appState.parameters.comisionAgente.montoAbsoluto = parseFloat(utilidadMontoInput.value) || 0;
            appState.parameters.transferencia.montoFijo = parseFloat(form.elements['param-transferencia-monto'].value) || 0;
            
            localStorage.setItem('comisionesParams_v4.2', JSON.stringify(appState.parameters));
            runCalculationEngine();
        }

        function setupEventListeners() {
            DOM.loginForm.addEventListener('submit', handleLogin);
            DOM.logoutBtn.addEventListener('click', () => location.reload());
            DOM.fetchQuoteBtn.addEventListener('click', handleFetchToursysQuote);
            DOM.viewJsonBtn.addEventListener('click', () => {
                const jsonModal = document.getElementById('json-view-modal');
                // **REFACTORIZACIÓN ARQUITECTÓNICA: Apuntar a la data cruda**
                if (appState.currentQuote.rawData) {
                    jsonModal.querySelector('#json-code-content').textContent = JSON.stringify(appState.currentQuote.rawData, null, 2);
                    jsonModal.classList.add('visible');
                }
            });
             document.getElementById('copy-json-btn').addEventListener('click', (e) => {
                const code = document.getElementById('json-code-content').textContent;
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const target = e.currentTarget;
                target.querySelector('span:last-child').textContent = '¡Copiado!';
                target.querySelector('.material-icons-outlined').textContent = 'check';
                setTimeout(() => {
                    target.querySelector('span:last-child').textContent = 'Copiar Código';
                    target.querySelector('.material-icons-outlined').textContent = 'content_copy';
                }, 2000);
            });
            document.getElementById('close-json-modal').addEventListener('click', () => {
                 document.getElementById('json-view-modal').classList.remove('visible');
            });
            DOM.sidebarLinks.forEach(link => { link.addEventListener('click', e => { e.preventDefault(); switchView(link.dataset.view); }); });
            DOM.openParamsModalBtn.addEventListener('click', openParamsModal);
            DOM.cancelParamsBtn.addEventListener('click', closeParamsModal);
            
            DOM.paramsForm.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', handleParamsChange);
                el.addEventListener('change', handleParamsChange);
            });
            DOM.paramsForm.querySelectorAll('.param-toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    handleParamsChange();
                });
            });

            DOM.apiQuoteTableBody.addEventListener('click', e => {
                const comboBtn = e.target.closest('.combo-details-btn');
                if (comboBtn) {
                    showLineDetails(comboBtn.dataset.lineId, 'table');
                }
            });

            DOM.apiQuoteTableBody.addEventListener('dblclick', e => {
                // Prevenir que el modal se abra al hacer doble clic en un campo de entrada
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    return;
                }
                const row = e.target.closest('tr');
                if (row && row.dataset.lineId) {
                    showLineDetails(row.dataset.lineId, 'json');
                }
            });

            DOM.apiQuoteTableBody.addEventListener('change', e => {
                if (e.target.classList.contains('utilidad-agente-input')) {
                    const lineId = e.target.dataset.lineId;
                    // Se busca la línea en `apiData` para persistir el cambio
                    // La comparación no estricta (==) maneja diferencias de tipo (string vs number)
                    const apiLine = appState.currentQuote.apiData.lines.find(l => l.quotation_line_id == lineId);
                    if(apiLine) {
                       // Se parsea el valor como float para soportar decimales
                       apiLine.utilidadAgentePorcentaje = parseFloat(e.target.value) / 100 || 0;
                    }
                    runCalculationEngine();
                }
            });

            DOM.saveQuoteBtn.addEventListener('click', handleSaveQuote);
            DOM.toggleAdjustmentsBtn.addEventListener('click', () => {
                document.getElementById('adjustments-modal').classList.add('visible');
            });
            document.getElementById('close-adjustments-modal').addEventListener('click', () => {
                 document.getElementById('adjustments-modal').classList.remove('visible');
            });
             document.getElementById('adjustments-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('visible');
                }
            });

            document.getElementById('close-line-details-modal').addEventListener('click', () => {
                document.getElementById('line-details-modal').classList.remove('visible');
            });
            document.getElementById('line-details-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('visible');
                }
            });
            
            DOM.uiLangSwitcher.addEventListener('click', (e) => {
                const btn = e.target.closest('.lang-btn');
                if (btn && !btn.classList.contains('active')) {
                    const lang = btn.dataset.lang;
                    appState.uiLanguage = lang;
                    localStorage.setItem('uiLanguage', lang);
                    DOM.uiLangSwitcher.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    translateUI(lang);
                }
            });

            // AJUSTE ARQUITECTÓNICO: Mover el listener de la tabla de guardados aquí para que se adjunte una sola vez y evitar duplicados.
            DOM.savedQuotesView.querySelector('#saved-quotes-tbody').addEventListener('click', e => { 
                const button = e.target.closest('button'); 
                if(!button) return; 
                const { action, id } = button.dataset; 
                if(action === 'delete') { handleDeleteQuote(id); } 
                if(action === 'edit') { loadQuoteIntoMainView(id); }
                if(action === 'send') { loadQuoteIntoEnviosView(id); } 
            });

            setupEditorToolbar();
            initResizableTables(); // Iniciar la funcionalidad de tablas redimensionables
        }

        // --- IX. INICIALIZACIÓN ---
        async function main() {
            appState.uiLanguage = localStorage.getItem('uiLanguage') || 'es';
            DOM.uiLangSwitcher.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === appState.uiLanguage);
            });
            translateUI(appState.uiLanguage);

            setupEventListeners();
            await refreshAllData();
            populateUserSelect();
            translateUI(appState.uiLanguage); // Translate again after data load
        }
        
        // --- X. LÓGICA DE TABLAS REDIMENSIONABLES ---
        function makeTableResizable(table) {
            // Columnas
            const headers = table.querySelectorAll('thead th');
            headers.forEach(header => {
                if (header.querySelector('.resize-handle-col')) return;
                header.classList.add('resizable-th');
                const handle = document.createElement('div');
                handle.className = 'resize-handle-col';
                header.appendChild(handle);

                handle.addEventListener('mousedown', e => {
                    e.preventDefault();
                    e.stopPropagation();

                    const startX = e.pageX;
                    const startWidth = header.offsetWidth;
                    
                    const onMouseMove = (moveEvent) => {
                        const newWidth = startWidth + (moveEvent.pageX - startX);
                        if (newWidth > 30) { 
                            header.style.width = `${newWidth}px`;
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        handle.classList.remove('resizing-col');
                        document.body.style.cursor = 'default';
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    handle.classList.add('resizing-col');
                    document.body.style.cursor = 'col-resize';
                });
            });

            // Filas
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                 if (row.querySelector('.resize-handle-row')) return;
                 // Usar la primera celda para anclar el handle de la fila
                 const firstCell = row.querySelector('td');
                 if(!firstCell) return;

                 firstCell.classList.add('resizable-tr'); // La clase de posicionamiento va en la celda
                 const handle = document.createElement('div');
                 handle.className = 'resize-handle-row';
                 firstCell.appendChild(handle);

                 handle.addEventListener('mousedown', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const startY = e.pageY;
                    const startHeight = row.offsetHeight;

                     const onMouseMove = (moveEvent) => {
                        const newHeight = startHeight + (moveEvent.pageY - startY);
                        if (newHeight > 20) {
                            row.style.height = `${newHeight}px`;
                        }
                    };

                     const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        handle.classList.remove('resizing-row');
                        document.body.style.cursor = 'default';
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    handle.classList.add('resizing-row');
                    document.body.style.cursor = 'row-resize';
                 });
            });
        }
        
        function initResizableTables() {
            const observerCallback = (mutationsList) => {
                for(const mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Es un elemento
                                if (node.tagName === 'TABLE') {
                                    makeTableResizable(node);
                                } else {
                                    node.querySelectorAll('table').forEach(makeTableResizable);
                                }
                            }
                        });
                    }
                }
            };
            
            const observer = new MutationObserver(observerCallback);
            const config = { childList: true, subtree: true };

            const mainTableWrapper = document.getElementById('api-table-wrapper');
            const shipmentsWrapper = document.getElementById('envios-content-wrapper');

            if(mainTableWrapper) observer.observe(mainTableWrapper, config);
            if(shipmentsWrapper) observer.observe(shipmentsWrapper, config);
        }

        // --- FUNCIONES COMPLETAS (PREVIAMENTE DEFINIDAS) ---
        function handleLogin(e) {
            e.preventDefault();
            const selectedUserValue = DOM.loginUserSelect.value;
            if (!selectedUserValue) { showNotification("Por favor, seleccione un usuario.", 'error'); return; }
            
            let userToLogin = null;
            
            if (selectedUserValue === 'Admin') {
                userToLogin = { idUsuario: 'Admin', nombreCompleto: 'Admin (Offline)' };
                if (appState.isOffline) {
                     const mockData = getOfflineMockData();
                     appState.users = mockData.users;
                     appState.services = mockData.services;
                     appState.savedQuotes = mockData.savedQuotes;
                }
            } else {
                 if (!appState.isOffline) {
                    userToLogin = appState.users.find(u => u.idUsuario === selectedUserValue);
                }
            }

            if (userToLogin) {
                appState.currentUser = userToLogin;
                DOM.loginScreen.classList.add('hidden');
                DOM.appWrapper.classList.remove('hidden');
                DOM.currentUserDisplay.textContent = appState.currentUser.nombreCompleto;
                if (appState.isOffline && appState.currentUser.idUsuario === 'Admin') {
                     DOM.currentUserDisplay.textContent += ' (Offline)';
                }
                loadParameters();
                setupSavedQuotesView();
                translateUI(appState.uiLanguage);
            } else {
                showNotification("El usuario seleccionado no es válido.", 'error');
            }
        }

        function showLineDetails(lineId, viewType) {
            const modal = document.getElementById('line-details-modal');
            const titleEl = document.getElementById('line-details-modal-title');
            const contentEl = document.getElementById('line-details-modal-content');

            if (!appState.currentQuote.rawData || !appState.currentQuote.rawData.lines) return;

            const mainLine = appState.currentQuote.rawData.lines.find(l => l.quotation_line_id == lineId);
            if (!mainLine) return;

            const isCombo = mainLine.quotation_line_is_combo == true;
            
            if (viewType === 'json') {
                titleEl.textContent = `JSON - Servicio ID: ${lineId}`;
                let dataToShow = mainLine;
                if (isCombo) {
                    const children = appState.currentQuote.rawData.lines.filter(l => l.quotation_line_parent_combo_quotation_line_id == lineId);
                    dataToShow = {
                        comboPadre: mainLine,
                        componentes: children
                    };
                }
                contentEl.innerHTML = `<pre><code>${JSON.stringify(dataToShow, null, 2)}</code></pre>`;
            } else if (viewType === 'table' && isCombo) {
                titleEl.textContent = `Componentes del Combo: ${mainLine.quotation_line_service_name}`;
                const children = appState.currentQuote.rawData.lines.filter(l => l.quotation_line_parent_combo_quotation_line_id == lineId);
                
                if (children.length > 0) {
                     contentEl.innerHTML = `
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Nombre Servicio</th>
                                    <th scope="col" class="px-4 py-3">Nombre Adicional</th>
                                    <th scope="col" class="px-4 py-3">Nombre Español</th>
                                    <th scope="col" class="px-4 py-3">Nombre Inglés</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${children.map(child => `
                                    <tr class="border-b border-gray-700">
                                        <td class="px-4 py-2">${child.quotation_line_service_name || ''}</td>
                                        <td class="px-4 py-2">${child.quotation_line_service_additional_name || ''}</td>
                                        <td class="px-4 py-2">${child.quotation_line_service_information_display_name || ''}</td>
                                        <td class="px-4 py-2">${child.quotation_line_service_name_english || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    contentEl.textContent = 'Este combo no tiene componentes asociados.';
                }
            }
            modal.classList.add('visible');
        }

        function loadParameters() {
            const savedParams = localStorage.getItem('comisionesParams_v4.2');
            const defaultParams = getDefaultParameters();
            if (savedParams) {
                try {
                    const loadedParams = JSON.parse(savedParams);
                    // Deep merge to ensure all keys exist
                    appState.parameters = {
                        ...defaultParams,
                        ...loadedParams,
                        comisionAgente: { ...defaultParams.comisionAgente, ...(loadedParams.comisionAgente || {}) },
                        nuba: { ...defaultParams.nuba, ...(loadedParams.nuba || {}) },
                        virtuoso: { ...defaultParams.virtuoso, ...(loadedParams.virtuoso || {}) },
                        smartflyer: { ...defaultParams.smartflyer, ...(loadedParams.smartflyer || {}) },
                        fora: { ...defaultParams.fora, ...(loadedParams.fora || {}) },
                        fundacion: { ...defaultParams.fundacion, ...(loadedParams.fundacion || {}) },
                        tarjeta: { ...defaultParams.tarjeta, ...(loadedParams.tarjeta || {}) },
                        transferencia: { ...defaultParams.transferencia, ...(loadedParams.transferencia || {}) },
                    };
                } catch (e) {
                    console.error("Error al parsear parámetros desde localStorage:", e);
                    appState.parameters = defaultParams;
                    localStorage.removeItem('comisionesParams_v4.2');
                }
            } else {
                appState.parameters = defaultParams;
            }
            updateParamsModalUI();
        }

        function openParamsModal(){ DOM.paramsModal.classList.add('visible'); }
        function closeParamsModal(){ DOM.paramsModal.classList.remove('visible'); }
        
        async function handleSaveQuote(){
            if (!appState.currentQuote.id) { showNotification("No hay cotización activa para guardar.", 'error'); return; }
            
            const dataToPersist = {
                processed: appState.currentQuote.processedData,
                rawLines: appState.currentQuote.rawData?.lines || []
            };
            const servicesString = JSON.stringify(dataToPersist);
            
            // AJUSTE ARQUITECTÓNICO: Se inicializan las 21 columnas para datos.
            const dataToSave = {
                idCotizacion: appState.currentQuote.id,
                nombreArchivo: appState.currentQuote.fileName,
                cliente: appState.currentQuote.apiData?.mainInfo?.quotation_customer_name || 'N/A',
                usuarioCreador: appState.currentUser.nombreCompleto,
                fechaGuardado: new Date().toISOString(),
                totalVenta: appState.currentQuote.finalCalculatedTotal || 0,
                dataParametros: JSON.stringify(appState.parameters),
                dataEncabezado: JSON.stringify(appState.currentQuote.apiData.mainInfo),
                dataServicios: '', dataServiciosContingencia: '', dataServiciosContingencia2: '', dataServiciosContingencia3: '',
                dataServiciosContingencia4: '', dataServiciosContingencia5: '', dataServiciosContingencia6: '', dataServiciosContingencia7: '',
                dataServiciosContingencia8: '', dataServiciosContingencia9: '', dataServiciosContingencia10: '', dataServiciosContingencia11: '',
                dataServiciosContingencia12: '', dataServiciosContingencia13: '', dataServiciosContingencia14: '', dataServiciosContingencia15: '',
                dataServiciosContingencia16: '', dataServiciosContingencia17: '', dataServiciosContingencia18: '', dataServiciosContingencia19: '',
                dataServiciosContingencia20: ''
            };
            
            const MAX_CELL_SIZE = 45000;
            let currentString = servicesString;
            let i = 0;
            // AJUSTE ARQUITECTÓNICO: Se expande el bucle para soportar hasta 21 fragmentos de datos.
            while(currentString.length > 0 && i < 21) {
                const keyName = i === 0 
                    ? 'dataServicios' 
                    : `dataServiciosContingencia${i === 1 ? '' : i}`;

                if(dataToSave.hasOwnProperty(keyName)) {
                    dataToSave[keyName] = currentString.substring(0, MAX_CELL_SIZE);
                    currentString = currentString.substring(MAX_CELL_SIZE);
                } else {
                    console.error(`Error de guardado: La cotización es demasiado grande y excede los 21 campos de almacenamiento.`);
                    showNotification("La cotización es demasiado grande para guardarse completamente.", "error");
                    break;
                }
                i++;
            }
            
            try {
                await apiCall('save-quote', { method: 'POST', body: JSON.stringify(dataToSave) });
                showNotification(`Cotización "${dataToSave.nombreArchivo}" guardada.`, 'success');
                appState.isDirty = false; await refreshAllData(); setupSavedQuotesView();
            } catch (error) { showNotification(`Error al guardar: ${error.message}`, 'error'); }
        }

        function renderSavedQuotesTable(quotes){ 
            const tbody = DOM.savedQuotesView.querySelector('#saved-quotes-tbody'); 
            tbody.innerHTML = ''; 
            if (!quotes || quotes.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500" data-lang-key="savedEmpty">No hay cotizaciones para mostrar.</td></tr>`; 
                return; 
            } 
            quotes.forEach(quote => { 
                const row = document.createElement('tr'); 
                row.className = "hover:bg-gray-50"; 
                row.innerHTML = ` 
                    <td class="p-3 font-mono">${quote.idCotizacion}</td> 
                    <td class="p-3 font-semibold">${quote.nombreArchivo}</td> 
                    <td class="p-3">${quote.cliente}</td> 
                    <td class="p-3">${quote.usuarioCreador || 'N/A'}</td> 
                    <td class="p-3">${new Date(quote.fechaGuardado).toLocaleString('es-CR')}</td> 
                    <td class="p-3 font-mono text-right font-bold">${formatCurrency(parseCurrency(quote.totalVenta))}</td> 
                    <td class="p-3 text-center space-x-2"> 
                        <button class="icon-btn text-teal-600" data-action="send" data-id="${quote.idCotizacion}" title="Preparar Envío" data-lang-key-title="tooltipPrepareShipment"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg></button>
                        <button class="icon-btn text-blue-600" data-action="edit" data-id="${quote.idCotizacion}" title="Editar" data-lang-key-title="tooltipEdit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button> 
                        <button class="icon-btn text-red-600" data-action="delete" data-id="${quote.idCotizacion}" title="Eliminar" data-lang-key-title="tooltipDelete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button> 
                    </td> `; 
                tbody.appendChild(row); 
            }); 
        }

        function setupSavedQuotesView(){ 
            const userFilter = DOM.savedQuotesView.querySelector('#user-filter-select'); 
            const searchInput = DOM.savedQuotesView.querySelector('#search-saved-quotes'); 
            const allUsersText = uiTranslations.savedAllUsers[appState.uiLanguage];
            const uniqueUsers = [allUsersText, ...new Set(appState.savedQuotes.map(q => q.usuarioCreador).filter(Boolean))]; 
            userFilter.innerHTML = '';
            uniqueUsers.forEach(user => { 
                const option = new Option(user, user === allUsersText ? '' : user); 
                userFilter.add(option); 
            }); 
            
            if (appState.currentUser && appState.currentUser.nombreCompleto !== 'Admin (Offline)') { 
                userFilter.value = appState.currentUser.nombreCompleto; 
            } else { 
                userFilter.value = ''; 
            } 

            const applyFilters = () => { 
                const searchTerm = searchInput.value.toLowerCase(); 
                const selectedUser = userFilter.value; 
                
                const sortedQuotes = [...appState.savedQuotes].sort((a,b) => new Date(b.fechaGuardado) - new Date(a.fechaGuardado));

                const filteredQuotes = sortedQuotes.filter(q => { 
                    const matchesSearch = (q.idCotizacion || '').toLowerCase().includes(searchTerm) || (q.nombreArchivo || '').toLowerCase().includes(searchTerm) || (q.cliente || '').toLowerCase().includes(searchTerm); 
                    const matchesUser = !selectedUser || q.usuarioCreador === selectedUser; 
                    return matchesSearch && matchesUser; 
                }); 
                renderSavedQuotesTable(filteredQuotes); 
                translateUI(appState.uiLanguage);
            }; 

            userFilter.addEventListener('change', applyFilters); 
            searchInput.addEventListener('input', applyFilters); 
            
            // EL LISTENER DE CLICS SE HA MOVIDO A setupEventListeners() PARA EVITAR DUPLICACIÓN.

            applyFilters(); 
        }

        function loadQuoteIntoMainView(quoteId) {
            const quote = appState.savedQuotes.find(q => q.idCotizacion === quoteId);
            if (!quote) return;

            try {
                resetMainView(true);
                appState.parameters = JSON.parse(quote.dataParametros);

                // CORRECCIÓN ARQUITECTÓNICA: Se reconstruye la cadena JSON concatenando las 20 columnas de contingencia.
                let servicesString = quote.dataServicios || '';
                for (let i = 1; i <= 20; i++) {
                    const key = `dataServiciosContingencia${i === 1 ? '' : i}`;
                    if (quote[key]) {
                        servicesString += quote[key];
                    }
                }
                
                const persistedData = JSON.parse(servicesString || '{}');

                // --- INICIO DE LA CORRECCIÓN QUIRÚRGICA ---
                // El `dataEncabezado` guardado es el `adjustedMainInfo` (ya ajustado).
                // Debemos reconstruir el `mainInfo` ORIGINAL antes de volver a procesar.
                const savedAdjustedMainInfo = JSON.parse(quote.dataEncabezado);
                const allRawLines = persistedData.rawLines || [];
                
                // 1. Recalcular los totales de las comisiones ignoradas a partir de las líneas crudas guardadas.
                const commissionCodesToIgnore = ['COPOPA', 'COMTBA', 'COMTCR', 'COMTCRTO', 'FOUNDA', 'UTTERA', 'UTTERAO'];
                const commissionLines = allRawLines.filter(line => commissionCodesToIgnore.includes(line.quotation_line_service_code));
                
                const commissionTotals = commissionLines.reduce((acc, line) => {
                    acc.rackTotal += parseCurrency(line.quotation_line_rack_total);
                    acc.netTotal += parseCurrency(line.quotation_line_net_total);
                    acc.rackSubTotal += parseCurrency(line.quotation_line_rack_sub_total);
                    acc.rackTax += parseCurrency(line.quotation_line_rack_tax);
                    acc.netSubTotal += parseCurrency(line.quotation_line_net_sub_total);
                    acc.netTax += parseCurrency(line.quotation_line_net_tax);
                    return acc;
                }, { rackTotal: 0, netTotal: 0, rackSubTotal: 0, rackTax: 0, netSubTotal: 0, netTax: 0 });

                // 2. Reconstruir el objeto `mainInfo` original sumando los totales de comisión al encabezado ajustado.
                const reconstructedOriginalMainInfo = { ...savedAdjustedMainInfo };
                reconstructedOriginalMainInfo.quotation_customer_rack_total = (parseCurrency(savedAdjustedMainInfo.quotation_customer_rack_total) + commissionTotals.rackTotal).toString();
                reconstructedOriginalMainInfo.quotation_net_total = (parseCurrency(savedAdjustedMainInfo.quotation_net_total) + commissionTotals.netTotal).toString();
                reconstructedOriginalMainInfo.quotation_customer_rack_sub_total = (parseCurrency(savedAdjustedMainInfo.quotation_customer_rack_sub_total) + commissionTotals.rackSubTotal).toString();
                reconstructedOriginalMainInfo.quotation_customer_rack_tax = (parseCurrency(savedAdjustedMainInfo.quotation_customer_rack_tax) + commissionTotals.rackTax).toString();
                reconstructedOriginalMainInfo.quotation_net_sub_total = (parseCurrency(savedAdjustedMainInfo.quotation_net_sub_total) + commissionTotals.netSubTotal).toString();
                reconstructedOriginalMainInfo.quotation_net_tax = (parseCurrency(savedAdjustedMainInfo.quotation_net_tax) + commissionTotals.netTax).toString();

                // 3. Crear `combinedData` usando el encabezado ORIGINAL reconstruido, para que el resto del flujo sea idéntico al de una búsqueda API.
                const combinedData = {
                     mainInfo: reconstructedOriginalMainInfo,
                     lines: allRawLines 
                };
                // --- FIN DE LA CORRECCIÓN QUIRÚRGICA ---
                
                // AJUSTE ARQUITECTÓNICO: Aplicar la misma corrección de totales aquí para consistencia.
                combinedData.mainInfo.quotation_net_total = (parseCurrency(combinedData.mainInfo.quotation_net_sub_total) + parseCurrency(combinedData.mainInfo.quotation_net_tax)).toString();
                combinedData.mainInfo.quotation_customer_rack_total = (parseCurrency(combinedData.mainInfo.quotation_customer_rack_sub_total) + parseCurrency(combinedData.mainInfo.quotation_customer_rack_tax)).toString();
                (combinedData.lines || []).forEach(line => {
                    // Verificar que las propiedades existan, ya que podríamos estar cargando datos procesados antiguos.
                    if(line.hasOwnProperty('quotation_line_net_sub_total') && line.hasOwnProperty('quotation_line_net_tax')) {
                        line.quotation_line_net_total = (parseCurrency(line.quotation_line_net_sub_total) + parseCurrency(line.quotation_line_net_tax)).toString();
                    }
                    if(line.hasOwnProperty('quotation_line_rack_sub_total') && line.hasOwnProperty('quotation_line_rack_tax')) {
                        line.quotation_line_rack_total = (parseCurrency(line.quotation_line_rack_sub_total) + parseCurrency(line.quotation_line_rack_tax)).toString();
                    }
                });

                appState.currentQuote.rawData = combinedData;

                // 3. Re-ejecutar la lógica de negocio idéntica a la de una búsqueda por API.
                // Esta lógica ahora operará sobre el `combinedData` reconstruido y consistente.
                const allLinesAfterReconstruction = combinedData.lines || [];
                const nonComboComponentLines = allLinesAfterReconstruction.filter(line => line.quotation_line_belongs_to_combo == false);
                const commissionLinesForAdjustment = nonComboComponentLines.filter(line => commissionCodesToIgnore.includes(line.quotation_line_service_code));
                const mainServiceLines = nonComboComponentLines.filter(line => !commissionCodesToIgnore.includes(line.quotation_line_service_code));

                const commissionTotalsForAdjustment = commissionLinesForAdjustment.reduce((acc, line) => {
                    acc.rackTotal += parseCurrency(line.quotation_line_rack_total);
                    acc.netTotal += parseCurrency(line.quotation_line_net_total);
                    return acc;
                }, { rackTotal: 0, netTotal: 0 });

                const adjustedMainInfo = { ...combinedData.mainInfo };
                const originalNetTotal = parseCurrency(adjustedMainInfo.quotation_net_total);
                const originalRackTotal = parseCurrency(adjustedMainInfo.quotation_customer_rack_total);

                adjustedMainInfo.quotation_customer_rack_total = (originalRackTotal - commissionTotalsForAdjustment.rackTotal).toString();
                adjustedMainInfo.quotation_net_total = (originalNetTotal - commissionTotalsForAdjustment.netTotal).toString();

                appState.currentQuote.adjustmentDetails = {
                    initial: { cost: originalNetTotal, price: originalRackTotal },
                    ignoredLines: commissionLinesForAdjustment,
                    ignoredTotals: { cost: commissionTotalsForAdjustment.netTotal, price: commissionTotalsForAdjustment.rackTotal },
                    adjusted: { cost: originalNetTotal - commissionTotalsForAdjustment.netTotal, price: originalRackTotal - commissionTotalsForAdjustment.rackTotal }
                };

                const sortedLines = mainServiceLines.sort((a, b) => {
                    const dayA = parseInt(a.quotation_line_day_number, 10);
                    const dayB = parseInt(b.quotation_line_day_number, 10);
                    if (dayA !== dayB) return dayA - dayB;
                    const seqA = parseInt(a.quotation_line_sequence, 10);
                    const seqB = parseInt(b.quotation_line_sequence, 10);
                    return seqA - seqB;
                });
                
                appState.currentQuote.apiData = { mainInfo: adjustedMainInfo, lines: sortedLines };

                // 4. Fusionar ediciones del usuario (ej: comisiones por línea)
                const savedProcessedLines = persistedData.processed || [];
                if (savedProcessedLines.length > 0) {
                    appState.currentQuote.apiData.lines.forEach(apiLine => {
                        const savedLine = savedProcessedLines.find(p => p.quotation_line_id == apiLine.quotation_line_id);
                        if (savedLine && savedLine.hasOwnProperty('utilidadAgentePorcentaje')) {
                            apiLine.utilidadAgentePorcentaje = savedLine.utilidadAgentePorcentaje;
                        }
                    });
                }
                
                // 5. Poblar el estado, renderizar y ejecutar el motor de cálculo.
                appState.currentQuote.id = quote.idCotizacion;
                appState.currentQuote.fileName = quote.nombreArchivo;
                
                DOM.quoteIdInput.value = (appState.currentQuote.id || '').replace('COT-API-', '');
                renderQuoteHeader(appState.currentQuote.apiData.mainInfo);
                renderFinancialSummary(appState.currentQuote.apiData.mainInfo);
                renderAdjustmentDetails();
                DOM.quoteDetailsWrapper.classList.remove('hidden');
                
                runCalculationEngine();
                
                DOM.saveQuoteBtn.disabled = false;
                DOM.viewJsonBtn.disabled = false;
                switchView('main-view');
                showNotification(`Cargada la cotización: ${quote.nombreArchivo}`, 'info');

            } catch (err) {
                showNotification('Error crítico al cargar los datos de la cotización guardada.', 'error');
                console.error("Error parsing saved quote data:", err);
            }
        }
        async function handleDeleteQuote(id){ if (!confirm(`¿Está seguro de que desea eliminar la cotización ${id}?`)) return; try { await apiCall('delete-quote', { method: 'DELETE', body: JSON.stringify({ idCotizacion: id }) }); showNotification('Cotización eliminada.', 'success'); await refreshAllData(); setupSavedQuotesView(); } catch(error) { showNotification(`Error al eliminar: ${error.message}`, 'error'); } }
        
        function loadQuoteIntoEnviosView(quoteId) {
            const quote = appState.savedQuotes.find(q => q.idCotizacion === quoteId);
            if (!quote) {
                showNotification('No se encontró la cotización guardada.', 'error');
                return;
            }
            try {
                // AJUSTE ARQUITECTÓNICO: Reutilizar la lógica de parsing de `loadQuoteIntoMainView` para asegurar consistencia.
                let servicesString = quote.dataServicios || '';
                for (let i = 1; i <= 20; i++) {
                    const key = `dataServiciosContingencia${i === 1 ? '' : i}`;
                    if (quote[key]) {
                        servicesString += quote[key];
                    }
                }
                const persistedData = JSON.parse(servicesString || '{}');
                
                // Reconstruir un objeto de cotización completo y procesado para la vista de envíos.
                appState.quoteForShipment = {
                    ...quote, // Mantener datos originales como id, nombre, etc.
                    parsedServices: persistedData.processed || [] // Almacenar los datos ya procesados y calculados.
                };

                switchView('envios-view');

            } catch (err) {
                showNotification('Error al procesar datos para envío.', 'error');
                console.error("Error parsing quote for shipment:", err);
            }
        }
        
        // --- LÓGICA DE ENVÍOS (RECONSTRUIDA) ---
        function renderEnviosView() {
            const quote = appState.quoteForShipment;
            const wrapper = DOM.enviosContentWrapper;

            if (!quote) {
                wrapper.innerHTML = `<p class="text-center text-text-light content-panel p-6 m-8" data-lang-key="shipmentsPlaceholder">Seleccione una cotización desde la pestaña "Guardadas" para preparar un envío.</p>`;
                translateUI(appState.uiLanguage);
                return;
            }

            // AJUSTE 1: Mover el botón al flujo normal y ajustar el contenedor del título
            wrapper.innerHTML = `
                <div class="flex-grow flex overflow-hidden">
                    <aside id="envios-params-panel" class="w-72 bg-gray-50 p-4 border-r flex-shrink-0 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg" data-lang-key="shipmentsParamsTitle">Parámetros</h3>
                            <button id="toggle-params-btn" title="Ocultar Parámetros" class="icon-btn text-gray-600" data-lang-key-title="tooltipHideParams"><i class="material-icons-outlined">chevron_left</i></button>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamType">Tipo</label><select id="envio-doc-type" class="w-full mt-1 p-2 border rounded-md"><option value="cotizacion" data-lang-key="shipmentTypeQuote">Cotización</option><option value="cotizacion-extendida" data-lang-key="shipmentTypeExtendedQuote">Cotización Extendida</option><option value="confirmacion" data-lang-key="shipmentTypeConfirmation">Confirmación</option><option value="proforma" data-lang-key="shipmentTypeInvoice">Factura</option></select></div>
                            <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamLang">Idioma</label><select id="envio-lang" class="w-full mt-1 p-2 border rounded-md"><option value="es">Español</option><option value="en">Inglés</option></select></div>
                            <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamPrices">Precios</label><select id="envio-precios" class="w-full mt-1 p-2 border rounded-md"><option value="con" data-lang-key="shipmentPricesShow">Mostrar Precios</option><option value="sin" data-lang-key="shipmentPricesHide">Ocultar Precios</option></select></div>
                            <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamVisibility">Visibilidad</label><select id="envio-vista" class="w-full mt-1 p-2 border rounded-md"><option value="tabla" data-lang-key="shipmentVisibilityTable">Tabla Detallada</option><option value="total" data-lang-key="shipmentVisibilityTotal">Solo Total</option></select></div>
                            <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamTaxes">Impuestos</label><select id="envio-impuesto" class="w-full mt-1 p-2 border rounded-md"><option value="final" data-lang-key="shipmentTaxesEnd">Desglose al Final</option><option value="linea" data-lang-key="shipmentTaxesLine">Incluido en Línea</option></select></div>
                            <div id="proforma-only-params" class="space-y-4">
                                <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamDeposit">Depósito (%)</label><input type="number" id="envio-deposito" value="50" class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium" data-lang-key="shipmentsParamPaymentDays">Días para Pago Final</label><input type="number" id="envio-dias-pago" value="60" class="w-full mt-1 p-2 border rounded-md"></div>
                            </div>
                            <div class="flex items-center"><input id="envio-nota" type="checkbox" class="h-4 w-4 rounded" checked><label for="envio-nota" class="ml-2 text-sm" data-lang-key="shipmentsIncludeNotes">Incluir Notas</label></div>
                            <div class="flex items-center"><input id="envio-comision-agente" type="checkbox" class="h-4 w-4 rounded"><label for="envio-comision-agente" class="ml-2 text-sm" data-lang-key="shipmentsShowAgent">Mostrar Comisión Agente</label></div>
                            <div id="ecosystems-params" class="hidden space-y-2 pt-4 border-t border-gray-200">
                                <label class="block text-sm font-medium" data-lang-key="shipmentsIncludeEcosystems">Ecosistemas a Incluir</label>
                                <div id="ecosystems-checkboxes" class="space-y-1 max-h-48 overflow-y-auto">
                                </div>
                            </div>
                        </div>
                    </aside>
                    <div class="flex-grow p-6 overflow-y-auto bg-gray-200">
                        <div class="flex justify-between items-center mb-4">
                             <div class="flex items-center gap-2">
                                <button id="show-params-btn" title="Mostrar Parámetros" class="hidden icon-btn text-gray-600 bg-white rounded-full shadow-md" data-lang-key-title="tooltipShowParams"><i class="material-icons-outlined">chevron_right</i></button>
                                <h2 class="text-xl font-bold" data-lang-key="shipmentsTitle">Vista Previa Editable</h2>
                             </div>
                             <div class="flex items-center gap-2">
                                 <button id="envio-pdf" title="Exportar PDF" class="icon-btn" data-lang-key-title="tooltipExportPDF"><i class="material-icons-outlined">picture_as_pdf</i></button>
                                 <button id="envio-print" title="Imprimir" class="icon-btn" data-lang-key-title="tooltipPrint"><i class="material-icons-outlined">print</i></button>
                                 <button id="envio-excel" title="Exportar Excel" class="icon-btn" data-lang-key-title="tooltipExportExcel"><i class="material-icons-outlined">table_view</i></button>
                                 <button id="envio-word" title="Descargar Word" class="icon-btn" data-lang-key-title="tooltipDownloadWord"><i class="material-icons-outlined">description</i></button>
                                 <button id="envio-email" title="Copiar para Correo y Abrir" class="btn btn-primary" data-lang-key-title="tooltipCopyEmail"><i class="material-icons-outlined">email</i></button>
                            </div>
                        </div>
                        <div id="shipment-preview-container" class="w-full max-w-4xl mx-auto rounded-lg overflow-hidden">
                        </div>
                    </div>
                </div>
            `;
            
            const docTypeSelect = document.getElementById('envio-doc-type');
            
            document.querySelectorAll('#envios-params-panel select, #envios-params-panel input').forEach(el => {
                el.addEventListener('change', generateShipmentPreview);
            });

            populateEcosystemsCheckboxes();

            const toggleProformaParams = (docType) => {
                const proformaParamsContainer = document.getElementById('proforma-only-params');
                if (proformaParamsContainer) {
                    proformaParamsContainer.style.display = docType === 'proforma' ? 'block' : 'none';
                }
            };

            docTypeSelect.addEventListener('change', (e) => {
                toggleEcosystemsPanel(e.target.value);
                toggleProformaParams(e.target.value);
            });
            
            toggleEcosystemsPanel(docTypeSelect.value);
            toggleProformaParams(docTypeSelect.value);


            document.getElementById('envio-word').addEventListener('click', exportToWord);
            document.getElementById('envio-email').addEventListener('click', sendEmail);
            document.getElementById('envio-pdf').addEventListener('click', generatePDF);
            document.getElementById('envio-print').addEventListener('click', printShipment);
            document.getElementById('envio-excel').addEventListener('click', exportToExcel);
            document.getElementById('toggle-params-btn').addEventListener('click', () => {
                document.getElementById('envios-params-panel').classList.add('collapsed');
                document.getElementById('show-params-btn').classList.remove('hidden');
            });
             document.getElementById('show-params-btn').addEventListener('click', () => {
                document.getElementById('envios-params-panel').classList.remove('collapsed');
                document.getElementById('show-params-btn').classList.add('hidden');
            });
            translateUI(appState.uiLanguage);
            generateShipmentPreview();
        }

        // --- Traducción UI ---
        const uiTranslations = {
            loginTitle: { es: 'Herramienta de Comisiones y Envíos', en: 'Commission & Dispatch Tool' },
            loginSubtitle: { es: 'Seleccione su usuario para ingresar', en: 'Select your user to log in' },
            loginButton: { es: 'Ingresar', en: 'Login' },
            loginLoading: { es: 'Cargando...', en: 'Loading...' },
            loginSelectUser: { es: 'Seleccionar Usuario', en: 'Select User' },
            sidebarTitle: { es: 'Comisiones y Envíos', en: 'Commissions & Dispatch' },
            sidebarLinkCommissions: { es: 'Comisiones', en: 'Commissions' },
            sidebarLinkShipments: { es: 'Envíos', en: 'Dispatch' },
            sidebarLinkSaved: { es: 'Guardadas', en: 'Saved Quotes' },
            sidebarLogout: { es: 'Cerrar Sesión', en: 'Logout' },
            mainTitle: { es: 'Cálculo de Comisiones', en: 'Commission Calculation' },
            buttonSave: { es: 'Guardar', en: 'Save' },
            buttonParameters: { es: 'Parámetros', en: 'Parameters' },
            labelQuoteId: { es: 'ID Cotización Toursys:', en: 'Toursys Quote ID:' },
            placeholderQuoteId: { es: 'Ej: 24500', en: 'Ex: 24500' },
            buttonSearch: { es: 'Buscar', en: 'Search' },
            buttonViewJson: { es: 'Ver JSON', en: 'View JSON' },
            tablePlaceholder: { es: 'Ingrese un ID de cotización para buscar en Toursys.', en: 'Enter a quote ID to search in Toursys.' },
            tablePlaceholderNoLines: { es: 'La cotización no tiene líneas de servicio para mostrar después del filtrado.', en: 'The quote has no service lines to display after filtering.' },
            detailPassenger: { es: 'Nombre / Pasajero', en: 'Name / Passenger' },
            detailClient: { es: 'Cliente', en: 'Client' },
            detailCreatedBy: { es: 'Creado por', en: 'Created by' },
            detailStartDate: { es: 'Fecha Inicio', en: 'Start Date' },
            detailEndDate: { es: 'Fecha Fin', en: 'End Date' },
            detailStatus: { es: 'Estado', en: 'Status' },
            detailExported: { es: 'Exportada', en: 'Exported' },
            detailInternalComments: { es: 'Comentarios Internos', en: 'Internal Comments' },
            detailObservations: { es: 'Observaciones', en: 'Observations' },
            detailSpecialRemarks: { es: 'Requisitos Especiales', en: 'Special Remarks' },
            detailNoComments: { es: 'Sin comentarios.', en: 'No comments.'},
            summaryPrice: { es: 'Precio (Imp. Inc.)', en: 'Price (Tax Inc.)' },
            summaryCost: { es: 'Costo (Imp. Inc.)', en: 'Cost (Tax Inc.)' },
            summaryGrossProfit: { es: 'Utilidad Bruta', en: 'Gross Profit' },
            summaryMargin: { es: 'Margen', en: 'Margin' },
            summaryFinalPrice: { es: 'PRECIO VENTA FINAL', en: 'FINAL SALE PRICE' },
            summaryFinalCost: { es: 'COSTO FINAL', en: 'FINAL COST' },
            summaryFinalGrossProfit: { es: 'UTILIDAD BRUTA FINAL', en: 'FINAL GROSS PROFIT' },
            savedTitle: { es: 'Cotizaciones Guardadas', en: 'Saved Quotes' },
            savedFilterByUser: { es: 'Filtrar por Usuario:', en: 'Filter by User:' },
            savedSearchPlaceholder: { es: 'Buscar por ID o nombre...', en: 'Search by ID or name...' },
            savedAllUsers: { es: 'Todos los Usuarios', en: 'All Users' },
            savedHeaderId: { es: 'ID', en: 'ID' },
            savedHeaderFilename: { es: 'Nombre Archivo', en: 'File Name' },
            savedHeaderClient: { es: 'Cliente', en: 'Client' },
            savedHeaderCreator: { es: 'Usuario Creador', en: 'Creator User' },
            savedHeaderDate: { es: 'Fecha Guardado', en: 'Date Saved' },
            savedHeaderTotal: { es: 'Total Venta', en: 'Total Sale' },
            savedHeaderActions: { es: 'Acciones', en: 'Actions' },
            savedEmpty: { es: 'No hay cotizaciones para mostrar.', en: 'No quotes to display.' },
            shipmentsPlaceholder: { es: 'Seleccione una cotización desde la pestaña "Guardadas" para preparar un envío.', en: 'Select a quote from the "Saved Quotes" tab to prepare a shipment.' },
            shipmentsTitle: { es: 'Vista Previa Editable', en: 'Editable Preview' },
            shipmentsParamsTitle: { es: 'Parámetros', en: 'Parameters' },
            shipmentsParamType: { es: 'Tipo', en: 'Type' },
            shipmentTypeQuote: { es: 'Cotización', en: 'Quotation' },
            shipmentTypeExtendedQuote: { es: 'Cotización Extendida', en: 'Extended Quotation' },
            shipmentTypeConfirmation: { es: 'Confirmación', en: 'Confirmation' },
            shipmentTypeInvoice: { es: 'Factura', en: 'Invoice' },
            shipmentsParamLang: { es: 'Idioma', en: 'Language' },
            shipmentsParamPrices: { es: 'Precios', en: 'Prices' },
            shipmentPricesShow: { es: 'Mostrar Precios', en: 'Show Prices' },
            shipmentPricesHide: { es: 'Ocultar Precios', en: 'Hide Prices' },
            shipmentsParamVisibility: { es: 'Visibilidad', en: 'Visibility' },
            shipmentVisibilityTable: { es: 'Tabla Detallada', en: 'Detailed Table' },
            shipmentVisibilityTotal: { es: 'Solo Total', en: 'Total Only' },
            shipmentVisibilitySummary: { es: 'Resumen por Tipo', en: 'Summary by Type' },
            shipmentsParamTaxes: { es: 'Impuestos', en: 'Taxes' },
            shipmentTaxesEnd: { es: 'Desglose al Final', en: 'Breakdown at End' },
            shipmentTaxesLine: { es: 'Incluido en Línea', en: 'Included in Line' },
            shipmentsParamDeposit: { es: 'Depósito (%)', en: 'Deposit (%)' },
            shipmentsParamPaymentDays: { es: 'Días para Pago Final', en: 'Days for Final Payment' },
            shipmentsIncludeNotes: { es: 'Incluir Notas', en: 'Include Notes' },
            shipmentsShowAgent: { es: 'Mostrar Comisión Agente', en: 'Show Agent Commission' },
            shipmentsIncludeEcosystems: { es: 'Ecosistemas a Incluir', en: 'Ecosystems to Include' },
            modalJsonTitle: { es: 'Respuesta JSON de la API', en: 'API JSON Response' },
            buttonCopyCode: { es: 'Copiar Código', en: 'Copy Code' },
            modalParamsTitle: { es: 'Parámetros de Cálculo', en: 'Calculation Parameters' },
            paramScenario: { es: 'Escenarios de Cálculo', en: 'Calculation Scenarios' },
            paramScenarioAll: { es: 'Sobre el todo', en: 'On the Whole' },
            paramScenarioLine: { es: 'Linea por Linea', en: 'Line by Line' },
            paramAgentProfit: { es: 'Utilidad del Agente', en: "Agent's Profit" },
            paramTerranovaProfit: { es: 'Utilidad TerranovaOrigen', en: 'TerranovaOrigen Profit' },
            paramNoTax: { es: 'Sin IVA', en: 'No VAT' },
            paramWithTax: { es: 'Con IVA', en: 'With VAT' },
            paramCommission: { es: 'Comisión', en: 'Commission' },
            paramNoTaxShort: { es: 'Sin IVA ($)', en: 'No VAT ($)' },
            paramWithTaxShort: { es: 'Con IVA ($)', en: 'With VAT ($)' },
            adjustmentsTitle: { es: 'Desglose de Ajustes de Totales', en: 'Total Adjustments Breakdown' },
            adjustmentsInitial: { es: 'Totales Iniciales (API)', en: 'Initial Totals (API)' },
            adjustmentsAdjusted: { es: 'Totales Ajustados (Base de Cálculo)', en: 'Adjusted Totals (Calculation Base)' },
            adjustmentsDescription: { es: 'Descripción', en: 'Description' },
            adjustmentsCost: { es: 'Costo', en: 'Cost' },
            adjustmentsPrice: { es: 'Precio', en: 'Price' },
            tooltipPrepareShipment: { es: 'Preparar Envío', en: 'Prepare Shipment' },
            tooltipEdit: { es: 'Editar', en: 'Edit' },
            tooltipDelete: { es: 'Eliminar', en: 'Delete' },
            tooltipHideParams: { es: 'Ocultar Parámetros', en: 'Hide Parameters' },
            tooltipShowParams: { es: 'Mostrar Parámetros', en: 'Show Parameters' },
            tooltipExportPDF: { es: 'Exportar PDF', en: 'Export PDF' },
            tooltipExportExcel: { es: 'Exportar Excel', en: 'Export Excel' },
            tooltipDownloadWord: { es: 'Descargar Word', en: 'Download Word' },
            tooltipCopyEmail: { es: 'Copiar para Correo y Abrir', en: 'Copy for Email and Open' },
            tooltipPrint: { es: 'Imprimir', en: 'Print' },
        };

        function translateUI(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (uiTranslations[key] && uiTranslations[key][lang]) {
                    el.innerHTML = uiTranslations[key][lang];
                }
            });
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.dataset.langKeyPlaceholder;
                if (uiTranslations[key] && uiTranslations[key][lang]) {
                    el.placeholder = uiTranslations[key][lang];
                }
            });
            document.querySelectorAll('[data-lang-key-title]').forEach(el => {
                const key = el.dataset.langKeyTitle;
                if (uiTranslations[key] && uiTranslations[key][lang]) {
                    el.title = uiTranslations[key][lang];
                }
            });
        }
        
        const translations = {
            es: {
                quoteTitle: "Cotización", proformaTitle: "FACTURA", confirmationTitle: "Confirmación de Servicios", client: "Cliente", tripDates: "Fechas del Viaje", quoteId: "ID de Cotización",
                proformaId: "Factura #", proformaDate: "Fecha", to: "Para:",
                day: "Día", dates: "Fechas", service: "Servicio", note: "Nota", description: "Descripción", price: "Precio",
                subtotal: "SUBTOTAL", taxes: "Impuestos", ccFee: "Comisión Tarjeta de Crédito", transferFee: "Comisión Transferencia",
                agentCommission: "Comisión Agente",
                deposit: "Depósito del", total: "Total", totalDue: "TOTAL POR PAGAR",
                nextPaymentDate: "Próxima fecha de pago",
                bankFee: "Comisión por transferencia bancaria",
                quantity: "Cantidad", unitPrice: "Precio Unitario", lineTotal: "Total",
                passenger: "Pasajero Principal", quoteName: "Nombre Cotización",
                emailSubject: "Su Cotización de Terranova Origen",
                emailSubjectConfirmation: "Su Confirmación de Servicios de Terranova Origen",
                hours: "Horarios",
                from: "De", at: "A las", to_place: "A", until: "Hasta",
                confirmationNumber: "#conf.",
                checkIn: "Entrada",
                checkOut: "Salida",
                // Cotización Extendida
                greeting: "Buenos días/tardes",
                intro: "¡Espero que este correo te encuentre bien!",
                shortIntroPlaceholder: "[Breve introducción y por qué sugiere la siguiente propuesta...]",
                proposalIncludes: "La propuesta de itinerario incluye:",
                visualPresentation: "Presentación Visual",
                safariPortalLink: "[ENLACE AL PORTAL SAFARI]",
                ecosystems: "Ecosistemas",
                datesAndDuration: "Fechas y Duración",
                days: "Días",
                nights: "Noches",
                night: "Noche",
                lodging: "Alojamiento",
                breakfastIncluded: "Desayuno incluido (bebidas no incluidas)",
                detailedItinerary: "Itinerario Detallado",
                pricing: "Precio",
                taxIncluded: "Se incluye un impuesto del 13% según la ley costarricense.",
                customizationNote: "Estoy totalmente abierto/a a personalizar la propuesta según las preferencias y el presupuesto de los huéspedes. No dudes en contactarme si tienes alguna pregunta o inquietud. Espero tener noticias tuyas pronto.",
                regards: "Saludos cordiales;",
                airportServices: "Servicios de Aeropuertos Internacionales",
                domesticFlights: "Vuelos Domésticos",
                drivingTimes: "Tiempos de Traslado",
                drivingTimesNote: "Por favor, ten en cuenta que estos tiempos son aproximados y pueden cambiar dependiendo del tráfico.",
                itineraryInBrief: "Itinerario en Resumen",
                tripDetails: "Detalles del Viaje",
                guests: "Huéspedes",
                landTransfers: "Traslados Terrestres",
                activities: "Actividades",
                includes: "Incluye",
                excludes: "No Incluye",
                additionalInfo: "Información Adicional",
                // Resumen por tipo
                summaryTableTitle: "Resumen por Tipo de Servicio",
                serviceType: "Tipo de Servicio",
                accommodation: "Alojamiento",
                experiences: "Experiencias",
                transport: "Transportes",
                terranovaOrigenServices: "Servicios Terranova\\Origen",
                donation: "Donación",
            },
            en: {
                quoteTitle: "Quotation", proformaTitle: "INVOICE", confirmationTitle: "Service Confirmation", client: "Client", tripDates: "Trip Dates", quoteId: "Quote ID",
                proformaId: "Invoice #", proformaDate: "Date", to: "To:",
                day: "Day", dates: "Dates", service: "Service", note: "Note", description: "Description", price: "Price",
                subtotal: "SUBTOTAL", taxes: "Taxes", ccFee: "Credit Card Fee", transferFee: "Transfer Fee",
                agentCommission: "Agent Commission",
                deposit: "Deposit Due", total: "Total", totalDue: "TOTAL DUE",
                nextPaymentDate: "Next payment date",
                bankFee: "BANK WIRE FEE",
                quantity: "QUANTITY", unitPrice: "UNIT PRICE", lineTotal: "TOTAL",
                passenger: "Main Passenger", quoteName: "Quotation Name",
                emailSubject: "Your Quotation from Terranova Origen",
                emailSubjectConfirmation: "Your Service Confirmation from Terranova Origen",
                hours: "Hours",
                from: "From", at: "At", to_place: "To", until: "Until",
                confirmationNumber: "#conf.",
                checkIn: "Check-in",
                checkOut: "Check-out",
                // Extended Quote
                greeting: "Good Morning/Afternoon",
                intro: "I hope this email finds you well!",
                shortIntroPlaceholder: "[Short Introduction and why you are suggesting the following proposal...]",
                proposalIncludes: "The proposal itinerary includes:",
                visualPresentation: "Visual Presentation",
                safariPortalLink: "[LINK TO SAFARI PORTAL]",
                ecosystems: "Ecosystems",
                datesAndDuration: "Dates and Duration",
                days: "Days",
                nights: "Nights",
                night: "Night",
                lodging: "Lodging",
                breakfastIncluded: "Breakfast included (drinks not included)",
                detailedItinerary: "Detailed Itinerary",
                pricing: "Pricing",
                taxIncluded: "A 13% tax is included according to the Costa Rican law.",
                customizationNote: "I am fully open to customise the proposal based on the guests preferences and budget. Do not hesitate to contact me if you have any questions or concerns. I look forward to hearing from you soon.",
                regards: "Best regards;",
                airportServices: "International Airports Services",
                domesticFlights: "Domestic Flights",
                drivingTimes: "Driving Times",
                drivingTimesNote: "Please note that these times are approximate and may change depending on the traffic.",
                itineraryInBrief: "Itinerary in Brief",
                tripDetails: "Trip Details",
                guests: "Guests",
                landTransfers: "Land Transfers",
                activities: "Activities",
                includes: "Includes",
                excludes: "Excludes",
                additionalInfo: "Additional Information",
                 // Resumen por tipo
                summaryTableTitle: "Summary by Service Type",
                serviceType: "Service Type",
                accommodation: "Accommodation",
                experiences: "Experiences",
                transport: "Transport",
                terranovaOrigenServices: "Terranova\\Origen Services",
                donation: "Donation",
            }
        };

        function parseTimeToMinutes(timeStr) {
            if (!timeStr || typeof timeStr !== 'string' || timeStr.toLowerCase() === 'n/a') return null;
            const time = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!time) return null;
            let [ , hours, minutes, period] = time;
            hours = parseInt(hours, 10);
            minutes = parseInt(minutes, 10);
            period = period.toUpperCase();

            if (period === 'PM' && hours < 12) {
                hours += 12;
            }
            if (period === 'AM' && hours === 12) { // Midnight case
                hours = 0;
            }
            return hours * 60 + minutes;
        }

        function calculateDurationString(startTime, endTime, lang) {
            const startMinutes = parseTimeToMinutes(startTime);
            const endMinutes = parseTimeToMinutes(endTime);

            if (startMinutes === null || endMinutes === null) {
                return ''; // No duration to calculate
            }

            let duration = endMinutes - startMinutes;
            if (duration < 0) { 
                duration = 0;
            }
            if (duration === 0) {
                return lang === 'es' ? '0 horas' : '0 hours';
            }

            const hours = Math.floor(duration / 60);
            const mins = duration % 60;

            let parts = [];
            if (hours > 0) {
                parts.push(`${hours} ${hours > 1 ? (lang === 'es' ? 'horas' : 'hours') : (lang === 'es' ? 'hora' : 'hour')}`);
            }
            if (mins > 0) {
                parts.push(`${mins} ${mins > 1 ? (lang === 'es' ? 'minutos' : 'minutes') : (lang === 'es' ? 'minuto' : 'minute')}`);
            }
            
            return parts.length > 0 ? parts.join(lang === 'es' ? ' y ' : ' and ') : (lang === 'es' ? '0 horas' : '0 hours');
        }

        function getShipmentData() {
            const quote = appState.quoteForShipment;
            const mainInfo = JSON.parse(quote.dataEncabezado);
            
            // AJUSTE ARQUITECTÓNICO: Leer los servicios desde la propiedad pre-parseada `parsedServices`.
            const services = quote.parsedServices || [];
            const parameters = JSON.parse(quote.dataParametros);

            const docType = document.getElementById('envio-doc-type').value;
            const lang = document.getElementById('envio-lang').value;
            const showPrices = document.getElementById('envio-precios').value === 'con';
            const visibility = document.getElementById('envio-vista').value;
            const showTable = visibility === 'tabla' || visibility === 'resumen_tipo';
            const taxBreakdown = document.getElementById('envio-impuesto').value === 'linea';
            const showNote = document.getElementById('envio-nota').checked;
            const showAgentCommission = document.getElementById('envio-comision-agente').checked;
            const depositPercent = parseFloat(document.getElementById('envio-deposito').value) / 100 || 0.5;
            const diasPago = parseInt(document.getElementById('envio-dias-pago').value, 10) || 60;
            const t = translations[lang];

            let selectedEcosystems = [];
            if (docType === 'cotizacion-extendida') {
                document.querySelectorAll('.ecosystem-checkbox:checked').forEach(cb => {
                    selectedEcosystems.push(cb.value);
                });
            }
            
            // Función de concatenación inteligente
            const getSmartName = (baseName, additionalName) => {
                const hasBase = baseName && baseName.trim() !== '';
                const hasAdditional = additionalName && additionalName.trim() !== '' && additionalName.toLowerCase() !== 'n/a';
                if (hasBase && hasAdditional) return `${baseName} - ${additionalName}`;
                if (hasBase) return baseName;
                if (hasAdditional) return additionalName;
                return '';
            };

            let subtotal = 0; let impuestos = 0; let agentCommissionTotal = 0;
            let originalSubtotalForCommissionCalc = 0;
            let nonCommissionableSubtotalForCommissionCalc = 0;
            const nonCommissionableCodes = ["RESFEE", "DEPOSITO", "FONAFIFO"];

            const tableRows = services.map(line => {
                const lineSubtotal = line.calculated.subtotalVentaFinal;
                const lineTaxes = line.calculated.impVentaFinal + line.calculated.impuestoServicioTotal;
                subtotal += lineSubtotal; 
                impuestos += lineTaxes;
                agentCommissionTotal += line.calculated.comisionAgentePorcentualSinIva + line.calculated.comisionAbsolutaAgente;

                const originalLineSubtotal = parseCurrency(line.quotation_line_rack_sub_total);
                originalSubtotalForCommissionCalc += originalLineSubtotal;
                if (nonCommissionableCodes.includes(line.quotation_line_service_code)) {
                    nonCommissionableSubtotalForCommissionCalc += originalLineSubtotal;
                }

                const baseName = lang === 'en' 
                    ? (line.quotation_line_service_name_english || line.quotation_line_service_name) 
                    : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                
                const additionalName = line.quotation_line_service_additional_name;

                const finalServiceName = getSmartName(baseName, additionalName);
                
                let linePrice = taxBreakdown ? line.calculated.totalVentaFinal : lineSubtotal;
                
                let displayDate = new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                if (line.quotation_line_start_date !== line.quotation_line_end_date) {
                    displayDate = `${new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US')} a ${new Date(line.quotation_line_end_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US')}`;
                }

                let hours = '';
                const pickUpPlace = line.quotation_line_pick_up_place || '';
                const pickUpTime = line.quotation_line_pick_up_time;
                const dropOffPlace = line.quotation_line_drop_off_place || '';
                const dropOffTime = line.quotation_line_drop_off_time;
                const isHotel = line.quotation_line_service_type === 'HTN';

                if (pickUpTime && pickUpTime.trim() && pickUpTime.toLowerCase() !== 'n/a' && pickUpTime !== '12:00 AM') {
                    let parts = [];
                    if (isHotel) {
                        parts.push(`${t.checkIn}: ${pickUpTime}`);
                        if (dropOffTime && dropOffTime.trim() && dropOffTime.toLowerCase() !== 'n/a' && dropOffTime !== '12:00 AM' && pickUpTime !== dropOffTime) {
                            parts.push(`${t.checkOut}: ${dropOffTime}`);
                        }
                    } else {
                        if (pickUpPlace) parts.push(`${t.from}: ${pickUpPlace}`);
                        parts.push(`${t.at}: ${pickUpTime}`);
                        if (dropOffTime && dropOffTime.trim() && dropOffTime.toLowerCase() !== 'n/a' && dropOffTime !== '12:00 AM' && pickUpTime !== dropOffTime) {
                            if (dropOffPlace) parts.push(`${t.to_place}: ${dropOffPlace}`);
                            parts.push(`${t.until}: ${dropOffTime}`);
                        }
                    }
                     hours = parts.join('<br>');
                }

                return {
                    day: line.quotation_line_day_number,
                    dates: displayDate,
                    service: finalServiceName,
                    note: line.quotation_line_special_remarks || '',
                    description: line.quotation_line_service_information_long_description || '',
                    price: linePrice,
                    quantity: line.quotation_line_quantity,
                    hours: hours,
                    // Passthrough de los datos originales para la lógica de Cotización Extendida
                    originalLine: line 
                };
            });

            const comisionTarjeta = services.reduce((acc, line) => acc + line.calculated.tarjeta + line.calculated.impTarjeta, 0);
            const comisionTransferencia = parameters.transferencia.activado ? parameters.transferencia.montoFijo : 0;
            const totalFinal = subtotal + impuestos + comisionTarjeta + comisionTransferencia;

            // Lógica para 'Resumen por Tipo'
            let summaryData = {};
            if (visibility === 'resumen_tipo') {
                const serviceGroups = {
                    accommodation: { types: ['HTN', 'EVE', 'RES'], total: 0 },
                    experiences: { types: ['TON', 'PAQ', 'PKI'], total: 0 },
                    transport: { types: ['TRN', 'ANL', 'RCN', 'SAN', 'ASN'], total: 0 },
                    terranovaOrigenServices: { types: ['CAJCHI'], total: 0, special: { code: 'TEORSE', type: 'PAQ' } },
                    donation: { types: ['HCN'], total: 0 }
                };

                services.forEach(line => {
                    // AJUSTE DE PRECISIÓN: Se selecciona el precio con o sin impuestos según el parámetro 'taxBreakdown'.
                    const price = taxBreakdown ? line.calculated.totalVentaFinal : line.calculated.subtotalVentaFinal;
                    let assigned = false;

                    // Excepción para TEORSE
                    if (line.quotation_line_service_type === serviceGroups.terranovaOrigenServices.special.type && line.quotation_line_service_code === serviceGroups.terranovaOrigenServices.special.code) {
                        serviceGroups.terranovaOrigenServices.total += price;
                        assigned = true;
                    } else {
                        for (const group in serviceGroups) {
                            if (serviceGroups[group].types.includes(line.quotation_line_service_type)) {
                                serviceGroups[group].total += price;
                                assigned = true;
                                break;
                            }
                        }
                    }
                });
                
                Object.keys(serviceGroups).forEach(groupKey => {
                    if (serviceGroups[groupKey].total > 0) {
                        summaryData[groupKey] = {
                            label: t[groupKey],
                            total: serviceGroups[groupKey].total
                        };
                    }
                });
            }

            return { mainInfo, services: tableRows.map(r => r.originalLine), parameters, docType, lang, showPrices, showTable, taxBreakdown, showNote, showAgentCommission, t, tableRows, subtotal, impuestos, comisionTarjeta, comisionTransferencia, totalFinal, agentCommissionTotal, depositPercent, diasPago, selectedEcosystems, getSmartName, originalSubtotalForCommissionCalc, nonCommissionableSubtotalForCommissionCalc, visibility, summaryData };
        }
        
        function populateEcosystemsCheckboxes() {
            const container = document.getElementById('ecosystems-checkboxes');
            if (!container) return;
            container.innerHTML = Object.keys(ecosystems).map(key => `
                <div class="flex items-center">
                    <input id="eco-${key.replace(/\s+/g, '-')}" name="ecosystem" value="${key}" type="checkbox" class="h-4 w-4 rounded ecosystem-checkbox text-primary-color focus:ring-primary-color">
                    <label for="eco-${key.replace(/\s+/g, '-')}" class="ml-2 text-sm text-gray-700">${key}</label>
                </div>
            `).join('');
            
            container.querySelectorAll('.ecosystem-checkbox').forEach(cb => {
                cb.addEventListener('change', generateShipmentPreview);
            });
        }

        function toggleEcosystemsPanel(docType) {
            const panel = document.getElementById('ecosystems-params');
            if (panel) {
                panel.classList.toggle('hidden', docType !== 'cotizacion-extendida');
            }
        }

        function generateShipmentPreview() {
            // --- INICIO: Lógica de visibilidad dinámica ---
            const docTypeSelect = document.getElementById('envio-doc-type');
            const visibilitySelect = document.getElementById('envio-vista');
            if (docTypeSelect && visibilitySelect) {
                const docType = docTypeSelect.value;
                const shouldHaveSummary = (docType === 'cotizacion' || docType === 'cotizacion-extendida');
                const hasSummary = !!visibilitySelect.querySelector('option[value="resumen_tipo"]');

                if (shouldHaveSummary && !hasSummary) {
                    const summaryOption = new Option();
                    summaryOption.value = 'resumen_tipo';
                    summaryOption.dataset.langKey = 'shipmentVisibilitySummary';
                    visibilitySelect.add(summaryOption);
                    translateUI(appState.uiLanguage);
                } else if (!shouldHaveSummary && hasSummary) {
                    if (visibilitySelect.value === 'resumen_tipo') {
                        visibilitySelect.value = 'tabla'; // default back
                    }
                    visibilitySelect.querySelector('option[value="resumen_tipo"]').remove();
                }
            }
            // --- FIN: Lógica de visibilidad dinámica ---
            
            const data = getShipmentData();
            const previewContainer = document.getElementById('shipment-preview-container');
            if (data.docType === 'cotizacion' || data.docType === 'confirmacion') {
                previewContainer.innerHTML = generateQuoteHTML(data);
            } else if (data.docType === 'cotizacion-extendida') {
                previewContainer.innerHTML = generateExtendedQuoteHTML(data);
            } else {
                previewContainer.innerHTML = generateProformaHTML(data);
            }
        }

        function getEditorToolbarHTML() {
            return `
                <div id="editor-toolbar" contenteditable="false">
                    <select class="toolbar-select" data-command="fontName">
                        <option value="Aptos, Arial, sans-serif" selected>Aptos (Cuerpo)</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Arial">Arial</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Open Sans">Open Sans</option>
                        <option value="Lato">Lato</option>
                        <option value="Montserrat">Montserrat</option>
                        <option value="Oswald">Oswald</option>
                        <option value="Merriweather">Merriweather</option>
                        <option value="Playfair Display">Playfair Display</option>
                    </select>
                    <div class="toolbar-separator"></div>
                    <select class="toolbar-select" data-command="fontSize">
                        <option value="2">Pequeño</option>
                        <option value="3" selected>Normal</option>
                        <option value="5">Grande</option>
                        <option value="6">Título</option>
                    </select>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" data-command="bold" title="Negrita"><span class="material-icons-outlined text-sm">format_bold</span></button>
                    <button class="toolbar-btn" data-command="italic" title="Cursiva"><span class="material-icons-outlined text-sm">format_italic</span></button>
                    <button class="toolbar-btn" data-command="underline" title="Subrayado"><span class="material-icons-outlined text-sm">format_underlined</span></button>
                    <select class="toolbar-select" data-command="foreColor" title="Color de Texto">
                        <option value="#000000">Negro</option>
                        <option value="#DC2626">Rojo</option>
                        <option value="#2563EB">Azul</option>
                        <option value="#16A34A">Verde</option>
                        <option value="#194846">Teal</option>
                        <option value="#FFFFFF">Blanco</option>
                    </select>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" data-command="justifyLeft" title="Alinear Izquierda"><span class="material-icons-outlined text-sm">format_align_left</span></button>
                    <button class="toolbar-btn" data-command="justifyCenter" title="Alinear Centro"><span class="material-icons-outlined text-sm">format_align_center</span></button>
                    <button class="toolbar-btn" data-command="justifyRight" title="Alinear Derecha"><span class="material-icons-outlined text-sm">format_align_right</span></button>
                    <div class="toolbar-separator"></div>
                    <button class="toolbar-btn" data-custom-command="alignTop" title="Alinear Arriba"><span class="material-icons-outlined text-sm">vertical_align_top</span></button>
                    <button class="toolbar-btn" data-custom-command="alignMiddle" title="Alinear Medio"><span class="material-icons-outlined text-sm">vertical_align_center</span></button>
                    <button class="toolbar-btn" data-custom-command="alignBottom" title="Alinear Abajo"><span class="material-icons-outlined text-sm">vertical_align_bottom</span></button>
                </div>`;
        }
        
        function generateExtendedQuoteHTML(data) {
            const { mainInfo, services, t, lang, totalFinal, agentCommissionTotal, parameters, selectedEcosystems, showTable, getSmartName } = data;
            const tealColor = '#194846';

            // --- Helper Functions for generating dynamic sections ---
            const introductionHTML = () => {
                let commissionText = '';
                if (data.showPrices) {
                    const { comisionAgente } = parameters;
                    const hasPorcentaje = comisionAgente.porcentaje > 0;
                    const hasMonto = comisionAgente.montoAbsoluto > 0;
                    let textEs = 'Por favor, ten en cuenta que todos los precios son NETOS.';
                    let textEn = 'Please note all pricing is NET.';

                    if (comisionAgente.tipo === 'Sobre el todo') {
                        if (hasPorcentaje && hasMonto) {
                            textEs = `Por favor, ten en cuenta que el precio incluye una comisión del ${comisionAgente.porcentaje * 100}% y un monto de ${formatCurrency(comisionAgente.montoAbsoluto)}.`;
                            textEn = `Please note that the price includes a ${comisionAgente.porcentaje * 100}% commission and an amount of ${formatCurrency(comisionAgente.montoAbsoluto)}.`;
                        } else if (hasPorcentaje) {
                            textEs = `Por favor, ten en cuenta que el precio incluye una comisión del ${comisionAgente.porcentaje * 100}%.`;
                            textEn = `Please note that the price includes a ${comisionAgente.porcentaje * 100}% commission.`;
                        } else if (hasMonto) {
                            textEs = `Por favor, ten en cuenta que el precio incluye una comisión de ${formatCurrency(comisionAgente.montoAbsoluto)}.`;
                            textEn = `Please note that the price includes a commission of ${formatCurrency(comisionAgente.montoAbsoluto)}.`;
                        }
                    } else if (comisionAgente.tipo === 'Linea por Linea') {
                        const { agentCommissionTotal, originalSubtotalForCommissionCalc, nonCommissionableSubtotalForCommissionCalc } = data;
                        const commissionableBase = originalSubtotalForCommissionCalc - nonCommissionableSubtotalForCommissionCalc;
                        if (commissionableBase > 0 && agentCommissionTotal > 0) {
                            const avgPercentage = (agentCommissionTotal / commissionableBase) * 100;
                            textEs = `Por favor, ten en cuenta que el precio incluye una comisión promedio del ${avgPercentage.toFixed(2)}%.`;
                            textEn = `Please note that the price includes an average commission of ${avgPercentage.toFixed(2)}%.`;
                        }
                    }
                    
                    commissionText = `<p style="margin-bottom: 1.5em;">${lang === 'es' ? textEs : textEn}</p>`;
                }

                return `
                    <p style="margin-bottom: 0.5em;">${t.greeting} [Agent Name],</p>
                    <p style="margin-bottom: 0.5em;">${t.intro}</p>
                    <p style="margin-bottom: 0.5em;"><i>${t.shortIntroPlaceholder}</i></p>
                    ${commissionText}`;
            };

            const proposalTitleHTML = () => `<h2 style="font-size: 1.3em; font-weight: bold; color: ${tealColor};">${lang === 'es' ? `Propuesta de Itinerario: ${mainInfo.quotation_name}` : `Itinerary Proposal: ${mainInfo.quotation_name}`}</h2>`;

            const itineraryInBriefHTML = () => {
                const nonComboServices = services.filter(line => line.quotation_line_belongs_to_combo !== "True");
                const serviceList = nonComboServices.map(line => {
                    const baseName = lang === 'en' 
                        ? (line.quotation_line_service_name_english || line.quotation_line_service_name) 
                        : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                    const additionalName = line.quotation_line_service_additional_name;
                    const serviceName = getSmartName(baseName, additionalName);
                    return `<li>${serviceName}</li>`;
                }).join('');
                return `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.itineraryInBrief}</h3>
                        <p>${t.proposalIncludes}</p>
                        <ul style="list-style-type: none; padding-left: 0;">${serviceList}</ul>`;
            };
            
            const tripDetailsHTML = () => {
                 const startDate = new Date(mainInfo.quotation_start_date);
                 const endDate = new Date(mainInfo.quotation_end_date);
                 const nights = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));
                 const days = nights + 1;
                 return `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.tripDetails}</h3>
                        <p><strong>${t.datesAndDuration}:</strong> ${new Date(mainInfo.quotation_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US')} - ${new Date(mainInfo.quotation_end_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US')}</p>
                        <p>${days} ${t.days} / ${nights} ${t.nights}</p>
                        <p><strong>${t.guests}:</strong> ${mainInfo.quotation_pax_quantity}</p>`;
            };
            
            const lodgingHTML = () => {
                 let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.lodging}</h3>`;
                 const hotelLines = services.filter(line => line.quotation_line_service_type === 'HTN');
                 
                 if(hotelLines.length > 0) {
                     html += `<ul style="list-style-type: none; padding-left: 0;">${hotelLines.map(line => {
                        const baseName = lang === 'en' 
                            ? (line.quotation_line_service_name_english || line.quotation_line_service_name) 
                            : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                        const additionalName = line.quotation_line_service_additional_name;
                        const serviceName = getSmartName(baseName, additionalName);
                        const startDate = new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                        const endDate = new Date(line.quotation_line_end_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                        return `<li>${startDate} - ${endDate} - ${serviceName}</li>`;
                     }).join('')}</ul>`;
                 } else {
                     html += `<p>[${lang === 'es' ? 'Detalles de alojamiento...' : 'Lodging details...'}]</p>`;
                 }
                 return html;
            };

            const airportServicesHTML = () => {
                const airportServiceCodes = ['MGENVC', 'MGENVT', 'MGENPN', 'MGESPN', 'MGSLVC', 'MGSLPN'];
                const airportLines = services.filter(line => airportServiceCodes.includes(line.quotation_line_service_code));
                let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.airportServices}</h3>`;
                if(airportLines.length > 0) {
                     html += `<ul style="list-style-type: none; padding-left: 0;">${airportLines.map(line => {
                        const date = new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                        const baseName = lang === 'en' ? (line.quotation_line_service_name_english || line.quotation_line_service_name) : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                        const additionalName = line.quotation_line_service_additional_name;
                        return `<li>${date}: ${getSmartName(baseName, additionalName)}</li>`;
                     }).join('')}</ul>`;
                } else {
                     html += `<p>[${lang === 'es' ? 'Detalles de llegada y salida...' : 'Arrival and departure details...'}]</p>`;
                }
                return html;
            };
            
            const drivingTimesHTML = () => {
                const transferLines = services.filter(line => line.quotation_line_service_type === 'TRN');
                let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.drivingTimes}</h3>`;
                 if(transferLines.length > 0) {
                    html += `<ul style="list-style-type: none; padding-left: 0;">${transferLines.map(line => {
                        const date = new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                        const baseName = lang === 'en' 
                            ? (line.quotation_line_service_name_english || line.quotation_line_service_name) 
                            : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                        const additionalName = line.quotation_line_service_additional_name;
                        const serviceName = getSmartName(baseName, additionalName);
                        const duration = calculateDurationString(line.quotation_line_pick_up_time, line.quotation_line_drop_off_time, lang);
                        return `<li>${date}: ${serviceName}${duration ? ` - ${duration}` : ''}</li>`;
                    }).join('')}</ul>`;
                 } else {
                    html += `<p>[${lang === 'es' ? 'Tiempos de traslado...' : 'Driving times...'}]</p>`;
                 }
                 return html;
            };
            
             const activitiesHTML = () => {
                 const activityLines = services.filter(line => ['TON', 'PAQ'].includes(line.quotation_line_service_type));
                 let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.activities}</h3>`;
                 if(activityLines.length > 0) {
                    html += `<ul style="list-style-type: none; padding-left: 0;">${activityLines.map(line => {
                        const baseName = lang === 'en' ? (line.quotation_line_service_name_english || line.quotation_line_service_name) : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                        const additionalName = line.quotation_line_service_additional_name;
                        return `<li>${new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US')}: ${getSmartName(baseName, additionalName)}</li>`;
                    }).join('')}</ul>`;
                 } else {
                    html += `<p>[${lang === 'es' ? 'Lista de actividades...' : 'List of activities...'}]</p>`;
                 }
                 return html;
            };

            const pricingHTML = () => {
                let content = '';
                // AJUSTE 3: Modificar la lógica aquí
                const shouldShowPriceColumn = data.showPrices;
                const shouldShowTotalsBlock = data.showPrices || !data.showPrices; // Siempre mostrar totales en extendida

                if (showTable) {
                    // Llamar a una versión modificada o pasarle un flag
                    content = generateQuoteHTML({ ...data, showPrices: shouldShowPriceColumn }, true);
                }
                
                if (shouldShowTotalsBlock && !showTable) {
                    content += `<p>${formatCurrency(totalFinal)} ${data.showAgentCommission ? `(${lang === 'es' ? 'Este monto incluye' : 'This amount includes'} ${formatCurrency(agentCommissionTotal)} ${lang === 'es' ? 'para su comisión' : 'for your commission'})` : ''}</p>
                             <p>${t.taxIncluded}</p>`;
                } else if (!shouldShowTotalsBlock) {
                    content = ''; // No mostrar nada de precios si se oculta todo
                }

                return `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.pricing}</h3>${content}`;
            };


            const ecosystemsHTML = () => {
                let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.ecosystems}</h3>`;
                if (selectedEcosystems.length > 0) {
                    html += selectedEcosystems.map(ecoKey => {
                        if (ecosystems[ecoKey] && ecosystems[ecoKey][lang]) {
                            return `<p><strong>${ecoKey}:</strong> ${ecosystems[ecoKey][lang]}</p>`;
                        }
                        return '';
                    }).join('<br>');
                } else {
                    html += `<p>[${lang === 'es' ? 'Selecciona ecosistemas para ver descripciones...' : 'Select ecosystems to see descriptions...'}]</p>`;
                }
                return html;
            };

            const domesticFlightsHTML = () => {
                const flightLines = services.filter(line => line.quotation_line_service_type === 'ANL');
                let html = `<h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.domesticFlights}</h3>`;
                if(flightLines.length > 0) {
                     html += `<ul style="list-style-type: none; padding-left: 0;">${flightLines.map(line => {
                        const date = new Date(line.quotation_line_start_date).toLocaleDateString(lang === 'es' ? 'es-CR' : 'en-US');
                        const baseName = lang === 'en' ? (line.quotation_line_service_name_english || line.quotation_line_service_name) : (line.quotation_line_service_information_display_name || line.quotation_line_service_name);
                        const additionalName = line.quotation_line_service_additional_name;
                        return `<li>${date}: ${getSmartName(baseName, additionalName)}</li>`;
                     }).join('')}</ul>`;
                } else {
                     html += `<p>[${lang === 'es' ? 'No hay vuelos domésticos incluidos...' : 'No domestic flights included...'}]</p>`;
                }
                return html;
            };
            
            // --- Main Template Assembly ---
            return `
                <div style="font-family: 'Aptos', Arial, sans-serif; color: #000; background: white;">
                    ${getEditorToolbarHTML()}
                    <div contenteditable="true" style="padding: 2rem;">
                        ${introductionHTML()}
                        ${proposalTitleHTML()}
                        ${itineraryInBriefHTML()}
                        <h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.visualPresentation}</h3>
                        <p><a href="[LINK]" target="_blank" style="color: blue; text-decoration: underline;">${t.safariPortalLink}</a></p>
                        ${ecosystemsHTML()}
                        ${tripDetailsHTML()}
                        ${lodgingHTML()}
                        ${airportServicesHTML()}
                        ${domesticFlightsHTML()}
                        <h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.landTransfers}</h3>
                        <p>[${lang === 'es' ? 'Detalles sobre los traslados...' : 'Details about transfers...'}]</p>
                        ${drivingTimesHTML()}
                        ${activitiesHTML()}
                        ${pricingHTML()}
                        <h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.includes}</h3>
                        <p>[...]</p>
                        <h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.excludes}</h3>
                        <p>[...]</p>
                        <h3 style="font-size: 1.2em; font-weight: bold; color: ${tealColor}; margin-top: 20px;">${t.additionalInfo}</h3>
                        <p>[...]</p>
                        <p style="margin-top: 1.5em;">${t.customizationNote}</p>
                        <p style="margin-top: 1.5em;">${t.regards}</p>
                    </div>
                </div>`;
        }

        function generateQuoteHTML(data, isEmbedded = false) {
            const isConfirmation = data.docType === 'confirmacion';
            const title = isConfirmation ? data.t.confirmationTitle : data.t.quoteTitle;
            const agentCommissionLabel = getAgentCommissionLabel(data);
            const tealColor = '#194846';
            const lightColor = '#ede1cf';

            const shouldShowPriceColumn = data.showPrices;
            const shouldShowTotalsBlock = true;

            let totalsBlockStyle = 'margin-top: 20px; float: right; width: 100%; max-width: 350px;';
            if (data.visibility === 'resumen_tipo') {
                totalsBlockStyle = 'margin: 20px auto 0 auto; width: 100%; max-width: 600px;';
            }

            const headerContent = !isEmbedded ? `
                <img id="logo-image" src="imagenes/Logo.png" alt="Terranova Origen Logo" style="width: 250px; margin-bottom: 30px;">
                <table style="width: 100%; margin-bottom: 30px; font-size: 0.9em;">
                    <tr>
                        <td style="vertical-align: middle;">
                            <p><strong>${data.t.passenger}:</strong> ${data.mainInfo.quotation_main_passenger_name}</p>
                            <p><strong>${data.t.quoteName}:</strong> ${data.mainInfo.quotation_name}</p>
                        </td>
                        <td style="vertical-align: middle; text-align: right;">
                            <h2 style="font-size: 1.5em; color: ${tealColor}; margin: 0;">${title.toUpperCase()}</h2>
                            <p><strong>${data.t.quoteId}:</strong> ${appState.quoteForShipment.idCotizacion.replace('COT-API-', '')}</p>
                            <p><strong>${data.t.tripDates}:</strong> ${new Date(data.mainInfo.quotation_start_date).toLocaleDateString(data.lang === 'es' ? 'es-CR' : 'en-US')} - ${new Date(data.mainInfo.quotation_end_date).toLocaleDateString(data.lang === 'es' ? 'es-CR' : 'en-US')}</p>
                        </td>
                    </tr>
                </table>
            ` : '';
            
            // AJUSTE v5.6: Se centra el texto de los encabezados de tabla.
            const thStyle = `padding: 8px; border: 1px solid #ddd; text-align: center; vertical-align: middle; background-color: ${tealColor}; color: ${lightColor};`;
            
            let tableContent = '';
            if (data.showTable) {
                if (data.visibility === 'resumen_tipo') {
                    tableContent = generateSummaryTableHTML(data);
                } else {
                    tableContent = `<table style="width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th style="${thStyle}">${data.t.day}</th>
                                <th style="${thStyle}">${data.t.dates}</th>
                                ${isConfirmation ? `<th style="${thStyle}">${data.t.hours}</th>` : ''}
                                <th style="${thStyle}">${data.t.service}</th>
                                ${data.showNote ? `<th style="${thStyle}">${data.t.note}</th>` : ''}
                                ${shouldShowPriceColumn ? `<th style="${thStyle}">${data.t.price}</th>` : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.tableRows.map(row => {
                                let serviceCellHTML = row.service;
                                const confirmationNumber = row.originalLine?.quotation_line_service_confirmation_number;

                                if (isConfirmation && confirmationNumber && confirmationNumber.trim() !== '') {
                                    const confLabel = data.t.confirmationNumber || (data.lang === 'es' ? '#cof.' : '#conf.');
                                    serviceCellHTML += `<br><small style="font-size: 0.8em; color: ${tealColor}; font-weight: 500;">${confLabel} ${confirmationNumber}</small>`;
                                }
                                
                                return `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle; text-align: center;">${row.day}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle; text-align: center;">${row.dates}</td>
                                        ${isConfirmation ? `<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">${row.hours}</td>` : ''}
                                        <td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">${serviceCellHTML}</td>
                                        ${data.showNote ? `<td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">${row.note}</td>` : ''}
                                        ${shouldShowPriceColumn ? `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; vertical-align: middle;">${formatCurrency(row.price)}</td>` : ''}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>`;
                }
            }
            
            const content = `
                ${headerContent}
                ${tableContent}
                ${shouldShowTotalsBlock ? `<div style="${totalsBlockStyle}">
                    <table style="width: 100%; font-size: 0.9em;">
                        ${!data.taxBreakdown ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.subtotal}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.subtotal)}</td></tr>` : ''}
                        ${data.showAgentCommission && data.agentCommissionTotal > 0 ? `<tr><td style="padding: 5px; vertical-align: middle;">${agentCommissionLabel}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.agentCommissionTotal)}</td></tr>` : ''}
                        ${!data.taxBreakdown ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.taxes}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.impuestos)}</td></tr>` : ''}
                        ${(data.comisionTarjeta > 0) ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.ccFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTarjeta)}</td></tr>` : ''}
                        ${(data.comisionTransferencia > 0) ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.transferFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTransferencia)}</td></tr>` : ''}
                        <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333; margin-top: 10px;">
                            <td style="padding: 10px 5px; vertical-align: middle;">${data.t.total}</td>
                            <td style="padding: 10px 5px; text-align: right; color: ${tealColor}; vertical-align: middle;">${formatCurrency(data.totalFinal)}</td>
                        </tr>
                    </table>
                </div><div style="clear: both;"></div>` : ''}`;
            
            if (isEmbedded) return `<div id="embedded-pricing-content">${content}</div>`;

            return `<div style="font-family: 'Aptos', Arial, sans-serif; color: #000; background: white;">
                    ${getEditorToolbarHTML()}
                    <div contenteditable="true" style="padding: 2rem;">${content}</div>
                </div>`;
        }

        function generateSummaryTableHTML(data) {
            const tealColor = '#194846';
            const lightColor = '#ede1cf';
            const thStyle = `padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: middle; background-color: ${tealColor}; color: ${lightColor};`;

            return `
                 <h2 style="font-size: 1.3em; font-weight: bold; color: ${tealColor}; margin-top: 20px; text-align: center;">${data.t.summaryTableTitle}</h2>
                 <table style="width: 100%; max-width: 600px; margin: 20px auto; border-collapse: collapse; font-size: 1em;">
                     <thead>
                         <tr>
                             <th style="${thStyle}">${data.t.serviceType}</th>
                             <th style="${thStyle.replace('text-align: left', 'text-align: right')}">${data.t.price}</th>
                         </tr>
                     </thead>
                     <tbody>
                         ${Object.keys(data.summaryData).map(key => `
                             <tr style="border-bottom: 1px solid #ddd;">
                                 <td style="padding: 10px; border: 1px solid #ddd;">${data.summaryData[key].label}</td>
                                 <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-family: var(--font-mono);">${formatCurrency(data.summaryData[key].total)}</td>
                             </tr>
                         `).join('')}
                     </tbody>
                 </table>
            `;
        }

        function generateProformaHTML(data) {
            const logo = 'imagenes/Logo.png';
            const agentCommissionLabel = getAgentCommissionLabel(data);
            const tealColor = '#194846';
            const lightColor = '#ede1cf';
            const thStyle = `padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: middle; background-color: ${tealColor}; color: ${lightColor};`;
            
            return `<div style="font-family: 'Aptos', Arial, sans-serif; color: #000; background: white;">
                 ${getEditorToolbarHTML()}
                <div contenteditable="true" style="padding: 2rem;">
                <img id="logo-image" src="${logo}" alt="Terranova Origen Logo" style="width: 250px; margin-bottom: 30px;">
                <table style="width: 100%; margin-bottom: 30px;"><tr>
                    <td style="vertical-align: middle;">
                        <p><strong>${data.t.to}</strong></p>
                        <p>${data.mainInfo.quotation_customer_name}</p>
                    </td>
                    <td style="vertical-align: middle; text-align: right;">
                        <h2 style="font-size: 1.5em; color: ${tealColor}; margin: 0;">${data.t.proformaTitle}</h2>
                        <p><strong>${data.t.proformaId}</strong> ${data.mainInfo.quotation_id}</p>
                        <p><strong>${data.t.proformaDate}:</strong> ${new Date().toLocaleDateString(data.lang === 'es' ? 'es-ES' : 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </td>
                </tr></table>
                ${data.showTable ? generateProformaServicesTableHTML(data) : ''}
                ${generateProformaTotalsHTML(data, agentCommissionLabel)}
                <div style="margin-top: 40px; font-size: 0.8em; border-top: 1px solid #ccc; padding-top: 15px; white-space: pre-wrap;">${data.lang === 'es' ? 
`Nombre Comercial:  Terranova\\Origen
Nombre Legal:  3-101-917556 Sociedad Anonima
Banco:  BAC San Jose
Código SWIFT:  BSNJCRSJ
IBAN/Número de cuenta:  CR77010200009660899309
Moneda:  US Dollars
ID de la compañía:  3-101-917556 
Nombre de la cuenta:  3-101-917556 Sociedad Anonima
Dirección de facturación:  Costa Rica, San José, Escazú, San Rafael, Country Plaza, Segundo Piso
Dirección del banco:  Calle 0 Avenidas 3 y 5, San José Costa Rica, CA
El impuesto de ventas de Costa Rica está incluido en el precio de la factura.
El pago del depósito debe realizarse dentro de los 4 días posteriores a la recepción de la factura.
El saldo restante deberá pagarse ${data.diasPago} días antes de la fecha de llegada de los huéspedes.` :
`Commercial Name:  Terranova\\Origen
Legal Name:  3-101-917556 Sociedad Anonima
Bank:  BAC San Jose
SWIFT Code:  BSNJCRSJ
IBAN/Account Number:  CR77010200009660899309
Currency:  US Dollars
Company ID:  3-101-917556 
Account Name:  3-101-917556 Sociedad Anonima
Billing Address:  Costa Rica, San José, Escazú, San Rafael, Country Plaza, Segundo Piso
Bank Address:  Calle 0 Avenidas 3 y 5, San José Costa Rica, CA
Costa Rican Sales Tax is included in the invoice pricing
Deposit payment is due within 4 days of invoice receipt
Remaining Balance will be due ${data.diasPago} days prior to guests arrival date`
                    }</div>
            </div></div>`;
        }
        
        function generateProformaServicesTableHTML(data) {
             const tealColor = '#194846';
             const lightColor = '#ede1cf';
             const thStyle = `padding: 8px; border: 1px solid #ddd; text-align: center; vertical-align: middle; background-color: ${tealColor}; color: ${lightColor};`;

             let table = `<table style="width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px;">
                <thead>
                    <tr>
                        <th style="${thStyle}">${toTitleCase(data.t.quantity)}</th>
                        <th style="${thStyle}">${toTitleCase(data.t.description)}</th>
                        ${data.showPrices ? `<th style="${thStyle}">${toTitleCase(data.t.unitPrice)}</th><th style="${thStyle}">${toTitleCase(data.t.lineTotal)}</th>` : ''}
                    </tr>
                </thead>
                <tbody>`;
            data.tableRows.forEach(row => {
                const quantity = row.quantity > 0 ? row.quantity : 1;
                const unitPrice = row.price / quantity;

                table += `<tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle; text-align: center;">${quantity}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">${row.service} ${data.showNote && row.note ? `<br><small>${row.note}</small>` : ''}</td>
                    ${data.showPrices ? `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; vertical-align: middle;">${formatCurrency(unitPrice)}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; vertical-align: middle;">${formatCurrency(row.price)}</td>` : ''}
                </tr>`;
            });
            table += `</tbody></table>`;
            return table;
        }
        
        function generateProformaTotalsHTML(data, agentCommissionLabel) {
            const depositAmount = data.totalFinal * data.depositPercent;
            
            let paymentDateHTML = '';
            if (data.docType === 'proforma' && data.mainInfo.quotation_start_date) {
                const startDate = new Date(data.mainInfo.quotation_start_date.replace(/-/g, '/'));
                if (!isNaN(startDate)) {
                    startDate.setDate(startDate.getDate() - data.diasPago);
                    const formattedDate = startDate.toLocaleDateString(data.lang === 'es' ? 'es-CR' : 'en-US', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    });
                    paymentDateHTML = `<p style="text-align: right; margin-top: 15px; font-size: 0.9em; font-style: italic;"><strong>${data.t.nextPaymentDate}:</strong> ${formattedDate}</p>`;
                }
            }

            return `<div style="margin-top: 20px; float: right; width: 100%; max-width: 350px;">
                <table style="width: 100%; font-size: 0.9em;">
                    <tr><td style="padding: 5px; vertical-align: middle;">${data.t.subtotal}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.subtotal)}</td></tr>
                    ${data.showAgentCommission && data.agentCommissionTotal > 0 ? `<tr><td style="padding: 5px; vertical-align: middle;">${agentCommissionLabel}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.agentCommissionTotal)}</td></tr>` : ''}
                    <tr><td style="padding: 5px; vertical-align: middle;">${data.t.taxes}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.impuestos)}</td></tr>
                     ${(data.comisionTarjeta > 0) ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.ccFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTarjeta)}</td></tr>` : ''}
                    ${data.comisionTransferencia > 0 ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.bankFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTransferencia)}</td></tr>` : ''}
                    <tr style="border-top: 1px solid #ccc;"><td style="padding: 5px; font-weight: bold; vertical-align: middle;">${data.t.total}</td><td style="padding: 5px; text-align: right; font-weight: bold; vertical-align: middle;">${formatCurrency(data.totalFinal)}</td></tr>
                    <tr><td style="padding: 5px; vertical-align: middle;">${data.t.deposit} ${data.depositPercent * 100}%</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(depositAmount)}</td></tr>
                    <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333; margin-top: 10px;">
                        <td style="padding: 10px 5px; vertical-align: middle;">${data.t.totalDue}</td>
                        <td style="padding: 10px 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.totalFinal - depositAmount)}</td>
                    </tr>
                </table>
                ${paymentDateHTML}
            </div><div style="clear: both;"></div>`;
        }

        function getAgentCommissionLabel(data) {
            const { parameters, t, agentCommissionTotal, originalSubtotalForCommissionCalc, nonCommissionableSubtotalForCommissionCalc, lang } = data;
            const { comisionAgente } = parameters;
            let labelDetails = '';

            const hasPorcentaje = comisionAgente.porcentaje > 0;
            const hasMonto = comisionAgente.montoAbsoluto > 0;

            if (comisionAgente.tipo === 'Sobre el todo') {
                if (hasPorcentaje && hasMonto) {
                    const andConjunction = lang === 'es' ? 'y' : 'and';
                    labelDetails = `${comisionAgente.porcentaje * 100}% ${andConjunction} ${formatCurrency(comisionAgente.montoAbsoluto)}`;
                } else if (hasPorcentaje) {
                    labelDetails = `${comisionAgente.porcentaje * 100}%`;
                } else if (hasMonto) {
                    labelDetails = formatCurrency(comisionAgente.montoAbsoluto);
                }
            } else if (comisionAgente.tipo === 'Linea por Linea') {
                const commissionableBase = originalSubtotalForCommissionCalc - nonCommissionableSubtotalForCommissionCalc;
                if (commissionableBase > 0 && agentCommissionTotal > 0) {
                    const avgPercentage = (agentCommissionTotal / commissionableBase) * 100;
                    labelDetails = `${avgPercentage.toFixed(2)}%`;
                } else {
                    labelDetails = lang === 'es' ? 'Por Línea' : 'Per Line';
                }
            }

            return labelDetails ? `${t.agentCommission} (${labelDetails})` : t.agentCommission;
        }

        async function exportToWord() {
            const previewContainer = document.getElementById('shipment-preview-container');
            const editableContent = previewContainer.querySelector('[contenteditable="true"]');
            
            const img = editableContent.querySelector('#logo-image');
            
            const imageToBlob = async (imgElement) => {
                if (!imgElement) return '';
                const response = await fetch(imgElement.src);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            };

            try {
                let imgDataUrl = "imagenes/Logo.png";
                if(img) {
                    imgDataUrl = await imageToBlob(img);
                    img.src = imgDataUrl;
                }
            
                const content = editableContent.innerHTML;
                const header = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: 'Times New Roman', Times, serif; color: #000; }
                            table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
                            th, td { padding: 8px; border: 1px solid #ddd; vertical-align: middle; }
                            thead th { background-color: #194846; color: #ede1cf; }
                        </style>
                    </head>
                    <body>
                `;
                const footer = '</body></html>';

                const blob = new Blob([header + content + footer], {
                    type: 'application/msword'
                });
                saveAs(blob, `${appState.quoteForShipment.nombreArchivo}.doc`);
            
            } catch (error) {
                console.error("Error converting image for Word export:", error);
                showNotification("Error al procesar la imagen para exportar a Word.", "error");
            } finally {
                if(img) img.src = "imagenes/Logo.png";
            }
        }

        async function sendEmail() {
            const data = getShipmentData();
            const editableContainer = document.getElementById('shipment-preview-container');
            
            const contentClone = editableContainer.cloneNode(true);
            
            const toolbar = contentClone.querySelector('#editor-toolbar');
            if (toolbar) toolbar.remove();
            
            const editableContent = contentClone.querySelector('[contenteditable="true"]');

            // --- INICIO: AJUSTE QUIRÚRGICO PARA COMPATIBILIDAD DE EMAIL v8.0 ---
            if ((data.docType === 'cotizacion' || data.docType === 'cotizacion-extendida') && data.visibility === 'resumen_tipo') {
                const summaryLayoutHTML = createEmailCompatibleSummaryLayout(data);

                if (data.docType === 'cotizacion') {
                    const contentDiv = editableContent.querySelector('div[style*="padding: 2rem"]');
                    if (contentDiv) {
                        const headerImg = contentDiv.querySelector('img');
                        const headerTable = contentDiv.querySelector('table[style*="margin-bottom: 30px"]');
                        const headerHTML = (headerImg ? headerImg.outerHTML : '') + (headerTable ? headerTable.outerHTML : '');
                        
                        // Envolver todo en una tabla contenedora de ancho fijo para el cliente de correo
                        contentDiv.innerHTML = `<table width="600" style="width: 600px;" border="0" cellpadding="0" cellspacing="0"><tr><td>${headerHTML.replace('width: 100%', 'width: 600px;')}${summaryLayoutHTML}</td></tr></table>`;
                    }
                } else { // cotizacion-extendida
                    const pricingSection = editableContent.querySelector('#embedded-pricing-content');
                    if (pricingSection) {
                         const fragment = document.createRange().createContextualFragment(summaryLayoutHTML);
                         pricingSection.parentNode.replaceChild(fragment, pricingSection);
                    }
                }
            }
             // --- FIN: AJUSTE QUIRÚRGICO ---

            const emailHTML = `
                <div style="margin: 0 auto; max-width: 800px; font-family: 'Aptos', Arial, sans-serif; color: #000;">
                    ${editableContent.innerHTML}
                </div>`;

            let subject = '';
            if (data.docType === 'cotizacion' || data.docType === 'cotizacion-extendida') {
                subject = `${data.t.emailSubject} - ${data.mainInfo.quotation_name}`;
            } else if (data.docType === 'confirmacion') {
                subject = `${data.t.emailSubjectConfirmation} - ${data.mainInfo.quotation_name}`;
            } else {
                subject = `${data.t.proformaTitle} #${data.mainInfo.quotation_id} - ${data.mainInfo.quotation_name}`;
            }

            const recipient = data.mainInfo.quotation_main_passenger_email1 || '';
            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}`;

            try {
                const type = "text/html";
                const blob = new Blob([emailHTML], { type });
                const dataClipboard = [new ClipboardItem({ [type]: blob })];
                await navigator.clipboard.write(dataClipboard);
                showNotification('¡Contenido copiado! Péguelo en la ventana de correo que se abrió (Ctrl+V).', 'success');
                window.location.href = mailtoLink;
            } catch (error) {
                console.error("Clipboard API failed, opening mailto link directly:", error);
                showNotification('Copia al portapapeles no soportada, abriendo correo.', 'info');
                window.open(mailtoLink, '_blank');
            }
        }

        function createEmailCompatibleSummaryLayout(data) {
            const totalsBlockHTML = generateTotalsBlockForEmail(data);
            const summaryTableHTML = generateSummaryTableHTML(data);
            
            // Contenedor que asegura que todo el bloque de resumen (tabla + totales) se trate como una unidad
            // y fluya correctamente con el contenido anterior y posterior. Se añade un div wrapper para evitar problemas de float.
            return `
                <div style="clear: both;">
                    ${summaryTableHTML.replace('margin: 20px auto', 'margin: 20px 0 0 0').replace('text-align: center', 'text-align: left')}
                    ${totalsBlockHTML}
                </div>
            `;
        }
        
        function generateTotalsBlockForEmail(data) {
            const agentCommissionLabel = getAgentCommissionLabel(data);
            const tealColor = '#194846';
            
            // La tabla de totales se alinea a la derecha DENTRO de su celda contenedora.
            return `
                <div style="margin-top: 20px; width: 100%; max-width: 600px;">
                    <table style="width: 100%; max-width: 350px; margin-left: auto; margin-right: 0; font-size: 0.9em;">
                        ${!data.taxBreakdown ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.subtotal}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.subtotal)}</td></tr>` : ''}
                        ${data.showAgentCommission && data.agentCommissionTotal > 0 ? `<tr><td style="padding: 5px; vertical-align: middle;">${agentCommissionLabel}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.agentCommissionTotal)}</td></tr>` : ''}
                        ${!data.taxBreakdown ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.taxes}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.impuestos)}</td></tr>` : ''}
                        ${(data.comisionTarjeta > 0) ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.ccFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTarjeta)}</td></tr>` : ''}
                        ${(data.comisionTransferencia > 0) ? `<tr><td style="padding: 5px; vertical-align: middle;">${data.t.transferFee}</td><td style="padding: 5px; text-align: right; vertical-align: middle;">${formatCurrency(data.comisionTransferencia)}</td></tr>` : ''}
                        <tr style="font-weight: bold; font-size: 1.2em; border-top: 2px solid #333; margin-top: 10px;">
                            <td style="padding: 10px 5px; vertical-align: middle;">${data.t.total}</td>
                            <td style="padding: 10px 5px; text-align: right; color: ${tealColor}; vertical-align: middle;">${formatCurrency(data.totalFinal)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generatePDF() { 
            const sourceContainer = document.getElementById('shipment-preview-container');
            if(!sourceContainer) return;
            
            const source = sourceContainer.querySelector('[contenteditable="true"]');
            
            if (window.html2canvas && source) {
                const toolbar = sourceContainer.querySelector('#editor-toolbar');
                toolbar.style.display = 'none';
                sourceContainer.style.border = 'none'; // Eliminar borde para la captura

                html2canvas(source.parentNode, { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff' // Fondo blanco explícito
                }).then(canvas => {
                    toolbar.style.display = 'flex';
                    sourceContainer.style.border = ''; // Restaurar borde

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    
                    const pdf = new jsPDF({
                        orientation: 'p',
                        unit: 'px',
                        format: 'a4'
                    });

                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    let heightLeft = pdfHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                    
                    while (heightLeft > 0) {
                      position = heightLeft - pdfHeight;
                      pdf.addPage();
                      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                      heightLeft -= pdf.internal.pageSize.getHeight();
                    }
                    pdf.save(`${appState.quoteForShipment.nombreArchivo}.pdf`);
                });
            } else {
                showNotification("La librería html2canvas no está cargada.", "error");
            }
        }
        
        function printShipment() {
            const previewContainer = document.getElementById('shipment-preview-container');
            if (!previewContainer) return;
            
            const contentToPrint = previewContainer.querySelector('[contenteditable="true"]');
            if (!contentToPrint) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Imprimir Cotización</title>');
            printWindow.document.write(`
                <style>
                    body { font-family: 'Aptos', Arial, sans-serif; color: #000; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
                    
                    /* AJUSTE: Eliminar bordes solo para las celdas de la tabla del encabezado */
                    table[style*="margin-bottom: 30px"] td { border: none !important; }

                    /* AJUSTE FINAL: Eliminar bordes para las celdas de la tabla de totales */
                    .totals-block table td { border: none !important; }
                    .totals-block table tr[style*="border-top"] td { border-top: 2px solid #333 !important; }


                    th, td { padding: 8px; border: 1px solid #ddd; vertical-align: middle; }
                    thead th { 
                        background-color: #194846 !important; 
                        color: #ede1cf !important; 
                        -webkit-print-color-adjust: exact; 
                        print-color-adjust: exact;
                    }
                    img { max-width: 250px; margin-bottom: 30px; }
                    h2 { font-size: 1.5em; color: #194846; }
                    #editor-toolbar { display: none; }
                    /* Ensure totals block aligns right */
                    .totals-block { float: right; width: 100%; max-width: 350px; }
                    .clear-float { clear: both; }
                </style>
            `);
            printWindow.document.write('</head><body>');
            
            // Clone content and add specific classes for printing if necessary
            const clonedContent = contentToPrint.cloneNode(true);
            const totalsDiv = clonedContent.querySelector('div[style*="float: right"]');
            if (totalsDiv) {
                totalsDiv.classList.add('totals-block');
                const clearer = document.createElement('div');
                clearer.classList.add('clear-float');
                totalsDiv.parentNode.insertBefore(clearer, totalsDiv.nextSibling);
            }

            printWindow.document.write(clonedContent.innerHTML);
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function exportToExcel() {
            const data = getShipmentData();
            const wb = XLSX.utils.book_new();
            let ws_data = [];

            // ESTILOS
            const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "194846" } }, alignment: { vertical: "center", horizontal: "center" } };
            const titleStyle = { font: { bold: true, size: 14 } };
            const currencyStyle = { numFmt: "$#,##0.00" };
            const centerAlign = { alignment: { vertical: "center", horizontal: "center" } };
            
            // 1. Añadir Cabecera
            let title, info;
            if(data.docType === 'cotizacion' || data.docType === 'confirmacion' || data.docType === 'cotizacion-extendida') {
                title = data.docType.includes('cotizacion') ? data.t.quoteTitle : data.t.confirmationTitle;
                info = [
                    [`${data.t.passenger}:`, data.mainInfo.quotation_main_passenger_name],
                    [`${data.t.quoteName}:`, data.mainInfo.quotation_name],
                    [`${data.t.tripDates}:`, `${new Date(data.mainInfo.quotation_start_date).toLocaleDateString('es-CR')} - ${new Date(data.mainInfo.quotation_end_date).toLocaleDateString('es-CR')}`],
                    [`${data.t.quoteId}:`, appState.quoteForShipment.idCotizacion.replace('COT-API-', '')]
                ];
            } else {
                title = data.t.proformaTitle;
                info = [
                    [`${data.t.to}`, data.mainInfo.quotation_customer_name],
                    [`${data.t.proformaId}`, data.mainInfo.quotation_id],
                    [`${data.t.proformaDate}`, new Date().toLocaleDateString(data.lang === 'es' ? 'es-CR' : 'en-US')]
                ];
            }
            ws_data.push([title]);
            ws_data.push([]); 
            info.forEach(row => ws_data.push(row));
            ws_data.push([]);

            // 2. Añadir Tabla de Servicios
            if (data.showTable) {
                let head = [];
                 if(data.docType === 'cotizacion' || data.docType === 'confirmacion' || data.docType === 'cotizacion-extendida') {
                    head = [data.t.day, data.t.dates, data.t.service];
                    if (data.docType === 'confirmacion') head.push(data.t.hours);
                    if (data.showNote) head.push(data.t.note);
                    if (data.showPrices) head.push(data.t.price);
                } else {
                    head = [data.t.quantity, data.t.description];
                    if (data.showPrices) { head.push(data.t.unitPrice); head.push(data.t.lineTotal); }
                }
                ws_data.push(head);

                data.tableRows.forEach(row => {
                    let rowData = [];
                    if(data.docType === 'cotizacion' || data.docType === 'confirmacion' || data.docType === 'cotizacion-extendida') {
                        rowData = [row.day, row.dates, row.service];
                        if (data.docType === 'confirmacion') rowData.push(row.hours.replace(/<br>/g, '\n'));
                        if (data.showNote) rowData.push(row.note);
                        if (data.showPrices) rowData.push({v: row.price, t: 'n'});
                    } else {
                        let desc = row.service;
                        if(data.showNote && row.note) desc += `\n${row.note}`;
                        rowData = [row.quantity, desc];
                        if (data.showPrices) {
                            rowData.push({v: row.price / row.quantity, t: 'n'});
                            rowData.push({v: row.price, t: 'n'});
                        }
                    }
                    ws_data.push(rowData);
                });
                ws_data.push([]);
            }

            // 3. Añadir Totales
            const totalsStartIndex = ws_data.length;
            if((data.docType === 'cotizacion' || data.docType === 'cotizacion-extendida' || data.docType === 'confirmacion') && data.showPrices) {
                if(!data.taxBreakdown) ws_data.push([data.t.subtotal, {v: data.subtotal, t:'n'}]);
                if(data.showAgentCommission && data.agentCommissionTotal > 0) ws_data.push([getAgentCommissionLabel(data), {v: data.agentCommissionTotal, t:'n'}]);
                if(!data.taxBreakdown) ws_data.push([data.t.taxes, {v: data.impuestos, t:'n'}]);
                if(data.comisionTarjeta > 0) ws_data.push([data.t.ccFee, {v: data.comisionTarjeta, t:'n'}]);
                if(data.comisionTransferencia > 0) ws_data.push([data.t.transferFee, {v: data.comisionTransferencia, t:'n'}]);
                ws_data.push([data.t.total, {v: data.totalFinal, t:'n'}]);
             } else if (data.docType === 'proforma') {
                ws_data.push([data.t.subtotal, {v: data.subtotal, t:'n'}]);
                if(data.showAgentCommission && data.agentCommissionTotal > 0) ws_data.push([getAgentCommissionLabel(data), {v: data.agentCommissionTotal, t:'n'}]);
                ws_data.push([data.t.taxes, {v: data.impuestos, t:'n'}]);
                if(data.comisionTarjeta > 0) ws_data.push([data.t.ccFee, {v: data.comisionTarjeta, t:'n'}]);
                if(data.comisionTransferencia > 0) ws_data.push([data.t.bankFee, {v: data.comisionTransferencia, t:'n'}]);
                ws_data.push([data.t.total, {v: data.totalFinal, t:'n'}]);
                const depositAmount = data.totalFinal * data.depositPercent;
                ws_data.push([`${data.t.deposit} ${data.depositPercent * 100}%`, {v: depositAmount, t:'n'}]);
                ws_data.push([data.t.totalDue, {v: data.totalFinal - depositAmount, t:'n'}]);
             }
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Aplicar Estilos
            XLSX.utils.sheet_add_aoa(ws, [[{v: title, s: titleStyle}]], {origin: "A1"});
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];

            if (data.showTable) {
                const headerRowIndex = info.length + 2;
                Object.keys(ws).forEach(cell => {
                    const { r, c } = XLSX.utils.decode_cell(cell);
                    if (r === headerRowIndex) {
                        ws[cell].s = headerStyle;
                    }
                });
            }
            
            // Estilos a totales
            for (let i = totalsStartIndex; i < ws_data.length; i++) {
                if(ws[`B${i + 1}`]) {
                    ws[`B${i + 1}`].s = currencyStyle;
                }
            }

            const colWidths = [ {wch: 25}, {wch: 50}, {wch: 15}, {wch: 15}, {wch: 30}, {wch: 30}, {wch: 15} ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "Documento");
            XLSX.writeFile(wb, `${appState.quoteForShipment.nombreArchivo}.xlsx`);
        }

        function setupEditorToolbar() {
            const wrapper = document.getElementById('envios-content-wrapper');

            wrapper.addEventListener('click', (e) => {
                const btn = e.target.closest('.toolbar-btn');
                if (btn) {
                    e.preventDefault();
                    const command = btn.dataset.command;
                    const customCommand = btn.dataset.customCommand;
                    
                    if (command) {
                        document.execCommand(command, false, null);
                    } else if (customCommand) {
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            let node = selection.getRangeAt(0).startContainer;
                            let tdNode = null;
                            while(node && node.parentNode) {
                                if (node.tagName === 'TD' || node.tagName === 'TH') {
                                    tdNode = node;
                                    break;
                                }
                                node = node.parentNode;
                            }
                            if (tdNode) {
                                switch(customCommand) {
                                    case 'alignTop': tdNode.style.verticalAlign = 'top'; break;
                                    case 'alignMiddle': tdNode.style.verticalAlign = 'middle'; break;
                                    case 'alignBottom': tdNode.style.verticalAlign = 'bottom'; break;
                                }
                            }
                        }
                    }
                }
            });

            wrapper.addEventListener('change', (e) => {
                const select = e.target.closest('.toolbar-select');
                if (select) {
                    const command = select.dataset.command;
                    if(command) {
                        document.execCommand(command, false, select.value);
                    }
                }
            });
        }
        
        main();
    });
    </script>
</body>
</html>




