<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Exámenes - Control de Estudios</title>
    
    <!-- Dependencias y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Estilos CSS -->
    <style>
        :root {
            --color-primary: #1e3a8a; --color-secondary: #0d9488; --color-accent: #14b8a6;
            --color-background: #f8fafc; --color-card: #ffffff; --color-text-primary: #1e293b;
            --color-text-secondary: #64748b; --color-border: #e2e8f0;
        }
        html, body { height: 100%; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text-primary); }
        .login-background { background: linear-gradient(135deg, var(--color-primary) 0%, #2b4f9a 100%); }
        .btn-primary { background: linear-gradient(to right, var(--color-secondary), var(--color-accent)); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        .nav-btn.active { border-bottom-color: var(--color-accent); }
        .input-field:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1); }
        .input-field:disabled { background-color: #e2e8f0; cursor: not-allowed; }
        .study-type-btn.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .total-amount { font-size: clamp(1.5rem, 5vw, 2.25rem); }
        .readonly-field { background-color: #e2e8f0; cursor: not-allowed; }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="login-screen" class="flex items-center justify-center h-full login-background p-4">
        <div class="w-full max-w-md p-10 space-y-8 bg-white rounded-2xl shadow-2xl">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold" style="color:var(--color-primary)">Control<span style="color:var(--color-secondary)">Estudios</span></h1>
                <p class="text-color-text-secondary mt-2">Plataforma de Gestión de Exámenes</p>
            </div>
            <form id="login-form" class="space-y-6">
                <input id="username" name="username" type="text" required class="input-field w-full" placeholder="Usuario">
                <input id="password" name="password" type="password" required class="input-field w-full" placeholder="Contraseña">
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                <button type="submit" class="w-full btn-primary py-3 rounded-lg text-lg">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="app-screen" class="hidden h-full flex flex-col">
        <nav class="w-full flex-shrink-0 z-10 shadow-lg" style="background-color: var(--color-primary);">
            <div class="mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <h1 class="text-3xl font-extrabold text-white">Control<span style="color: var(--color-accent);">Estudios</span></h1>
                    <div class="hidden sm:flex items-center gap-2">
                        <button id="nav-registrar" class="nav-btn active flex items-center text-base px-4 rounded-md"><span class="material-symbols-outlined">edit_document</span><span class="hidden lg:inline ml-2">Registrar</span></button>
                        <button id="nav-consultar" class="nav-btn flex items-center text-base px-4 rounded-md"><span class="material-symbols-outlined">manage_search</span><span class="hidden lg:inline ml-2">Consultar</span></button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <span id="user-display" class="text-base font-semibold text-white"></span>
                            <p id="role-display" class="text-xs text-gray-300 font-medium"></p>
                        </div>
                        <button id="logout-button" class="text-gray-300 hover:text-white" title="Cerrar Sesión"><span class="material-symbols-outlined text-3xl">logout</span></button>
                    </div>
                </div>
            </div>
        </nav>
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div id="registrar-view">
                <form id="cita-form" class="bg-card p-8 rounded-2xl shadow-xl border w-full">
                    <input type="hidden" id="cita-id">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="space-y-6">
                            <h3 class="text-lg font-bold border-b pb-2">Paciente</h3>
                            <input id="nombre" type="text" placeholder="Nombre Paciente" class="input-field w-full" required>
                            <input id="identificacion" type="text" placeholder="Cédula" class="input-field w-full" required>
                            <div id="especialidad" class="grid grid-cols-3 gap-2">
                                <button type="button" data-study-type="RX" class="study-type-btn p-3 rounded-lg active">RX</button>
                                <button type="button" data-study-type="DMO" class="study-type-btn p-3 rounded-lg">DMO</button>
                                <button type="button" data-study-type="MMG" class="study-type-btn p-3 rounded-lg">MMG</button>
                            </div>
                            <select id="tipo-estudio" class="input-field w-full" required></select>
                        </div>
                        <div class="space-y-6">
                             <h3 class="text-lg font-bold border-b pb-2">Detalles</h3>
                             <select id="medico-refiere" class="input-field w-full" required></select>
                             <select id="medico-reporta" class="input-field w-full" required></select>
                             <select id="metodo-pago" class="input-field w-full" required></select>
                             <select id="descuento" class="input-field w-full"></select>
                        </div>
                        <div class="space-y-6">
                            <h3 class="text-lg font-bold border-b pb-2">Pago</h3>
                            <div class="bg-slate-100 p-4 rounded-xl border-2 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <input id="resumen-base" type="text" class="input-field readonly-field text-center" readonly placeholder="$0.00">
                                    <input id="tipo-cambio" type="number" value="520" class="input-field text-center">
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-center pt-2">
                                    <div>
                                        <label class="text-sm font-semibold text-color-text-secondary">Total USD</label>
                                        <p id="resumen-total-usd" class="total-amount font-bold" style="color:var(--color-primary)">$0.00</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold text-color-text-secondary">Total CRC</label>
                                        <p id="resumen-total-crc" class="total-amount font-bold" style="color:var(--color-secondary)">₡0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-6 mt-6 border-t">
                        <div class="flex items-center gap-4">
                            <input type="date" id="fecha-estudio" class="input-field">
                            <div class="flex items-center">
                                <input id="enviado" type="checkbox" class="h-5 w-5 rounded">
                                <label for="enviado" class="ml-2">Enviado</label>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button type="button" id="clear-form-btn" class="bg-gray-200 hover:bg-gray-300 py-3 px-8 rounded-lg">Limpiar</button>
                            <button type="submit" class="btn-primary py-3 px-8 rounded-lg">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="consultar-view" class="hidden">
                 <div class="bg-white p-6 rounded-2xl shadow-lg border">
                    <input type="text" id="search-input" class="input-field w-full md:w-1/3 mb-6" placeholder="Buscar...">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-3 text-left text-sm font-semibold">Paciente</th>
                                    <th class="py-3 px-3 text-left text-sm font-semibold">Fecha</th>
                                    <th class="py-3 px-3 text-left text-sm font-semibold">Servicio</th>
                                    <th class="py-3 px-3 text-left text-sm font-semibold">Monto</th>
                                    <th class="py-3 px-3 text-center text-sm font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="citas-table-body" class="divide-y"></tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y REFERENCIAS GLOBALES ---
        const appState = { currentUser: null, data: {}, isEditing: false, isViewing: false };
        let appEventListenersAttached = false;

        const el = (id) => document.getElementById(id);
        const loginScreen = el('login-screen'), appScreen = el('app-screen'), loginForm = el('login-form'),
              loginError = el('login-error'), logoutButton = el('logout-button'), userDisplay = el('user-display'),
              roleDisplay = el('role-display'), citaForm = el('cita-form'), citasTableBody = el('citas-table-body'),
              searchInput = el('search-input'), clearFormBtn = el('clear-form-btn');
        const nav = { registrar: el('nav-registrar'), consultar: el('nav-consultar') };
        const views = { registrar: el('registrar-view'), consultar: el('consultar-view') };
        const formFields = {
            id: el('cita-id'), nombre: el('nombre'), identificacion: el('identificacion'),
            especialidadContainer: el('especialidad'), tipoEstudio: el('tipo-estudio'),
            medicoRefiere: el('medico-refiere'), medicoReporta: el('medico-reporta'),
            descuento: el('descuento'), metodoPago: el('metodo-pago'), tipoCambio: el('tipo-cambio'),
            enviado: el('enviado'), fechaEstudio: el('fecha-estudio')
        };
        const resumenFields = { base: el('resumen-base'), totalUsd: el('resumen-total-usd'), totalCrc: el('resumen-total-crc') };

        // --- FUNCIONES UTILITARIAS ---
        const parsePercent = str => parseFloat(String(str).replace('%', '')) / 100 || 0;
        const parseCurrency = str => parseFloat(String(str).replace(/[$,₡]/g, '').replace(',', '.')) || 0;
        const formatNumberForSheet = num => String(num.toFixed(2)).replace('.', ',');
        const formatUSD = num => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        const formatCRC = num => new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(num);

        // --- LÓGICA DE API ---
        async function apiCall(endpoint, options = {}) {
            const btn = citaForm.querySelector('button[type="submit"]');
            btn.disabled = true;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            try {
                const response = await fetch(endpoint, { ...options, signal: controller.signal });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${errorText}`);
                }
                return response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                alert(`Error de comunicación con el servidor: ${error.message}`);
                throw error;
            } finally {
                clearTimeout(timeoutId);
                if (!appState.isViewing) btn.disabled = false;
            }
        }

        // --- LÓGICA DE INICIALIZACIÓN Y NAVEGACIÓN ---
        function initializeApp() {
            loginScreen.style.display = 'none';
            appScreen.style.display = 'flex';
            userDisplay.textContent = appState.currentUser.Usuario;
            roleDisplay.textContent = `Rol: ${appState.currentUser.Rol}`;
            if (!appEventListenersAttached) {
                setupAppEventListeners();
                appEventListenersAttached = true;
            }
            resetForm();
            showView('registrar');
        }

        const handleLogin = async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true;
            btn.textContent = 'Verificando...';
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            
            try {
                const data = await apiCall('/.netlify/functions/get-data');
                appState.data = data;
                let user;
                if (username === 'admin' && password === 'admin') {
                    user = { Usuario: 'Admin', Rol: 'Admin' };
                } else {
                    user = (appState.data.usuarios || []).find(u => u.Usuario === username && u.Contraseña === password);
                }
                
                if (user) {
                    appState.currentUser = user;
                    populateFormDropdowns();
                    renderCitasTable(appState.data.citas);
                    initializeApp();
                } else {
                    loginError.textContent = 'Usuario o contraseña incorrectos.';
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                 if (username === 'admin' && password === 'admin') {
                    appState.currentUser = { Usuario: 'Admin', Rol: 'Admin' };
                    alert('ADVERTENCIA: No se pudo conectar con Google Sheets. Modo offline.');
                    initializeApp();
                    return;
                }
                loginError.textContent = 'No se pudo conectar al servidor.';
                loginError.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ingresar';
            }
        };

        function handleLogout() {
            Object.assign(appState, { currentUser: null, data: {}, isEditing: false, isViewing: false });
            appScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            loginForm.reset();
        }

        function showView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            Object.keys(nav).forEach(k => nav[k].classList.toggle('active', k === viewName));
        }

        // --- LÓGICA DE UI Y FORMULARIO ---
        function populateFormDropdowns() {
            const populate = (select, data, textFn, valueFn) => {
                select.innerHTML = '<option value="">Seleccione...</option>';
                (data || []).forEach(item => {
                    const option = document.createElement('option');
                    option.textContent = textFn(item);
                    option.value = valueFn(item);
                    select.appendChild(option);
                });
            };
            populate(formFields.medicoRefiere, appState.data.medicos, m => m.Medico, m => m.Medico);
            populate(formFields.medicoReporta, appState.data.medicos, m => m.Medico, m => m.Medico);
            populate(formFields.descuento, appState.data.descuentos, d => d.Descuentos, d => parsePercent(d.Descuentos));
            populate(formFields.metodoPago, appState.data.metodosDePago, p => p.Tipo, p => p.Tipo);
        }

        function generateActionButtons(cita) {
            const role = appState.currentUser.Rol;
            const viewBtn = `<button data-id="${cita.ID}" class="view-btn text-green-600" title="Ver"><span class="material-symbols-outlined">visibility</span></button>`;
            const editBtn = `<button data-id="${cita.ID}" class="edit-btn text-blue-600" title="Editar"><span class="material-symbols-outlined">edit</span></button>`;
            const deleteBtn = `<button data-id="${cita.ID}" class="delete-btn text-red-600" title="Eliminar"><span class="material-symbols-outlined">delete</span></button>`;
            if (role === 'Admin') return viewBtn + editBtn + deleteBtn;
            if (role === 'Imagenes') return viewBtn + editBtn;
            if (role === 'Examenes') return viewBtn;
            return '';
        }

        function renderCitasTable(citas) {
            citasTableBody.innerHTML = '';
             (citas || []).forEach(cita => {
                const row = document.createElement('tr');
                const montoFinal = parseCurrency(cita['Monto total Descontado con IVA']);
                row.innerHTML = `
                    <td class="py-4 px-3">${cita.Nombre}</td>
                    <td class="py-4 px-3">${cita['Fecha de Estudio']}</td>
                    <td class="py-4 px-3">${cita['Tipo de Estudio']}</td>
                    <td class="py-4 px-3">${formatUSD(montoFinal)}</td>
                    <td class="py-4 px-3 text-center space-x-2">${generateActionButtons(cita)}</td>`;
                citasTableBody.appendChild(row);
            });
        }

        function setupAppEventListeners() {
            logoutButton.addEventListener('click', handleLogout);
            citaForm.addEventListener('submit', handleFormSubmit);
            clearFormBtn.addEventListener('click', resetForm);
            Object.values(nav).forEach(btn => btn.addEventListener('click', e => showView(e.currentTarget.id.includes('registrar') ? 'registrar' : 'consultar')));
            formFields.especialidadContainer.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                    formFields.especialidadContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    handleEspecialidadChange();
                }
            });
            [formFields.tipoEstudio, formFields.descuento, formFields.metodoPago, formFields.tipoCambio].forEach(input => input.addEventListener('change', calculateAll));
            citasTableBody.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;
                if (btn.classList.contains('view-btn')) handleViewClick(id);
                if (btn.classList.contains('edit-btn')) handleEditClick(id);
                if (btn.classList.contains('delete-btn')) handleDeleteClick(id);
            });
            searchInput.addEventListener('keyup', () => {
                const term = searchInput.value.toLowerCase();
                const filtered = (appState.data.citas || []).filter(c => Object.values(c).some(v => String(v).toLowerCase().includes(term)));
                renderCitasTable(filtered);
            });
        }

        function handleEspecialidadChange() {
            const activeBtn = formFields.especialidadContainer.querySelector('.active');
            const especialidad = activeBtn ? activeBtn.dataset.studyType : 'RX';
            const services = (appState.data.servicios || []).filter(s => s.Código === especialidad);
            const options = services.map(s => `<option value="${s['Producto o Servicio']}">${s['Producto o Servicio']}</option>`).join('');
            formFields.tipoEstudio.innerHTML = `<option value="">Seleccione Servicio...</option>${options}`;
            calculateAll();
        }

        function calculateAll() {
            const service = (appState.data.servicios || []).find(s => s['Producto o Servicio'] === formFields.tipoEstudio.value);
            const payMethod = (appState.data.metodosDePago || []).find(p => p.Tipo === formFields.metodoPago.value);
            const montoTotal = service ? parseCurrency(service.Precio) : 0;
            const descuento = parseFloat(formFields.descuento.value) || 0;
            const tipoCambio = parseFloat(formFields.tipoCambio.value) || 520;
            const montoDescontado = montoTotal * (1 - descuento);
            const ivaPercent = payMethod ? parsePercent(payMethod.IVA) : 0;
            const iva = montoDescontado * ivaPercent;
            const montoConIva = montoDescontado + iva;
            resumenFields.base.value = formatUSD(montoTotal);
            resumenFields.totalUsd.textContent = formatUSD(montoConIva);
            resumenFields.totalCrc.textContent = formatCRC(montoConIva * tipoCambio);
        }

        function setFormState(disabled) {
            Array.from(citaForm.elements).forEach(el => el.disabled = disabled);
            formFields.especialidadContainer.querySelectorAll('button').forEach(btn => btn.disabled = disabled);
            citaForm.querySelector('button[type="submit"]').style.display = disabled ? 'none' : 'flex';
        }

        function resetForm() {
            citaForm.reset();
            formFields.id.value = '';
            Object.assign(appState, { isEditing: false, isViewing: false });
            formFields.fechaEstudio.value = new Date().toISOString().split('T')[0];
            citaForm.querySelector('button[type="submit"]').textContent = 'Guardar';
            setFormState(false);
            handleEspecialidadChange();
        }
        
        function loadCitaIntoForm(citaId) {
            const cita = (appState.data.citas || []).find(c => c.ID === citaId);
            if (!cita) return;
            formFields.id.value = cita.ID;
            formFields.nombre.value = cita.Nombre;
            formFields.identificacion.value = cita.Identificación;
            const [day, month, year] = cita['Fecha de Estudio'].split('/');
            formFields.fechaEstudio.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            formFields.especialidadContainer.querySelector('.active').classList.remove('active');
            formFields.especialidadContainer.querySelector(`[data-study-type="${cita.Especialidad}"]`).classList.add('active');
            handleEspecialidadChange();
            setTimeout(() => { 
                formFields.tipoEstudio.value = cita['Tipo de Estudio'];
                formFields.medicoRefiere.value = cita['Medico que Refiere'];
                formFields.medicoReporta.value = cita['Medico que Reporta'];
                const discountOption = Array.from(formFields.descuento.options).find(opt => opt.text === cita.Descuento);
                if (discountOption) formFields.descuento.value = discountOption.value;
                formFields.metodoPago.value = cita['Método pago'];
                formFields.tipoCambio.value = parseCurrency(cita['Tipo de cambio']);
                formFields.enviado.checked = cita.Enviado === 'Si';
                calculateAll();
            }, 100);
        }

        function handleViewClick(id) {
            Object.assign(appState, { isViewing: true, isEditing: false });
            loadCitaIntoForm(id);
            setFormState(true);
            showView('registrar');
        }

        function handleEditClick(id) {
            Object.assign(appState, { isEditing: true, isViewing: false });
            loadCitaIntoForm(id);
            setFormState(false);
            citaForm.querySelector('button[type="submit"]').textContent = 'Actualizar';
            showView('registrar');
        }

        async function handleDeleteClick(id) {
            if (!confirm('¿Seguro que deseas eliminar este registro?')) return;
            const cita = (appState.data.citas || []).find(c => c.ID === id);
            try {
                await apiCall('/.netlify/functions/delete-cita', {
                    method: 'DELETE', body: JSON.stringify({ ID: id, tipoEstudio: cita.Especialidad })
                });
                appState.data.citas = appState.data.citas.filter(c => c.ID !== id);
                renderCitasTable(appState.data.citas);
                alert('Registro eliminado.');
            } catch (e) { /* Error is handled in apiCall */ }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (appState.isViewing) return;

            const service = (appState.data.servicios || []).find(s => s['Producto o Servicio'] === formFields.tipoEstudio.value);
            const payMethod = (appState.data.metodosDePago || []).find(p => p.Tipo === formFields.metodoPago.value);
            const medico = (appState.data.medicos || []).find(m => m.Medico === formFields.medicoReporta.value);
            
            // --- INICIO DE CÁLCULOS ---
            const montoTotal = service ? parseCurrency(service.Precio) : 0;
            const descuento = parseFloat(formFields.descuento.value) || 0;
            const tipoCambio = parseFloat(formFields.tipoCambio.value) || 520;
            const ivaPercent = payMethod ? parsePercent(payMethod.IVA) : 0;
            const feePercent = payMethod ? parsePercent(payMethod.Fees) : 0;
            const comisionPercent = medico ? parsePercent(medico.Comisión) : 0;
            const tasaIVAMedico = 0.04;

            const montoDescontado = montoTotal * (1 - descuento);
            const iva = montoDescontado * ivaPercent;
            const montoConIva = montoDescontado + iva;
            const fee = montoConIva * feePercent; // El fee se calcula sobre el monto con IVA
            const cobrarTotal = montoConIva; // El cliente no paga el fee, este se deduce de la ganancia
            
            let comision = 0;
            if (service && comisionPercent > 0) {
                if (service.Cobro === 'Normal') {
                    comision = (montoConIva - fee) * comisionPercent;
                } else {
                    const baseComision = parseCurrency(service['Base para comisión']);
                    const montoPagar = parseCurrency(service['Moto a pagar']);
                    const parte1 = ((baseComision * (1 - descuento)) * (1 + tasaIVAMedico)) - ((baseComision / montoTotal) * fee);
                    const parte2 = ((montoPagar * (1 - descuento)) * (1 + tasaIVAMedico)) - ((montoPagar / montoTotal) * fee);
                    comision = (parte1 * comisionPercent) + parte2;
                }
            }
            
            const debitoFiscal = iva;
            const creditoFiscal = (comision / (1 + tasaIVAMedico)) * tasaIVAMedico;
            const [year, month, day] = formFields.fechaEstudio.value.split('-');
            
            const citaData = {
                ID: formFields.id.value || Math.floor(100000 + Math.random() * 900000).toString(),
                Enviado: formFields.enviado.checked ? 'Si' : 'No',
                'Fecha de Estudio': `${day}/${month}/${year}`,
                Nombre: formFields.nombre.value,
                Identificación: formFields.identificacion.value,
                Especialidad: formFields.especialidadContainer.querySelector('.active').dataset.studyType,
                'Tipo de Estudio': formFields.tipoEstudio.value,
                'Medico que Refiere': formFields.medicoRefiere.value,
                'Medico que Reporta': formFields.medicoReporta.value,
                'Monto Total': formatNumberForSheet(montoTotal),
                'Descuento': `${(descuento * 100).toFixed(0)}%`,
                'Descuento aplicado por': appState.currentUser.Usuario,
                'Monto Total Descontado': formatNumberForSheet(montoDescontado),
                'Método pago': formFields.metodoPago.value,
                IVA: formatNumberForSheet(iva),
                Fee: formatNumberForSheet(fee),
                'Monto total Descontado con IVA': formatNumberForSheet(cobrarTotal),
                'Tipo de cambio': tipoCambio,
                'Cobrar ₡': formatNumberForSheet(cobrarTotal * tipoCambio),
                'Cobrar $': formatNumberForSheet(cobrarTotal),
                'Porcentaje de comisión': `${(comisionPercent * 100).toFixed(0)}%`,
                'Comisión en Dólares': formatNumberForSheet(comision),
                'Comisión en Colones': formatNumberForSheet(comision * tipoCambio),
                'Debito Fiscal': formatNumberForSheet(debitoFiscal),
                'Crédito Fiscal': formatNumberForSheet(creditoFiscal),
                'IVA Pagado a Hacienda': formatNumberForSheet(debitoFiscal - creditoFiscal)
            };
            
            const endpoint = appState.isEditing ? '/.netlify/functions/update-cita' : '/.netlify/functions/add-cita';
            const method = appState.isEditing ? 'PUT' : 'POST';
            
            try {
                await apiCall(endpoint, { method, body: JSON.stringify({ ...citaData, tipoEstudio: citaData.Especialidad }) });
                alert(`Registro ${appState.isEditing ? 'actualizado' : 'guardado'} con éxito.`);
                const newData = await apiCall('/.netlify/functions/get-data');
                appState.data = newData;
                renderCitasTable(appState.data.citas);
                resetForm();
            } catch (e) { /* Error is handled in apiCall */ }
        }
        
        loginForm.addEventListener('submit', handleLogin);
    });
    </script>
</body>
</html>

